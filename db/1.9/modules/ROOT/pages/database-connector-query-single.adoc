== Query a Single Record from a Database Example - Mule 4

The *Single Query* operation enables you to execute an SQL query that returns a single record (row) from a database and access the result payload without any additional transformations. This operation does not apply streaming for any of the returned fields of the record. When the query is executed, all the values of the returned row are read into memory and returned in the payload. You must be careful, because if your row is too large you could run out of memory.
Also, if you are using connection pooling you do not have to worry about your application running out of connections, because this operation returns the connection to the pool immediately after the query is executed.

You can invoke the *Single Query* operation mostly in the same way as you do with the *Select* operation, though you always get a single result regardless of the amount of records returned by the actual SQL query.

The following example shows how to configure Anypoint Connector for Database (Database Connector) *Single Query* operation in a Mule application that retrieves books information from a table in a MySQL database. +

To accomplish this example, you must: +

* Run an SQL statement that creates a table called `BOOK` and inserts 7 records of book information (title, author, bookshopName, isbn, price)
* Configure the SQL database connection
* Create the Mule application
* Run, and test the application with curl commands

The following screenshot shows the Anypoint Studio app flow for this example:

.Query a Single Record from a Database flow
image::database-query-single-flow.png[Query a Single Record from a Database flow]

== Create the Table in the Database

Before configuring the SQL database connection and creating the Mule application, run the following SQL statement to create a table called `BOOK` and inserts 7 records of books. An incremental `id` is associated to each new book added into the table. For example, the first book added into the table has an `id` equal to `1`, the second book will have an `id` equal to `2`, and so on.

[source,sql,linenums]
----
USE SYS;

CREATE TABLE BOOK(
    id MEDIUMINT NOT NULL AUTO_INCREMENT,
    title VARCHAR(100),
    author VARCHAR(100),
    bookshopName VARCHAR(100),
    isbn VARCHAR(13),
    price SMALLINT,
    PRIMARY KEY (id)
);

INSERT INTO BOOK(title, author, bookshopName, isbn, price) VALUES('Good Omens', 'Terry Pratchett and Neil Gaiman', 'A.Z. Fell and Co.', '9780060853983', 50);
INSERT INTO BOOK(title, author, bookshopName, isbn, price) VALUES('A Wizard of Earthsea', 'Ursula K. Le Guin', 'A.Z. Fell and Co.', '9780547773742', 20);
INSERT INTO BOOK(title, author, bookshopName, isbn, price) VALUES('IT', 'Stephen King', 'A.Z. Fell and Co.', '9781508297123', 20);
INSERT INTO BOOK(title, author, bookshopName, isbn, price) VALUES('The Nice and Accurate Prophecies of Agnes Nutter', 'Agnes Nutter', 'A.Z. Fell and Co.', '000000000000', 200);
INSERT INTO BOOK(title, author, bookshopName, isbn, price) VALUES('Cujo', 'Stephen King', 'A.Z. Fell and Co.', '9781501192241', 20);
INSERT INTO BOOK(title, author, bookshopName, isbn, price) VALUES('Nation', 'Terry Pratchett', 'A.Z. Fell and Co.', '9780552557795', 30);
INSERT INTO BOOK(title, author, bookshopName, isbn, price) VALUES('The Ocean at the End of the Lane', 'Neil Gaiman', 'A.Z. Fell and Co.', '9780062459367', 30);
----

== Configure a MySQL Database Connection

After you create the table, go to Anypoint Studio to configure the MySQL database connection:

. Create a new Mule project in Studio.
. Navigate to the *Global Elements* view.
. Click *Create* to open the *Choose Global Type* view.
. In the *Filter* field, type `http`, select *HTTP Listener config*, and click *OK*. +
This configuration is for the HTTP *Listener* source that initiates the Mule application flow.
. In the *HTTP Listener config* window, set the following parameters:

* *Protocol* +
`HTTP (Default)` +
* *Host* +
`All Interfaces [0.0.0.0] (default)` +
* *Port* +
`8081`

[start=4]
. Click *OK*.
. In the *Global Elements* view, click *Create* to open the *Choose Global Type* view.
. In the *Filter* field, type `database`, select *Database Config*, and click *OK*.
. In the *Database Config* window, set the *Name* field to `dbConfig`.
. In the *Connection* field, select *MySQL Connection*.
. Click *Configure* to add the required MySQL JDBC driver and select one of: +
+
* *Add recommended library* +
Install the recommended library.
* *Use local file* +
Install the library using a local file.
* *Add Maven dependency* +
Install a Maven dependency to add to the project.
+
[start=10]
. In the *Connection* section, set the following parameters: +
+
* *Host* +
`localhost`
* *Port* +
`3306`
* *User* +
`root`
* *Password* +
`mysql`
* *Database* +
`sys`
+
[start=11]
. On the *Advanced* tab, set the *Pooling profile* field to *Edit inline*.
. Set the *Max pool size* field to `5`.
. Click *Test Connection* to confirm that Mule can connect to the database.
. Click *OK*.

The following screenshot shows the HTTP Listener global element configuration in Studio:

.HTTP Listener configuration
image::database-querysingle-example-1.png[HTTP Listener configuration]

The following screenshots show the Database global element configuration in Studio:

.Database Config General cofiguration
image::database-querysingle-example-2.png[Database Config General configuration setting Host, Port, User, Password Database values parameters]

== Create, Run and Test the Mule Application
After you configure the MySQL database connection, create, run and test the Mule application:

=== Configure the HTTP Listener and Set Variable Component

To create the Mule flow:

. In the *Mule Palette* view, select the HTTP *Listener* source and drag it on to the canvas. +
The source initiates the flow by listening for incoming HTTP message attributes.
. In the *Connector configuration* field, select `HTTP_Listener_config` global configuration.
. Set the *Path* field to `/select/book/{maxId}`. +
The `maxId` value parameter indicates how many books information you will retrieve and list from the database. You can increment this value number regardless of the number of maximum connections you configured in your database connection pool.
. In the *Mime Type* tab, set the *Mime Type* field to `application/json`.
. In the *Advanced* tab, set the *Allowed methods* field to `GET`.
. Drag a *Set Variable* component to the right of the *Listener* source. +
This component creates a new variable to save the database results that will be obtained from the *Single Query* operation.
. Set the *Name* field to `bookCollection` and the *Value* field to `#[[]]`.

.Set Variable configuration
image::database-querysingle-example-3.png[Set Variable configuration]

=== Configure the For Each Component, the Single Query Operation and Set Payload Component

Continue creating the Mule application using a *For Each* component that iterates over the number of books requested in the *HTTP Listener*, retrieves the books information using the *Single Query* operation, save the results in a payload variable:

. Drag a *For Each* component to the right of *Set Variable*. +
. Set the *Collection* field to `#[1 to attributes.uriParams.maxId]`. +
This expression iterates the collection of books in the table, from the first book (`1`) to the number of books set in the `maxId` parameter when performing the HTTP request `/select/book/{maxId}`.
+
.For Each configuration
image::database-querysingle-example-4.png[For Each configuration]
+
[start=3]
. Drag the *Single query* operation inside the *For Each* component.
. Set the *Connector configuration* field to `Database_Config` to connect to the MySQL database configuration.
. Set the *SQL Query Text* field to `SELECT id, title, author FROM BOOK WHERE id = :id`. +
This query selects the books information from the database.
. Set the *Input Parameters* field to `![CDATA[#[{'id': payload }]]]`. +
This expression maps the key parameter `id` (referenced in the previous *SQL Query Text* expression) to `payload` which is the result value of books information retrieved using the `SELECT` query.
+
.Single query configuration
image::database-querysingle-example-5.png[Single query configuration]
+
[start=7]
. Drag another *Set Variable* component to the right of the *Single query* operation.
. Set the *Name* field to `bookCollection` and the *Value* field to `#[vars.bookCollection ++ [payload]]`. +
The original variable `bookCollection` now saves the `payload` of the retrieved book information.
. Drag a *Set Payload* component to the right of the *For Each* component.
. Set the *Value* field to `#[vars.bookCollection]` to save the variable content as a new output payload.

=== Run and Test the Mule Application

To complete and test the Mule application:

. Save the project in Studio.
. Test the app by using the following curl command in your terminal: `curl localhost:8081/select/book/7`. +
This command selects the first 7 books of the table, regardless of the maximum number of connections (`5`) that is configured in the pool.

== XML for Calling Oracle Stored Procedure with UDTs

Paste this code into your Studio XML editor to quickly load the flow for this example into your Mule app:

[source,xml,linenums]
----
----

[source,xml,linenums]
----
<db:config name="Database_Config">
	<db:my-sql-connection host="localhost" port="3306" user="root" password="mysql" database="sys">
		<db:pooling-profile maxPoolSize="5"/>
	</db:my-sql-connection>
</db:config>
----

[source,xml,linenums]
----
	<flow name="querysingleForeachFlow">
		<http:listener doc:name="Listener" config-ref="HTTP_Listener_config" path="/select/book/{maxId}" outputMimeType="application/json" allowedMethods="GET"/>

		<set-variable variableName="bookCollection" value="#[[]]" />

		<foreach collection="#[1 to attributes.uriParams.maxId]">
			<db:query-single doc:name="Query single" config-ref="Database_Config">
				<db:sql >SELECT id, title, author FROM BOOK WHERE id = :id</db:sql>
				<db:input-parameters ><![CDATA[#[{'id': payload }]]]></db:input-parameters>
			</db:query-single>
			<set-variable variableName="bookCollection" value="#[vars.bookCollection ++ [payload]]" />
		</foreach>

		<set-payload value="#[output application/json --- { books : vars.bookCollection }]" />
	</flow>
----
