= Call Oracle Stored Procedure with User-Defined Types (UDT) Example - Mule 4

Oracle enables you to define your own custom data types known as User-Defined Types (UDT). The following example illustrates how to configure Anypoint Connector for Database (Database Connector) *Stored procedure* operation to call an Oracle stored procedure that uses UDTs for its input and output parameters. Additionally, the example shows how to use `createStruct` and `createArray` DataWeave functions to map application data to your custom types.

The following screenshot shows the Anypoint Studio app flow for this example:

.Oracle UDTs Flow
image::database-oracle-udt-flow.png[Oracle UDTs Flow in Anypoint Studio]


== DataWeave createStruct and createArray Functions

The example uses the `createStruct` and `createArray` DataWeave functions to map application data to our custom types.

The `createStruct` function creates JDBC Struct objects based on the `Name` type and their correspondent properties. In our example, types `PERSON` and `PHONE_NUMBER` are struct objects. The function expects the following parameters in order:

* `configName` +
A string with the name of the configuration in charge of creating the `Struct` type, in our example is `dbConfig`.
* `typeName` +
A string with the name of the `Struct` type to create, in our example is `PERSON` or `PHONE_NUMBER`.
* `values` +
An array of values that conforms the `Struct` properties, in our example an array with the property values for `PHONE_NUMBER` is `['046', '666']`.

The `createArray` function creates JDBC Array objects based on the `Array` type. In our example, types `PHONE_NUMBER_ARRAY`, `PEOPLE` and `PHONE_BOOK` are array objects. The function expects the following parameters in order:

* `configName` +
A string with the name of the configuration in charge of creating the `Array` type, in our example is `dbConfig`.
* `typeName` +
A string with the name of the `Array` type to create, in our example is `PEOPLE` or `PHONE_NUMBER_ARRAY`.
* `values` +
An array of values that conforms the `Array` type, in our example is an array of `PERSON` objects created using the `createStruct` function.

Note that you can combine and use these functions to create subtypes or nested types. In our example, the type `PERSON` contains the `PHONE_NUMBER_ARRAY` objects. At the same time, the type `PHONE_NUMBER_ARRAY` is defined as an array of `PHONE_NUMBER`.

Additionally, you can combine these functions for complex types, ensure to use the `createArray` function when you are matching to an UDT based on the `Array` type.


== Initialize the Oracle Database

First, initialize the Oracle database using your desired SQL client tool by running the following script that creates these UDTs: `PEOPLE`, `PERSON`, `PHONE_NUMBER`, `PHONE_NUMBER_ARRAY` and `PHONE_BOOK`. The order in which these UDTs are defined is important because some of the types are nested. For example, the type `PERSON` is defined as an object that contains a `PHONE_NUMBER_ARRAY` as one of its members. The script also creates a table called `HUMANS` and a stored procedure called `PROC_INSERT_HUMANS`. +

This stored procedure expects to receive an object of type `PEOPLE` as its input parameter, and will insert into the table `HUMANS` all the people whose age is less than 100. The stored procedure also defines a parameter of type `PHONE_BOOK`, that expects to receive the contact list of all the people previously inserted into the table `HUMANS` as an output.

Oracle script to initialize:

[source,xml,linenums]
----

--CREATE CUSTOM DATA TYPES (UDTs)
CREATE OR REPLACE TYPE PHONE_NUMBER AS object(areaCode VARCHAR2(10), phoneNumber VARCHAR2(20));
CREATE OR REPLACE TYPE PHONE_NUMBER_ARRAY AS VARRAY(10) OF PHONE_NUMBER;
CREATE OR REPLACE TYPE PERSON IS OBJECT(firstName VARCHAR(50), surname VARCHAR(50), age NUMBER, phoneNumbers PHONE_NUMBER_ARRAY);
CREATE OR REPLACE TYPE PEOPLE IS TABLE OF PERSON;

CREATE OR REPLACE TYPE PHONE_BOOK AS VARRAY(10) OF VARCHAR2(200);


--CREATE TABLE HUMANS;
CREATE TABLE HUMANS(
  firstName VARCHAR(50),
  surname VARCHAR(50),
  age NUMBER,
  phoneNumbers PHONE_NUMBER_ARRAY
);

--CREATE STORED PROCEDURE
create or replace procedure PROC_INSERT_HUMANS(people IN PEOPLE, contactList OUT PHONE_BOOK) IS
    phoneBook PHONE_BOOK := PHONE_BOOK();
    BEGIN
        FOR idx IN people.first .. people.last LOOP
            IF people(idx).age < 100 THEN
                INSERT INTO HUMANS(firstName, surname, age, phoneNumbers)
                VALUES(people(idx).firstName, people(idx).surname, people(idx).age, people(idx).phoneNumbers);
            END IF;
        END LOOP;

        FOR humanContact IN (SELECT * FROM  HUMANS h, TABLE(h.phoneNumbers) n) LOOP
            phoneBook.EXTEND(1);
            phoneBook(phoneBook.COUNT) := humanContact.surname || ',' || humanContact.firstname || ':' || humanContact.areaCode ||'-'|| humanContact.phoneNumber;
        END LOOP;

        contactList := phonebook;

        COMMIT;
END PROC_INSERT_HUMANS;
----

== Configure Global Elements

Next, in Anypoint Studio configure an *HTTP Listener config* global element for the HTTP *Listener* source that initiates the flow, and a *Database Config* global element to list all the UDTs that were previously created in the Oracle database:

. Create a new Mule project in Studio.
. Navigate to the *Global Elements* view.
. Click *Create* to open the *Choose Global Type* view.
. In the *Filter* field write `http`, select *HTTP Listener config* and click *OK*.
. In the *HTTP Listener config* window, set the following parameters:

* *Protocol* +
`HTTP (Default)` +
* *Host* +
`All Interfaces [0.0.0.0] (default)` +
* *Port* +
`8081`

[start=4]
. Click *OK*.
. In the *Global Elements* view, click *Create* to open the *Choose Global Type* view.
. In the *Filter* field write `database`, select *Database Config* and click *OK*.
. In the *Database Config* window, set the *Name* field to `dbConfig`.
. In the *Connection* field, select *Oracle Connection*.
. Click *Configure* to add the required Oracle JDBC driver and select either: +
+
* *Use local file* +
Install the library using a local file.
* *Add Maven dependency* +
Install a Maven dependency to add to the project.
+
[start=10]
. In the *Connection* section, set the following parameters: +
+
* *Host* +
`localhost`
* *Port* +
`1521`
* *User* +
`SYS as SYSDBA`
* *Password* +
`Oradoc_db1`
* *Instance* +
`ORCLCDB`
+
[start=11]
. On the *Advanced* tab, set the *Column types* field to *Edit inline*.
. Click the plus sign (*+*) to add new column types, set the *Id* and *Type name* fields with the following values:
+
[%header,cols="30a,70a"]
|===
| Id | Type name
| 2003 |  `PEOPLE`
| 2003 |  `PHONE_NUMBER`
| 2008 |  `PERSON`
| 2003 |  `PHONE_ARRAY`
| 2003 |  `PHONE_BOOK`
|===
+
[start=13]
. Click *Finish* to close the *Column type* window.
. Click *Test Connection* to confirm that Mule can connect to the database.
. Click *OK*.

The following screenshot shows the HTTP Listener global element configuration in Studio:

.HTTP Listener configuration
image::database-oracleudt-example-1.png[HTTP Listener configuration]

The following screenshots shows the Database global element configuration in Studio:

.Database Config General cofiguration
image::database-oracleudt-example-2.png[Database Config General configuration setting Host, Port, User, Password and Instance values parameters]

.Database Config Advanced cofiguration
image::database-oracleudt-example-3.png[Database Config advanced configuration setting Column types values]


== Create and Run for your Mule App

Create the Mule app flow in Anypoint Studio:

. In the *Mule Palette* view, select the HTTP *Listener* source and drag it on to the canvas. +
The source listens for incoming HTTP messages attributes.
. In the *Connector configuration* field, select `HTTP_Listener_config` global configuration.
. Set the *Path* field to `/oracle`.
. Drag a *Set Payload* component to the right of *Listener*. +
This component set a list of items to send to the stored procedure to process.
. In the *Value* field, set the following code for the list of items: +
+
[source,xml,linenums]
----
[{'name':'Anthony J', 'surname':'Crowley', 'age': 6000, 'phoneNumber': {'areaCode':'020', 'phoneNumber': '777'}},
	{'name':'A.Z', 'surname':'Fell', 'age': 6000, 'phoneNumber':{'areaCode':'020', 'phoneNumber': '888'}},
	{'name':'Adam', 'surname':'Young', 'age': 11, 'phoneNumber':{'areaCode':'046', 'phoneNumber': '666'}},
	{'name':'Anathema', 'surname':'Device', 'age': 27, 'phoneNumber':{'areaCode':'020', 'phoneNumber': '123'}},
	]
----
+

.Set Payload configuration
image::database-oracleudt-example-4.png[Set payload configuration]

[start=7]
. Set the *Mime Type* field to `application/java`
. Drag a *Transform Message* component to the right of *Set Payload*. +
This component transforms the JSON objects into an object that can be mapped to the data type `PEOPLE` that the stored procedure expects as its input parameter.
. Double click the component in the Studio canvas, and set the name to `Transform Message - Prepare UDT`.
. In the *Output* source code view of the component, click the *Edit Current Target* button.
. In the *Selection dialog* box, set the *Output* field to `Variable`, the *Variable name* to `in_people_tab`, and click *OK*.
. In the *Output* field, set the following DataWeave expression that contains the `createStruct`  and `createArray` functions to create said object:
+
[source,DataWeave,linenums]
----
%dw 2.0
output application/java

fun toPhoneNumberArray(phoneNumber) = Db::createArray("dbConfig", "PHONE_NUMBER_ARRAY",[Db::createStruct("dbConfig", "PHONE_NUMBER", [phoneNumber.areaCode, phoneNumber.phoneNumber])])
fun toPerson(person) = Db::createStruct("dbConfig", "PERSON", [person.name, person.surname, person.age, toPhoneNumberArray(person.phoneNumber)])
---
Db::createArray("dbConfig", "PEOPLE", payload map (item, index) -> ( toPerson(item) ) )
----
+

.Transform Message configuration
image::database-oracleudt-example-6.png[Transform Message configuration]


[start=13]
. Drag a *Stored procedure* operation to the right of *Transform Message*. +
This operation calls the stored procedure using Database Connector.
. In the *Connector configuration* field, select `dbConfig` global configuration.
. In the *SQL Query Text* field enter `{ call proc_insert_humans(:people, :phoneBook) }`. +
. In the *Input Parameters* field enter `{ people: vars.in_people_tab}` +
To map the output of our transformation, which is stored in the variable called `in_people_tab` to our input parameter.
. In the *Output Parametrs* field, select `Edit inline` and click the plus sign (*+*) to set a custom parameter:

* *Key* +
`phoneBook`
* *Custom type* +
`PHONE_BOOK`

.Stored procedure configuration
image::database-oracleudt-example-5.png[Stored procedure configuration]

[start=18]
. Drag a second *Transform Message* component to the right of *Stored procedure*.
. Double click the component in the Studio canvas, and set the name to `Transform Message - response to JSON`
. In the *Output* source code view of the component, set the following DataWeave expression:
+
[source,DataWeave,linenums]
----
%dw 2.0
output application/json
---
payload
----
+
[start=20]
. Save the project.
. Test the app by using the following curl command in your terminal: `curl localhost:8081/oracle`. +
The stored procedure should return the list of phone numbers of all the people added to the table `HUMANS`.

== XML for Calling Oracle Stored Procedure with UDTs

Paste this code into your Studio XML editor to quickly load the flow for this example into your Mule app:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">

	<http:listener-config name="HTTP_Listener_config" >
		<http:listener-connection host="0.0.0.0" port="8081" />
	</http:listener-config>

	<db:config name="dbConfig" >
		<db:oracle-connection host="localhost" user="SYS as SYSDBA" password="Oradoc_db1" instance="ORCLCDB">
			<db:column-types>
				<db:column-type id="2003" typeName="PEOPLE"/>
				<db:column-type id="2003" typeName="PHONE_NUMBER"/>
				<db:column-type id="2008" typeName="PERSON" />
				<db:column-type id="2003" typeName="PHONE_NUMBER_ARRAY"/>
				<db:column-type id="2003" typeName="PHONE_BOOK"/>
			</db:column-types>
		</db:oracle-connection>
	</db:config>

	<flow name="oracle-udtsFlow" >
		<http:listener config-ref="HTTP_Listener_config" path="/oracle"/>

		<set-payload value="#[[{'name':'Anthony J', 'surname':'Crowley', 'age': 6000, 'phoneNumber': {'areaCode':'020', 'phoneNumber': '777'}},
	{'name':'A.Z', 'surname':'Fell', 'age': 6000, 'phoneNumber':{'areaCode':'020', 'phoneNumber': '888'}},
	{'name':'Adam', 'surname':'Young', 'age': 11, 'phoneNumber':{'areaCode':'046', 'phoneNumber': '666'}},
	{'name':'Anathema', 'surname':'Device', 'age': 27, 'phoneNumber':{'areaCode':'020', 'phoneNumber': '123'}},
	]]" mimeType="application/java"/>


	<ee:transform doc:name="Transform Message - Prepare UDT">
			<ee:variables>
				<ee:set-variable variableName="in_people_tab"><![CDATA[%dw 2.0
				output application/java
				fun toPhoneNumberArray(phoneNumber) = Db::createArray("dbConfig", "PHONE_NUMBER_ARRAY",[Db::createStruct("dbConfig", "PHONE_NUMBER", [phoneNumber.areaCode, phoneNumber.phoneNumber])])
				fun toPerson(person) = Db::createStruct("dbConfig", "PERSON", [person.name, person.surname, person.age, toPhoneNumberArray(person.phoneNumber)])
				---
				Db::createArray("dbConfig", "PEOPLE", payload map (item, index) -> ( toPerson(item) ) )
				]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<db:stored-procedure config-ref="dbConfig">
			<db:sql><![CDATA[{ call proc_insert_humans(:people, :phoneBook) }]]></db:sql>
			<db:input-parameters><![CDATA[{
				people: vars.in_people_tab
			}]]></db:input-parameters>
			<db:output-parameters >
				<db:output-parameter key="phoneBook" customType="PHONE_BOOK" />
			</db:output-parameters>
		</db:stored-procedure>
		<ee:transform doc:name="Transform Message - response to JSON" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
					output application/json
					---
					payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</flow>

</mule>
----

== See Also

* xref:connectors::introduction/introduction-to-anypoint-connectors.adoc[Introduction to Anypoint Connectors]
* https://help.mulesoft.com[MuleSoft Help Center]
