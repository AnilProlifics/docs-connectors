= Configure a Database Connection

Anypoint Connector for Database (Database Connector) can connect to any database for which a JDBC driver is available. The following examples show how to connect to the most popular databases such as Derby, Microsoft SQL Server, MySQL, Oracle, and a generic database. Additionally, for advanced uses cases, there are examples to connect to a global data source, configure a JDBC driver, and configure connection pooling, both in Anypoint Studio and the XML editor.

== Configure Data Source Reference Connection

When you set up a <<generic_db, generic connection>>, the connector uses the information you provide to generate a JDBC `DataSource`. In some cases, you might want to create your own `DataSource`. To do this, the database configuration supports a `data-source-connection` element that allows you to reference a `DataSource` that is defined through the Spring module.

To connect to a global `DataSource`:

. Create a Spring configuration file containing a Bean such as this one:
+
[source,xml,linenums]
----
<bean id="jdbcDataSource" class="org.enhydra.jdbc.standard.StandardDataSource"
 destroy-method="shutdown">
   <property name="driverName" value="org.apache.derby.jdbc.EmbeddedDriver"/>
   <property name="url" value="jdbc:derby:muleEmbeddedDB;create=true"/>
</bean>
----
+
The previous example creates a custom enhydra `DataSource` that connects to a Derby database.
+
. Reference your Spring configuration file using the Spring module, and use the `DataSource` in a connection:
+
[source,xml,linenums]
----
<spring:config name="datasource" files="datasource-config.xml" />

<db:config name="dbConfig">
   <db:data-source-connection dataSourceRef="jdbcDataSource" />
</db:config>
----

== Configure Derby Connection

Use the *Derby Connection* type when you want to connect to a Derby database.

The following example shows how to configure a *Derby Connection* in Anypoint Studio:

. In Studio, navigate to the *Global Elements* view.
. Click *Create* to open the *Choose Global Type* view.
. In *Filter* write `database`, select *Database Config* and click *OK*.
. In the *Database Config* window, for *Connection* select *Derby Connection*.
. Click *Configure* to add the required Derby JDBC driver and select either: +
+
* *Add recommended library* +
Install the recommended library.
* *Use local file* +
Install the library using a local file.
* *Add Maven dependency* +
Install a Maven dependency to add to the project.
+
. Set *Database* to...
. On the *Transactions* tab, optionally specify the transaction isolation, or XA transactions when connecting to the database.
. On the *Advanced* tab, optionally specify connection pooling and reconnection information, including a reconnection strategy.
. Click *Test Connection...* to confirm that Mule can connect to the database.
. Click *OK*.

The following screenshot shows the *Derby Connection* configuration in Studio:

.Derby Connection configuration
image::database-derby-connection.png[Derby Connection configuration]

In the XML editor, the configuration looks like this:
[source,xml,linenums]
----

----

== Configure Generic Connection

Use the *Generic Connection* type when you want to connect to:

* A database for which MuleSoft does not provide a specific connection type.
* A supported database and you are using custom options that are not included in the connection types.

The following example shows how to connect to an H2 database in Anypoint Studio:

. In Studio, navigate to the *Global Elements* view.
. Click *Create* to open the *Choose Global Type* view.
. In *Filter* write `database`, select *Database Config* and click *OK*.
. In the *Database Config* window, for *Connection* select *Generic Connection*.
. Click *Configure* to add the required JDBC driver and select either: +
+
* *Use local file* +
Install the library using a local file.
* *Add Maven dependency* +
Install a Maven dependency to add to the project.
+
. Set the connection *URL* to `jdbc:h2:file:/tmp/datasenseDBand` and *Driver class name* to `org.h2.Driver`.
. Click *Test Connection...* to validate the connection with the database.
. Click *OK*.

The following screenshot shows the *Generic Connection* configuration in Studio:

.Generic Connection configuration
image::database-generic-connection.png[Generic Connection configuration]

In the XML editor, the configuration looks like this:

[source,xml,linenums]
----
<db:config name="Database_Config">
    <db:generic-connection driverClassName="org.h2.Driver"
    url="jdbc:h2:file:/tmp/datasenseDB"/>
</db:config>
----

== Configure Microsoft SQL Server Connection

Use the *Microsoft SQL Server Connection* type when you want to connect to a Microsoft SQL Server database.

The following example shows how to configure a *Microsoft SQL Server Connection* in Anypoint Studio:

. In Studio, navigate to the *Global Elements* view.
. Click *Create* to open the *Choose Global Type* view.
. In *Filter* write `database`, select *Database Config* and click *OK*.
. In the *Database Config* window, for *Connection* select *Microsoft SQL Server Connection*.
. Click *Configure* to add the required Microsoft SQL Server driver and select either: +
+
* *Add recommended library* +
Install the recommended library.
* *Use local file* +
Install the library using a local file.
* *Add Maven dependency* +
Install a Maven dependency to add to the project.
+
. Set *Host* to `0.0.0.0`, *Port* to `553`, *User* to `Max`, *Password* to `password` and *Database name* to `microsoftDB`.
. On the *Transactions* tab, optionally specify the transaction isolation, or XA transactions when connecting to the database.
. On the *Advanced* tab, optionally specify connection pooling and reconnection information, including a reconnection strategy.
. Click *Test Connection...* to confirm that Mule can connect to the database.
. Click *OK*.

The following screenshot shows the *Microsoft SQL Server Connection* configuration in Studio:

.Microsoft SQL Server Connection configuration
image::database-mssql-connection.png[Microsoft SQL Server Connection configuration]

In the XML editor, the configuration looks like this:

[source,xml,linenums]
----
<db:config name="Database_Config">
    <db:mssql-connection
    host="0.0.0.0"
    port="553"
    user="Max"
    password="password"
    databaseName="microsoftDB" />
</db:config>
----

== Configure MySQL Database Connection

Use the *MySQL Connection* type when you want to connect to a MySQL database.

The following example shows how to configure a *MySQL Connection* in Anypoint Studio:

. In Studio, navigate to the *Global Elements* view.
. Click *Create* to open the *Choose Global Type* view.
. In *Filter* write `database`, select *Database Config* and click *OK*.
. In the *Database Config* window, for *Connection* select *MySQL Connection*.
. Click *Configure* to add the required MySQL JDBC driver and select either: +
+
* *Add recommended library* +
Install the recommended library.
* *Use local file* +
Install the library using a local file.
* *Add Maven dependency* +
Install a Maven dependency to add to the project.
+
. Set *Host* to `0.0.0.0`, *Port* to `3306`, *User* to `Max`, *Password* to `password` and *Database* to `someSchema`.
. On the *Transactions* tab, optionally specify the transaction isolation, or XA transactions when connecting to the database.
. On the *Advanced* tab, optionally specify connection pooling and reconnection information, including a reconnection strategy.
. Click *Test Connection...* to confirm that Mule can connect to the database.
. Click *OK*.

The following screenshot shows the *MySQL Connection* configuration in Studio:

.MySQL Connection configuration
image::database-mysql-connection.png[MySQL Connection configuration]

In the XML editor, the configuration looks like this:

[source,xml,linenums]
----
<db:config name="Database_Config">
  <db:my-sql-connection
  host="0.0.0.0"
  port="3306"
  user="Max"
  password="POWERS"
  database="someSchema"/>
</db:config>
----

== Configure Oracle Connection

Use the *Oracle Connection* type when you want to connect to an Oracle database.

The following example shows how to configure an *Oracle Connection* in Anypoint Studio:

. In Studio, navigate to the *Global Elements* view.
. Click *Create* to open the *Choose Global Type* view.
. In *Filter* write `database`, select *Database Config* and click *OK*.
. In the *Database Config* window, for *Connection* select **Oracle Connection**.
. Click *Configure* to add the required Oracle JDBC driver and select either: +
+
* *Add recommended library* +
Install the recommended library.
* *Use local file* +
Install the library using a local file.
* *Add Maven dependency* +
Install a Maven dependency to add to the project.
+
. Set *Host* to `192.168.99.100`, *Port* to `1521`, *User* to `system`, *Password* to `oracle` and *Instance* to `xe`.
. On the *Transactions* tab, optionally specify the transaction isolation, or XA transactions when connecting to the database.
. On the *Advanced* tab, optionally specify connection pooling and reconnection information, including a reconnection strategy.
. Click *Test Connection...* to confirm that Mule can connect to the database.
. Click *OK*.

The following screenshot shows the *Oracle Connection* configuration in Studio:

.Oracle Connection configuration
image::database-oracle-connection.png[Oracle Connection configuration]

In the XML editor, the configuration looks like this:

[source,xml,linenums]
----
<db:config name="Database_Config">
  <db:oracle-connection
  host="192.168.99.100"
  port="1521" instance="xe"
  user="system"
  password="oracle" />
</db:config>
----

=== Set the JDBC Driver

After you configure the connections, you can supply the JDBC driver. The following example shows how to supply a driver for the MySQL database.

Other than the need to specify a driver dependency, the steps are the same as for any other database.

. Add the driver as a dependency in your project's `pom.xml` file:
+
[source,xml,linenums]
----
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>5.1.6</version>
</dependency>
----
+
. Through your `pom.xml`, make Mule expose the driver dependency to the Database Connector, for example:
+
[source,xml,linenums]
----
<build>
    <plugins>
        <!-- Only used to declare the shared libraries-->
        <plugin>
            <groupId>org.mule.tools.maven</groupId>
            <artifactId>mule-maven-plugin</artifactId>
            <version>1.0.0</version>
            <configuration>
                <sharedLibraries>
                    <sharedLibrary>
                        <groupId>mysql</groupId>
                        <artifactId>mysql-connector-java</artifactId>
                    </sharedLibrary>
                </sharedLibraries>
            </configuration>
        </plugin>
    </plugins>
</build>
----

=== Configure Connection Pools

Establishing connections is costly in terms of connector and relational database management system (RDBMS) network and processing overhead. The solution is to build a connection pool that provides several available connections. Use the `<db:pooling-profile>` element, rather than the standard Mule `<pooling-profile>` element, for this purpose.

This example shows how to use the `db:pooling-profile` element:

[source,xml,linenums]
----
<db:config name="dbConfig">
    <db:my-sql-connection database="mozart_test" host="${host}" password="${password}" port="${port}" user="${user}">
        <db:pooling-profile acquireIncrement="1" maxPoolSize="5" maxWait="0" maxWaitUnit="SECONDS" minPoolSize="0" preparedStatementCacheSize="5"/>
    </db:my-sql-connection>
</db:config>
----

All connection configuration elements, except the global data source reference, accept the pooling profile. In JDBC, pooling occurs at the data source level. To do pooling, you have to configure the global data source. The software cannot add it on the fly.

Unlike other connectors such as FTP or SFTP, the Database Connector uses the `<db:pooling-profile>` instead of the standard `<pooling-profile>`. This is because databases have special pooling attributes, such as `preparedStatementCacheSize`.

Besides the main profile properties:

    * `maxPoolSize`
    * `minPoolSize`
    * `acquireIncrement`
    * `preparedStatementCacheSize`
    * `maxWait`
    * `maxWaitUnit`
    * `maxIdleTime`

Which can be specified as indicated in the previous example, for any Database provider, you can now set additional specific properties if you have the need to do so. These additional properties do not override any of the main properties, if any of those were previously set.

The following example shows you how to add properties to your database pooling profile using the `db:additional-properties` element:

[source,xml,linenums]
----
<db:config name="dbConfig">
    <db:my-sql-connection database="mozart_test" host="${host}" password="${password}" port="${port}" user="${user}">
            <db:pooling-profile maxPoolSize="1" maxWait="1" minPoolSize="0" maxWaitUnit="SECONDS">
                <db:additional-properties>
                    <db:additional-property key="checkoutTimeout" value="1000"/>
                    <db:additional-property key="idleConnectionTestPeriod" value="2" />
                </db:additional-properties>
            </db:pooling-profile>
    </db:my-sql-connection>
</db:config>
----

For further information about parameters and connection type capabilities, see xref:database-documentation.adoc[the Database Connector Reference].

=== Create an Oracle Database Connection with TNS Names

To create an Oracle connection that relies on the `tnsnames.ora` file, use the Database Connector and provide configuration details in the
connector configuration. For this to work you have to add the http://download.oracle.com/otn/utilities_drivers/jdbc/11204/ojdbc6.jar[ojdbc6.jar] file
as a dependency in your project build path.

If a firewall is between your Mule instance and the database, use the `ENABLE=BROKEN` parameter to enable a keep-alive connection at the TNS connection. If a keep-alive connection is not set, the connection might drop traffic due to expiring inactivity timers.

For example, you can configure a database URL in the Database
Connector's *General* tab in Anypoint Studio, and supply this URL:

`jdbc:oracle:thin:${oracle.user}/${oracle.password}@(DESCRIPTION=(ENABLE=BROKEN)(FAILOVER=ON)(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=${oracle.host1})(PORT=${oracle.port}))(ADDRESS=(PROTOCOL=TCP)(HOST=${oracle.host2})(PORT=${oracle.port}))(CONNECT_DATA=(SERVICE_NAME=${oracle.service})))`
