= Configure an SAP Secure Network Communication Connection

Configure an SAP Secure Network Communication (SNC) to take advantage of security features such as secure data communication between the SAP system client and server, application level end-to-end security, and the ability to change security products without impacting your SAP business applications. Enabling SNC requires you to configure the client environment, the SAP server, and Anypoint Connector for SAP (SAP Connector).

== Prerequisites

To configure an SAP SNC, you must have access to:

* The SAP GUI application, which you can download from the https://sites.google.com/a/mulesoft.com/sap/abc/libs-tools?authuser=0[MuleSoft SAP Resource Center]
* The SAPCAR utility and SAP Cryptographic Library, which you can download from the SAP Support Portal if you are an S-user.
* An SAP ECC instance that can use SNC system variables
* The following transactions:
** STRUST (Trust Manager)
** SM30 (Table Maintenance)

== Configure the Client Environment

Configure the system variables that depend on the operating system you are using, and generate the personal security environment (PSE):

. Open the Windows command line or Mac Terminal app and use the SAPCAR utility to unpack the SAP Cryptographic Library:
+
`SAPCAR –xvf <file-name.SAR>`
+
. Configure the following environment variables:
** SNC_LIB
** SECUDIR = `<path_to_library>`
** LD_LIBRARY_PATH = `<path_to_library>\sapcrypto.dll`
** SSF_LIBRARY_PATH = `<path_to_library>\sapcrypto.dll`
+
For Windows, the `sapcrypto.dll` 64-bit version must be in another path and added to a new variable called `SNC_LIB_64:
+
. Use the `sapgenpse` tool to create the PSE:
+
`sapgenpse gen_pse -v -p RFC.pse`
+
When you run this command, you must enter a password or PIN to use later and a distinguished name, which must be unique. For example, you can enter a distinguished name like this:
+
`CN=RFC, C=AR, O=YourCompany, OU=IT`
+
You can use STRUST to see names that are already in use.
+
. Use the `sapgenpse` tool to create the `cred_v2` file, which stores the credentials for accessing the PSE:
+
`sapgenpse seclogin -p RFC -O <user-credentials>`+
+
where `<user-credentials>` are *xxx*
+
. Use the `sapgenpse` tool to export the client’s certificate from the PSE: *How are these credentials formatted and what can they include?*
+
`sapgenpse export_own_cert –v –p RFC –o RFC_MULE.crt`

== Configure the SAP Server

Configure the certificates and tables that authorize you to use SNC with your distinguished name.

To configure the SAP server:

. View the SAP distinguished name and certificates.
. Link the SAP certificate to your certificates
. Authorize the SNC client in SAP

=== View the SAP Distinguished Name and Certificates

View the SAP distinguished name and list of added certificates:

. Log in to SAP and enter the `STRUST` transaction.
. Select the `SNC SAPCryptolib` folder.

=== Link the SAP Certificate to Your Certificate

Download the SAP instance certificate to link it to your newly-generated certificate:

. Click the glasses (first button on the left of the screen) to enable the edition mode, and then double click `CN=SL-ABAP-IDP`.
. Click the download button at the bottom of the screen.
. Click the import button to upload your certificate.
. Click *Add to Certificate List* and save.
. Open a cmd or terminal window and use the `sapgenpse` tool to *associate your certificate to your PSE*:
+
`sapgenpse maintain_pk -v -a name_of_SAP_Server_Certificate.crt -p name_of_your_PSE.pse`

=== Authorize the SNC Client in SAP

Add a new entry to the `VSNCSYSACL` table view to enable your distinguished name to use SNC:

. Navigate to the *SM30* transaction and enter the view name.
. Select `E` as the work area.
. Add a new entry that associates your system ID and the SNC name with `p:<your-distinguished-name>.`
. Select all of the checkboxes to activate the entries.
. Click Save.
+
* If the server accepts the SNC name, it displays a `Canonical Name Determined` message on the SNC data box. *What should you do if the server does not accept the name?)
. Enable the SAP user for the Mule app to use SNC:
	.. Navigate to the *SM30* transaction, specify the `VUSREXTID` view, and click *Maintain*.
	.. In the *External ID type* field, select `DN` as the work area.
	.. Click *Continue*. (*Check this*)
	.. In the *External ID* field, enter the distinguished name.
	.. In the *Field*, enter the SAP user.
	.. Select *Activated*.
	.. Click *Save*. (*I don't see this on the screen.*)

	== Configure SAP Connector

	Configure SAP Connector to enable SNC:

. Access Anypoint Studio.
. Select the name of the connector in the Studio canvas.
. Click the plus sign (+) next to the *Connector configuration* field to access the global element configuration fields.
. On the *General* tab, configure the following required fields for simple connection provider authentication:
* *Username*
* *Password*
* *SystemNumber*
* *Client*
* *ApplicationServerHost*
* *Extended properties* as described in xref:mule-runtime::sap-jco-extended-properties.adoc[SAP JCo Extended Properties].
+
For examples, see xxx.
. On the *General* tab, configure the following required fields for client connection Provider (*Check this*):
* X.509 Certificate*, using the value from xxx
* Sap System Number*
* Sap Client Id*
* Application Server Host*
* Extended properties*.
+
For examples, see xxx.

=== SAP Server Side and Certificate Server Side Extended Properties Example:

[[%header,cols="50a,50"]]
|===
|Property |Example Value
|jco.server.snc_mode| `1`
|jco.server.snc_partnername| `p:CN=SL-ABAP-IDP`
|jco.server.snc_qop| `8`
|jco.server.snc_myname| `p:CN=MVIDP, C=AR, O=MuleSoft, OU=IT`
|jco.server.snc_lib| `C:/SNC/64bit/sapcrypto.dll`
| ===

=== SAP Client Side and Certificate Server Side Extended Properties Example

[[%header,cols="50a,50"]]
|===
|Property a|Example Value
|jco.server.snc_mode| 1
|jco.server.snc_partnername| p:CN=SL-ABAP-IDP)
|jco.server.snc_qop| 8
|jco.server.snc_myname| `p:CN=MVIDP, C=AR, O=MuleSoft, OU=IT`
|jco.server.snc_lib| `C:/SNC/64bit/sapcrypto.dll`
|jco.client.x509cert | `ABCD12EFG`
