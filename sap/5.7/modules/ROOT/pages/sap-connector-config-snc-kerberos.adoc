= Configuring an SAP Secure Network Communication Connection with Kerberos

Configure an SAP Secure Network Communication (SNC) with Kerberos to take advantage of security features such as secure data communication between the SAP system client and server, application-level end-to-end security, and the ability to change security products without impacting your SAP business applications. Enabling SNC with Kerberos requires you to configure the client environment, the SAP server, and Anypoint Connector for SAP (SAP Connector). (FIXXXXXXX)

== Before You Begin

To configure an SAP SNC with Kerberos, you must have access to:

* The SAP GUI application. To install this client, Java must already be installed on your machine. Then, download the installer for your OS from SAP.
* The SAPCAR utility and SAP Cryptographic Library, which you can download from the SAP Support Portal, if you are an S-user
* An SAP ECC instance that can use SNC system variables
* The following transactions:
** `STRUST` (Trust Manager)
** `SM30` (Table Maintenance)

== Configure the Client Environment

Configure the system variables that depend on the operating system you are using, and generate the personal security environment (PSE):

. Create a server user `adminsap` in the Active Directory.
. Check *Password never expires* and uncheck *Use DES encryption types for this account*.
. Create a Service Principal Name (SPN) `SAPService/sapdev@SSODOMAIN.LAB` for this user in the Active Directory.
+
`setspn -A SAPService/sapdev@SSODOMAIN.LAB DOMAIN_SHORT\sidadm`
+
. Export the keytab for this SPN from the Active Directory.
+
`ktpass -princ SAPService/sapdev@SSODOMAIN.LAB-mapuser DOMAINSHORT\sidadm -crypto AES256-SHA1 -ptype KRB5_NT_PRINCIPAL -mapop set -pass <*password*> -out <SID>aes.keytab`
+
. Configure the `krb5.conf` file using the KDC address and the realm information (SSODOMAIN.LAB).
. Import the key to the `etc` directory.
+
`ktutil`
+
`wkt /etc/krb5.keytab`
+
`q`
+
. Obtain a Kerberos Ticket Granting Ticket (TGT).
+
`kinit -V SAPService/sapdev@SSODOMAIN.LAB`
+
. Change the permissions for the keytab.
+
`chgrp sapsys /etc/krb5.keytab`
+
`chmod 640 /etc/krb5.keytab`
+
. Set up automatic renewal for the Kerberos TGT.
+
`crontab –e 01 0,6,12,18 * * * /usr/bin/kinit -R SAPService/sapdev@SSODOMAIN.LAB`


== Configure the SAP Server

Configure parameters and the tables that authorize you to use SNC with Kerberos with your distinguished name: 

. Go to `/usr/lib64/libgssapi_krb5.so.2` and configure the parameters for SNC with Kerberos and then restart SAP.
* `snc/permit_insecure_start = 1`
* `snc/data_protection/use = 3`
* `snc/data_protection/max = 3`
* `snc/data_protection/min = 1`
* `snc/accept_insecure_r3int_rfc = 1`
* `snc/accept_insecure_rfc = 1`
* `snc/accept_insecure_cpic = 1`
* `snc/accept_insecure_gui = 1`
* `snc/gssapi_lib = /usr/lib64/libgssapi_krb5.so.2`
* `snc/enable = 1`
* `snc/identity/as = p:SAPService/sapdev@SSODOMAIN.LAB`
* `login/password_change_for_SSO = 0`
. Copy the `gsskrb5.dll` file to the `%windir%\system32` directory and add the `SNC_LIB` variable with the `%windir%\system32\gsskrb5.dll.` value.
. Edit the `landscape.xml` file in the SAP Logon.
+
`<Service type=”SAPGUI” uuid=”xxxxxxxxxxxxxxxx” name=”SID-Dev” systemid=”SID” msid=”xxxxxxxxxxxxxxxxxxxx” mode=”1″ server=”hostname:3200″ sncop=”9″ sapcpg=”1100″ dcpg=”2″ sncname=”p:SAPService/sapdev@SSODOMAIN.LAB”/>`
+
. Add `adminsap` as a user in SAP and set the SNC name.
. Add the SPN name to an RFC destination in SAP.

== Configure SAP Connector

Configure SAP Connector to enable SNC with Kerberos:

. Access Anypoint Studio.
. Select *SAP* in the Studio canvas.
. Click the plus sign (+) next to the *Connector configuration* field to access the global element configuration fields.
. Configure the Kerberos connection:
.. In the *Connection* field, select `Kerberos`.
.. On the *General* tab, configure these fields:
** *SAP system number* 
** *SAP client ID*
** *Kerberos Config File Path*
+
Path to the `krb5.conf` file using the KDC address and the realm information (SSODOMAIN.LAB).
** *Keytab File Path*
+
Path to the keytab for the SPN from the Active Directory.
** *GSS Library Path*
+
Static value `/usr/lib64/libgssapi_krb5.so.2.2` when deploying to CloudHub.
** *Principal*
+
Service user name from the Active Directory, in this example `adminsap`.
** *Client SNC Partner Name*
+
SPN name from Active Directory, in this example `p:SAPService/sapdev@SSODOMAIN.LAB`.
** *Client SNC My Name*
+
Service user name from the Active Directory, in this example `p:adminsap`.
.. On the *Advanced* tab, configure the extended properties.

== See also

* xref:connectors::introduction/introduction-to-anypoint-connectors.adoc[Introduction to Anypoint Connectors]
* https://help.mulesoft.com[MuleSoft Help Center]
