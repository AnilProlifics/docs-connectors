= Veeva Vault Connector 1.4 OAuth 2.0 Configuration - Mule 4
:page-aliases: connectors::veevavault/veevavault-connector-oauth-config.adoc

Configuring OAuth2 Authentication for VeevaVault follows all the basic steps outlines in xref:connectors::introduction/intro-config-oauth2.adoc[] however there are a couple of extra configuration steps to understand.

== Identity Provider Configuration

Veeva Vault supports several Identity Providers like Azure AD, Ping Federate, and any other provider that supports the OIDC (OpenID Connect).
[NOTE]
Currently, Okta and any other providers that require PKCE are not supported.

You can follow xref:connectors::introduction/intro-config-oauth2.adoc[] a OAuth2 Identity Provider and connector configuration

== Veeva Vault Configuration

Next we can prepare our Veeva service to communicate with our Identity Provider.

In the Veeva Vault Admin panel, navigate to the Settings tab and under Domain Settings find OAuth 2.0 / OpenID Connect Profiles. Here we can press "Create" and configure our profile. Fill in the Label, name, set status to "Active" and set your Authorization Server Provider to the one you're using, select "Other" if it's not provided in the list. You can also uncheck the "Perform strict Audiance Restriction validation" checkbox to keep it simple.

Now you also need to load the AS Metadata. For all OpenID Connect providers, there's a special URL always ending with "/.well-known/openid-configuration" that contains this metadata.

*Examples:*

- Okta: `https://{OKTA_INSTANCE}.okta.com/.well-known/openid-configuration`
- Azure: `https://login.microsoftonline.com/{TENANT}/v2.0/.well-known/openid-configuration`
- PingFederate: `https://{YOUR_INSTANCE}/.well-known/openid-configuration`

We can use this to configure the Veeva AS Metadata by clicking on the Upload AS Metadata button and selecting the "Provide Authorization Server Metadata URL" option. This allows us to paste the above url into the field.

Your end profile configuration should look something like this:

image::oauth-veeva-config-profile.png[]

Upon pressing Save you will see the created profile. Here you need to take note of the Vault Session ID. You can find it in the Vault Session ID URL right at the end:

image::oauth-veeva-config-session-id.png[]

We will need this ID when configuring the connector. To fully configure Veeva with OpenID you will also need to provision users to use this new profile. Check out the https://platform.veevavault.help/en/gr/13977/[Veeva Vault Documentation] on how to do that.

== Connector Configuration

Enter the following information in the *General* tab of the *Global Element Properties* screen to configure OAuth 2.0 / Open ID connection:

[%header,cols="30s,70a"]
|===
|Field |Description
|Name | Configuration name
|Vault URL | Veeva Vault instance URL required for connection.
|Version | Version for the Veeva Vault instance required.
|Client Id | Client ID required to send with each request header to the Vault instance.
|OIDC Profile ID | OIDC profile ID generated by Veeva when creating a new OIDC profile. To configure the OIDC profile ID, use the ID in your OIDC profile in Veeva. Your OIDC profile contains a *Vault Session ID URL*, for example, `\https://login.veevavault.com/auth/oauth/session/_00000000-aaaa-bbbb-cccc-111111111111` where `_00000000-aaaa-bbbb-cccc-111111111111`. Use this value for the *OIDC Profile ID* field.
|Consumer Key | OAuth consumer key, as registered with the service provider. This is your IdP client ID, assuming you already have a client application registration created at the ID provider of your choice, for example, PoneOne or PingFederate.
|Consumer Secret | OAuth consumer secret, as registered with the service provider. This is your IdP client secret, assuming you already have a client application registration created at the ID provider of your choice, for example, PoneOne or PingFederate.
|Authorization Url | OAuth2 authorization URL, such as `\https://{your-instance}/as/authorization.oauth2` for PingFederate.
|Access Token Url | OAuth2 token URL, such as `\https://{your-instance}/as/token.oauth2`.
|Scopes | You can set up your OAuth2 scopes as necessary, but the important ones `openid` and `offline_access` are already pre-filled.
|Resource Owner Id | Depending on your IdP configuration, you can leave it blank.
|Listener Config | Create a new HTTP Listener or use an existing one if you have one, for example, `\http://localhost:8081/`.
|Callback Path | Callback path of your application. If you set it to `callback`, your full callback path is `\http://localhost:8081/callback`. Do not forget to add your callback path to the IdP's redirect URLs.
|Authorize Path | Authorize path. You will navigate to this path when starting the OAuth 2.0 dance, for example, `authorize` means the full path is `\http://localhost:8081/authorize`.
|External Callback Url | You can set this directly to `\http://localhost:8081/callback`.
|===

Example XML Configuration:
```
<configuration-properties file="application.properties" />

<http:listener-config name="HTTP_Listener_config" >
    <http:listener-connection host="localhost" port="${http.port}" >
    </http:listener-connection>
</http:listener-config>

<veevavault:config name="Veeva_Vault_Config">
    <veevavault:oauth2-oidc-connection vaultURL="https://${veeva.instance}.veevavault.com" clientId="${veeva.client.id}" oidcProfileId="${veeva.oidc.profile}">
        <veevavault:oauth-authorization-code consumerKey="${azure.client.id}" consumerSecret="${azure.client.secret}" authorizationUrl="https://login.microsoftonline.com/${azure.tenant}/oauth2/v2.0/authorize" accessTokenUrl="https://login.microsoftonline.com/${azure.tenant}/oauth2/v2.0/token" scopes="${azure.appid}/.default"/>
        <veevavault:oauth-callback-config listenerConfig="HTTP_Listener_config" callbackPath="callback" authorizePath="authorize" externalCallbackUrl="${oauth2.callback_uri}"/>
    </veevavault:oauth2-oidc-connection>
</veevavault:config>
```

The above example uses the salesforce Authentication Provider and requires you to create an `application.properties` file in your resources folder with this format:

```
http.port = 8080
oauth2.callback_uri = http://localhost:8080/callback

veeva.instance = your-veeva-instance
veeva.client.id = your-veeva-client-id
veeva.oidc.profile = your-oidc-id

azure.tenant = azure-tenant-id
azure.appid = azure-app-id
azure.client.id = azure-oauth-client-id
azure.client.secret = azure-oauth-client-secret

```

[NOTE]
Azure AD is a special case where the scope needs to be set as {app_id}/.default to work. With other Identity Providers you should use the predefined "openid offline_access" scopes unless they specify otherwise.

== See Also

* xref:connectors::introduction/intro-config-oauth2.adoc[]
* xref:connectors::introduction/introduction-to-anypoint-connectors.adoc[Introduction to Anypoint Connectors]
* https://help.mulesoft.com[MuleSoft Help Center]
