= Sending MDNs to Multiple Partners
:page-aliases: connectors::as2/as2-connector-multiple-partners.adoc

The following example shows how to send MDNs to multiple partners. This example contains two flows:

* The first flow exposes an AS2 listener endpoint to receive inbound AS2 messages.

* The second flow receives message payloads and AS2 sender and receiver information via HTTP. It then sends outbound AS2 messages to a target AS2 endpoint using the *Send with Sync MDN* operation.

== Exposing an AS2 Listener Endpoint to Receive Inbound AS2 Messages

image::as2-connector-mdn1-example.png[Flow for exposing the AS2 listener endpoint]

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:as2-mule4="http://www.mulesoft.org/schema/mule/as2-mule4" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/as2-mule4 http://www.mulesoft.org/schema/mule/as2-mule4/current/mule-as2-mule4.xsd">
	<as2-mule4:listener-config name="AS2_Connector_Listener_Shared" doc:name="AS2 Connector Listener config" httpListenerConfig="HTTP_Listener_config" securityLevel="SIGNED_ENCRYPTED" >
		<as2-mule4:self-config as2Name="forward-van" x509Alias="forward-van" email="support@forward-van.com" />
		<as2-mule4:listener-mode >
			<as2-mule4:shared-mode >
				<as2-mule4:partner-configs >
					<as2-mule4:partner-detail-extended as2Name="mythical-as2" x509Alias="mythical-as2" email="support@mythical.com" >
						<as2-mule4:auth-details username="mythical-as2-user" password="mythical123" />
					</as2-mule4:partner-detail-extended>
					<as2-mule4:partner-detail-extended as2Name="nto-as2" x509Alias="nto-as2" email="support@nto.com" >
						<as2-mule4:auth-details username="nto-as2-user" password="nto123" />
					</as2-mule4:partner-detail-extended>
					<as2-mule4:partner-detail-extended as2Name="myth-as2" x509Alias="myth-as2" email="support@myth.com" />
				</as2-mule4:partner-configs>
			</as2-mule4:shared-mode>
		</as2-mule4:listener-mode>
		<as2-mule4:key-store-config keystorePassword="test" keystorePath="as2/forward-van.p12" privateKeyPassword="test" />
	</as2-mule4:listener-config>
	<flow name="forward-van-as2-receiverFlow" >
		<as2-mule4:as2-listener doc:name="As 2 listener" config-ref="AS2_Connector_Listener_Shared" path="/forward-as2"/>
		<logger level="INFO" doc:name="Logger" message="Received AS2 message from #[attributes.fromName]"/>
		<logger level="INFO" doc:name="Logger" message="#[payload]"/>
	</flow>
</mule>
----

== Sending Outbound AS2 Messages to the Exposed AS2 Endpoint

image::as2-connector-mdn2-example.png[Flow for forwarding AS2 messages to the exposed endpoint]

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:tls="http://www.mulesoft.org/schema/mule/tls"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:as2-mule4="http://www.mulesoft.org/schema/mule/as2-mule4" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/as2-mule4 http://www.mulesoft.org/schema/mule/as2-mule4/current/mule-as2-mule4.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/tls http://www.mulesoft.org/schema/mule/tls/current/mule-tls.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config" basePath="b2b" >
		<http:listener-connection protocol="HTTPS" host="0.0.0.0" port="${https.port}" >
			<tls:context >
				<tls:key-store type="jks" path="rootca.jks" alias="rootca" keyPassword="test" password="test" />
			</tls:context>
		</http:listener-connection>
	</http:listener-config>
	<configuration-properties doc:name="Configuration properties" file="app.properties" />
	<as2-mule4:send-config name="AS2_Connector_Send_config" doc:name="AS2 Connector Send config" >
		<as2-mule4:connection partnerURL="#[vars.as2URL]" >
			<tls:context >
				<tls:trust-store insecure="true" />
			</tls:context>
		</as2-mule4:connection>
		<as2-mule4:self-config as2Name="#[vars.as2Sender]" x509Alias="#[vars.as2Sender]" email="support@forward-van.com" />
		<as2-mule4:partner-config as2Name="#[vars.as2Receiver]" x509Alias="#[vars.as2Receiver]" email="support@mythical.com"/>
		<as2-mule4:requester-config subject="EDI" messageIntegrityCheckAlgorithm="SHA256" mdnMessageIntegrityCheckAlgorithm="SHA256" encryptionAlgorithm="DES_EDE3" requestReceipt="SIGNED_REQUIRED"/>
		<as2-mule4:keystore-config keystorePassword="test" keystorePath="as2/forward-van.p12" privateKeyPassword="test" />
	</as2-mule4:send-config>
	<flow name="forward-van-as2-simulatorFlow1" >
		<http:listener doc:name="/forward-van/as2-send" config-ref="HTTP_Listener_config" path="/forward-van/as2-send"/>
		<logger level="INFO" doc:name="Logger" message="Forward VAN is sending IDOC to Mythical via AS2"/>
		<set-variable value="#[attributes.headers.'as2-URL']" doc:name="as2URL" variableName="as2URL"/>
		<set-variable value="#[attributes.headers.'as2-from']" doc:name="as2Sender" variableName="as2Sender"/>
		<set-variable value="#[attributes.headers.'as2-to']" doc:name="as2Receiver" variableName="as2Receiver"/>
		<as2-mule4:send-with-sync-mdn doc:name="Send with Sync MDN" config-ref="AS2_Connector_Send_config" outputMimeType="application/EDI-X12">
			<as2-mule4:custom-headers ><![CDATA[#[output application/java
---
{
	"PLANT-CODE" : "ABC-12345"
}]]]></as2-mule4:custom-headers>
		</as2-mule4:send-with-sync-mdn>
		<logger level="INFO" doc:name="Logger" message="#[output application/json --- attributes]"/>
		<set-payload value="#[output application/json --- attributes.as2MdnAttributes]" doc:name="Set Payload" />
	</flow>
</mule>
----

== Shared Mode
=== Edit inline
image::as2-listener-multiple-partners-inline.png[Edit inline Shared mode]
==== XML
[source,xml,linenums]
----
<as2-mule4:listener-config name="AS2_Server_Listener" doc:name="AS2 Connector Listener config" httpListenerConfig="HTTP_Server_Config" securityLevel="SIGNED_ENCRYPTED">
    <as2-mule4:self-config as2Name="partnera" x509Alias="partnera" email="support@partnera.com"/>
    <as2-mule4:listener-mode >
        <as2-mule4:shared-mode>
            <as2-mule4:partner-configs >
                <as2-mule4:partner-detail-extended as2Name="partnerb" x509Alias="partnerb" email="support@partnerb.com" />
                <as2-mule4:partner-detail-extended as2Name="partnerc" x509Alias="partnerc" email="support@partnerc.com" />
            </as2-mule4:partner-configs>
        </as2-mule4:shared-mode>
    </as2-mule4:listener-mode>
    <as2-mule4:key-store-config keystorePassword="test" keystorePath="as2/partnera.p12" privateKeyPassword="test" />
</as2-mule4:listener-config>
----
=== Expression
image::as2-listener-multiple-partners-expression.png[Expression Shared mode]
==== XML
[source,xml,linenums]
----
<as2-mule4:listener-config name="AS2_Server_Listener" doc:name="AS2 Connector Listener config" httpListenerConfig="HTTP_Server_Config" securityLevel="SIGNED_ENCRYPTED">
    <as2-mule4:self-config as2Name="partnera" x509Alias="partnera" email="support@partnera.com"/>
    <as2-mule4:listener-mode >
        <as2-mule4:shared-mode partnerConfigs='#[[&#10;	{as2Name:"partnerb", x509Alias:"partnerb", email:"support@partnerb.com"},&#10;	{as2Name:"partnerc", x509Alias:"partnerc", email:"support@partnerc.com"}&#10;]]' />
    </as2-mule4:listener-mode>
    <as2-mule4:key-store-config keystorePassword="test" keystorePath="as2/partnera.p12" privateKeyPassword="test" />
</as2-mule4:listener-config>
----
== See Also

* xref:as2-connector-examples.adoc[AS2 Connector Examples]
* xref:connectors::introduction/introduction-to-anypoint-connectors.adoc[Introduction to Anypoint Connectors]
* https://help.mulesoft.com[MuleSoft Help Center]