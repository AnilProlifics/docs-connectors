= IBM CTG Connector 2.3 Examples - Mule 4

The following example shows how to use multiple containers for IBM CTG Connector:

* <<use-multiple-containers>>

== Before You Begin

* Java 8 or 11
* Anypoint Studio 7.x
* Mule runtime engine (Mule) 4.x
* DataWeave
* Access to an IBM CTG system 9.1 or 9.2
* IBM SDK 9.1 or 9.2

== Configure a Connection

To secure connections, you must specify the connection field values. To do this:

* <<create-config-file, Create a configuration file for a connection.>>
* <<configure-conn, Configure the connection global elements.>>
* <<configure-global, Configure a global element for the properties file.>>

[[create-config-file]]
=== Create a Configuration File for a Connection

Create a configuration file that includes properties for a connection:

. Create a file named `mule-app.properties` in the `/src/main/resources/` folder.
. In the `mule-app.properties` file, create a set of properties for the connection,
similar to the ones that follow, replacing the bracketed text (including the brackets)
with the correct values for your configuration:
+
----
ibm.host=<hostname>
ibm.port=<port number>
ibm.serverName=<server name>
ibm.username=<username> (optional)
ibm.password=<password> (optional)
ibm.keystoreLocation=<location of the keystore containing the certificates required for an SSL connection> (optional)
ibm.keystorePassword=<password required to access the keystore for an SSL connection> (optional)
----
+
This may vary depending on the selected connection configuration.

For more information about creating a properties file, refer to xref:mule-runtime::mule-app-properties-to-configure.adoc[Configuring Property Placeholders].

[[configure-conn]]
=== Configure the Connection Global Elements

Configure global elements for connection:

. Create a new Mule project.
. In the *Mule Palette* view, click *Search in Exchange* and enter `ibm ctg`.
. Add *IBM CICS Transaction Gateway Connector* to the *Selected modules* section and click *Finish*.
. Click the *Global Elements* tab and click *Create*.
. Select *Connector Configuration > IBM CTG Config* and click *OK*.
. Enter the values to configure *Connection*.
. Click the *Test Connection* button to ensure there is connectivity with the IBM CTG API. A successful message should pop up.
. Click *OK*.

[[configure-global]]
=== Configure a Global Element for the Properties File

Configure a global element for the `mule-app.properties` file so that Mule knows
where to find it:

. Click the *Global Elements* tab and click *Create*.
. In the *Choose Global Type* dialog, select *Configuration properties* and click *OK*.
. In the *File* field, enter `mule.app.properties`.
. Click *OK*.


[[use-multiple-containers]]
== Use Multiple Containers

This Mule flow shows how to use multiple containers. This example uses the following operations:

* *HTTP Listener* +
Accepts data from HTTP requests
* *Transform Message* +
Sets the first content request and outputs the data as a flat file
+
----
%dw 2.0
output application/flatfile schemaPath = "ec03-type.ffd", segmentIdent = "DFHCOMMAREA", encoding="cp037"
---
[{
	"CICS-DATE-TM": ""
}]
----
+
* *Transform Message* +
Sets the second content request and outputs the data as a flat file
+
----
%dw 2.0
output application/flatfile schemaPath = "ec03-type.ffd", segmentIdent = "DFHCOMMAREA", encoding="cp037"
---
[{
	"CICS-DATE-TM": ""
}]
----
+
* *Transform Message* +
Sets multiple channels and content requests and outputs the data in JSON
+
----
%dw 2.0
output application/json
---
[
	{
		channelRequest : 	{
			channel: "EC03",
			encoding: "US-ASCII",
			errorContainer: "OUTPUTMESSAGE",
			programName: "EC03",
			requestContainer: "INPUTDATA",
			responseContainer: "CICSDATETIME",
			tpnName: "CSMI"
		},
		content : vars.request1.^raw
	},
	{
		channelRequest : 	{
			channel: "EC03",
			encoding: "US-ASCII",
			errorContainer: "OUTPUTMESSAGE",
			programName: "EC03",
			requestContainer: "INPUTDATA",
			responseContainer: "CICSDATETIME",
			tpnName: "CSMI"
		},
		content : vars.request2.^raw
	}
]
----
+
* *Execute with multiple channels* +
Calls a remote CICS program sending data encapsulated in channels and containers, enabling users to transfer more than 32 KB in a single request
+
Enter the following values:
+
[%header,cols="30s,70a"]
|===
|Field |Value
|Object type | `List`
|Connector Configuration | `IBMCTG_Config`
|Channel and contents| `payload`
|===
* *Transform Message* +
Outputs the data in JSON
+
----
%dw 2.0
output application/json
---
{
	"cics-date-time":payload
}
----
+
* *Logger* +
Performs logging

image::ibm-ctg-multiple-container.png[Studio Flow for using multiple containers in IBM CTG Connector]

=== XML for This Example

Paste this code into the Studio XML editor to quickly load the flow for this example into your Mule app:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:bti="http://www.mulesoft.org/schema/mule/ee/bti"
	xmlns:ibmctg="http://www.mulesoft.org/schema/mule/ibmctg" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/bti http://www.mulesoft.org/schema/mule/ee/bti/current/mule-bti-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/ibmctg http://www.mulesoft.org/schema/mule/ibmctg/current/mule-ibmctg.xsd">
	<configuration-properties file="mule-app.properties"/>
	<http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config" doc:id="de838cd2-71c3-41b3-9fbd-be6f671921dc" basePath="/" >
		<http:listener-connection host="0.0.0.0" port="8081" />
	</http:listener-config>
	<bti:transaction-manager />
	<ibmctg:config name="IBMCTG_Config" doc:name="IBMCTG Config" doc:id="1435fcc3-4b97-496e-8552-58a339dce96f" >
		<ibmctg:connection host="${config.host}" port="${config.port}" serverName="${config.serverName}" username="${config.username}" password="${config.password}" />
	</ibmctg:config>
	<flow name="multi_channel_testFlow" doc:id="a79bd0f2-e659-4778-96b1-fdcbf86166eb" >
		<http:listener doc:name="Listener" doc:id="594a7d30-b82f-4899-a212-0fc8897b414a" config-ref="HTTP_Listener_config" path="/multi"/>
		<ee:transform doc:name="Set Content Request I" doc:id="f3ebec71-8cb5-41f0-a993-bd68a963ac63" >
			<ee:variables >
				<ee:set-variable variableName="request1" ><![CDATA[%dw 2.0
output application/flatfile schemaPath = "ec03-type.ffd", segmentIdent = "DFHCOMMAREA", encoding="cp037"
---
[{
	"CICS-DATE-TM": ""
}]]]></ee:set-variable>
			</ee:variables>

		</ee:transform>
		<ee:transform doc:name="Set Content Request II" doc:id="1362b85a-a36c-4fa1-bc28-96266bc416c5">
			<ee:variables>
				<ee:set-variable variableName="request2" ><![CDATA[%dw 2.0
output application/flatfile schemaPath = "ec03-type.ffd", segmentIdent = "DFHCOMMAREA", encoding="cp037"
---
[{
	"CICS-DATE-TM": ""
}]]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<ee:transform doc:name="Set Multiple Channels And Contents Request" doc:id="4157b44c-ac57-40a6-8ced-c5e165a1035c" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
[
	{
		channelRequest : 	{
			channel: "EC03",
			encoding: "US-ASCII",
			errorContainer: "OUTPUTMESSAGE",
			programName: "EC03",
			requestContainer: "INPUTDATA",
			responseContainer: "CICSDATETIME",
			tpnName: "CSMI"
		},
		content : vars.request1.^raw
	},
	{
		channelRequest : 	{
			channel: "EC03",
			encoding: "US-ASCII",
			errorContainer: "OUTPUTMESSAGE",
			programName: "EC03",
			requestContainer: "INPUTDATA",
			responseContainer: "CICSDATETIME",
			tpnName: "CSMI"
		},
		content : vars.request2.^raw
	}
]]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ibmctg:execute-with-multiple-channels doc:name="Execute with multiple channels" doc:id="1913f9b3-95b2-4e83-8028-ea934d1a59ae" config-ref="IBMCTG_Config" />
		<ee:transform doc:name="Transform Message" doc:id="31f774bb-a848-42c6-a1ea-efb44612ca03" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	"cics-date-time":payload
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="dff20a20-43a0-401f-8c20-7d480062fe64" message="#[payload]"/>
	</flow>
</mule>
----

== See Also

* xref:connectors::introduction/introduction-to-anypoint-connectors.adoc[Introduction to Anypoint Connectors]
* https://help.mulesoft.com[MuleSoft Help Center]
