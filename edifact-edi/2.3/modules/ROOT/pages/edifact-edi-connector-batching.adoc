= EDIFACT EDI Connector 2.3 - Batch Outbound EDIFACT Messages - Mule 4

For B2B and EDI messages that are not time-sensitive, such as invoices and payment remittances, it is best practice to batch messages into a single interchange to send to trading partners instead of transmitting individual transactions as separate interchanges or files.

== Batching Stages

You can use the EDIFACT EDI Connector’s Batch operation to merge individual EDIFACT messages created and accumulated over time into a single interchange to send to your trading partners.

Implementing a batch involves two stages:

* Stage One - Accumulate the transactions
* Stage Two - Release the batch

=== Stage One - Accumulate the Transactions

To accumulate transactions for a batch:

* Transform the payloads into EDIFACT messages using DataWeave and EDIFACT as you receive application messages (such as a JSON invoice) from the backend systems.
* Create EDIFACT payloads using temporary control number keys in the EDIFACT Write operation. +
This enables sending the accumulated EDIFACT as a batch at a later time. The batch is created with control numbers that are not used in the final batch sent to the trading partner. For example,
`<edifact:write doc:name="Write individual D97A ORDERS" doc:id="3d51215a-125d-461b-9791-0a939e5ebc45" config-ref="EDIFACT_Write_ORDERS" interchangeControlNumberKey="NTO-MYTHICAL-UNB-TMP"/>`
* Store the intermediate EDIFACT message payloads in your choice of storage, such as a database table.

image::edifact-edi-connector-batch-flow-1.jpg[Accumulate the transactions]

For example, this implementation of a Mule flow:

* Receives JSON payloads from the backend systems.
* Transforms to `EDIFACT D97A ORDERS` message.
* Generates the intermediate EDIFACT message payload using the EDIFACT Write operation.
* Stores the EDIFACT payload in a database table.

=== Stage Two - Release the Batch

Trading partners have varying criteria for how they want transactions batched. The criteria are met by meeting one or a combination of the following conditions and are implemented outside of the EDIFACT EDI Connector operations:

* Release the batch at a specific time interval or a specific time of the day.
* Release the batch when a specific number of transactions are accumulated.
* Release the batch when the total size of the accumulated transactions is near a threshold.

To release the batch:

* Implement the logic or module to monitor the transactions accumulated in the temporary storage and determine when a particular batch is released.

* Retrieve the accumulated intermediate EDIFACT messages from the temporary storage based on the batch criteria, append the transactions together, and then send the appended payload to the EDIFACT Batch operation. +
You can choose to use the control number key on the Batch operation, or leave the control number key fields empty at the time of Batch operation execution - allowing the EDIFACT EDI Connector to generate the control number sequence automatically based on the sender and receiver identifier combination. For example,
`<edifact:batch doc:name="Batch" doc:id="3ce80437-63e2-404c-b875-531708b7bfdb" config-ref="EDIFACT_Batch" interchangeControlNumberKey="NTO-MYTHICAL-UNB-TMP"> <edifact:batch-content ><![CDATA[#[vars.mergedInput]]]></edifact:batch-content> </edifact:batch>`
* Ensure that the input payload sent to the Batch operation contains EDI transactions with data elements in the UNB envelope segments, such as `Sender ID`, `Receiver ID`, `Version number`. +
If the input payload contains EDI transactions with non-matching data elements in the envelope segments, the Batch operation throws an exception.

image::edifact-edi-connector-batch-flow-2.jpg[Release the batch]

For example, this implementation of a Mule flow:

* Receives an HTTP request to release accumulated EDIFACT messages transactions for a specific partner. The request is triggered once the batch release criteria are met.
* Retrieves the intermediate EDIFACT messages from the database table.
* Applies a transformation to append the individual EDIFACT messages together.
* Sends the appended payload through EDIFACT Batch operation to merge the messages into a single interchange.
* Prints the generated control numbers, which reconcile the inbound functional acknowledgments received from the partners.
* Delivers the batched EDIFACT interchange to the trading partner’s SFTP site.
