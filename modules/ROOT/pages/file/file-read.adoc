= Read a File Using the File Connector
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../../assets/images/

The File connector can read a file at any point in the flow, unlike in Mule 3, where the
transport could only read files as a result of inbound endpoint polling.

The only required parameter for the `Read` operation is `path`. This can either be the full path to the
file or a relative path to the `working directory` defined in the configuration
referenced by the `config-ref` parameter. For an example of setting a configuration, see
xref:file/file-connector.adoc#connection_settings[Connection Settings]. If no configuration is referenced,
the working directory defaults to the value of the `user.home` system property. If the system
property is not set, the connector fails to initialize.

This example reads a file using a file configuration and a relative path:

[source,xml]
----
<file:read config-ref="File_Config" path="relativePath"/>
----

This example reads a file using the full path:

[source,xml]
----
<file:read path="fullPath"/>
----

The `Read` operation returns a message with:

* The file's content as the payload.
* The file's metadata in the message attributes, mtadata such as such as name, creation time,
size, xref:file/file-documentation.adoc#LocalFileAttributes[among others].

If the file does not exist, it throws a `FILE:ILLEGAL_PATH` error. Note that the operation does not read directories.

[NOTE]
===========
The `Read` operation (as other operations that return non-void values) supports target parameters.
See xref:4.2@mule-runtime::target-variables.adoc[Mule Runtime Target Variables].
===========

== Configure a Relative Path

In a situation where numerous `Read` operations (or any other file operations) in the same Mule app
share part of their path, their base path can be extracted into a
xref:file/file-connector.adoc#connection_settings[file configuration] for better reuse.

For example, to access two files whose full paths are: `/Users/Documents/Examples/manual.txt` and
`/Users/Documents/Examples/readme.txt`, the following configuration can be defined:

[source,xml,linenums]
----
<file:config name="File_Config" >
    <file:connection workingDir="/Users/Documents/Examples" />
</file:config>
----

Then `Read` operations referencing that configuration would be:

[source,xml,linenums]
----
<flow>
    <file:read config-ref="File_Config" path="manual.txt" />

    <file:read config-ref="File_Config" path="readme.txt" />
</flow>
----

// == INCLUDE SHARED READ OP CONTENT FOR FILE, FTP, AND SFTP CONNECTORS
include::partial$common-read-operation.adoc[]

== Access Files Defined in a Mule Application

While developing Mule applications, folders and files can be saved in the
`resources` folder. Later on, when the app is deployed, those folders and files are
copied to the directory defined by the `${app.home}` property.

For example, to define a folder named `MyFiles` in the `resources` folder and a file named
`Example.txt` inside of it, this is the project structure:

image::file/project-resources.png[]

In the runtime, the path to access this file would be `${app.home}/MyFiles/Example.txt`.
To read this file, define the following config:

[source,xml,linenums]
----
<file:config name="File_Config" >
    <file:connection workingDir="${app.home}" />
</file:config>
----

Configure the `Read` operation like this:

[source,xml]
----
<file:read config-ref="File_Config" path="MyFiles/Example.txt" />
----

[WARNING]
As stated before, each time the application is deployed the contents from
`src/main/resources` folder are copied to the `${app.home}` directory. This means that changes made
to those files during runtime are lost once the application is stopped or redeployed. This is why it
is recommended to only put files in the resource folder that are needed only for reading during the
application's execution.

== File Locking

The `lock` parameter can be used to set a file system lock on the file while it is being read.
It is set to `false` by default, but when set to `true`, the connector asks the operating system to lock
the file, which prevents any other process from accessing that file while the
lock is held. Because the lock is actually provided by the host file system, its behavior might
change depending on the mounted drive and the operating system on which mule is running. Take
that into consideration before blindly relying on this lock. The lock is automatically released
when one of the following things occurs:

* The Mule flow that locked the file ends.
* The file's content has been fully read.

Note that if the file is already locked by someone else, the connector will not be able to lock
it, and the operation will throw a `FILE:FILE_LOCK` error.

An example of locking:
[source,xml]
----
<file:read config-ref="File_Config" path="relativePath" lock="true" />
----

== Modify the Output MIME Type and Encoding

The `outputEncoding` and `outputMimeType` parameters can be used to change the MIME type or the
encoding of the payload that the `Read` operation outputs. Note that this does not transform the file's
content, it just overrides the mime type or encoding information. For example:

[source,xml,linenums]
----
<file:read config-ref="File_Config" path="relativePath"
    outputEncoding="UTF-8" 
    outputMimeType="application/csv; headers=false" />
----

== Wait for a File

The `TimeBetweenSizeChecks` parameter (which works alongside the `TimeBetweenSizeCheckUnit` parameter) can
be used to safely read a file that might still be being written. When these parameters are set, the
connector performs two size checks: one when the flow reaches a point where the stream is about to be
consumed (not in the `Read` operation) and another check after the wait time set by the
aforementioned parameters. If the file's size is the same at both checks, then the stream is consumed
successfully. Otherwise, it means that the file is still being written, so the stream is not consumed and the
operation fails with an error. The time check is not done in the `read` operation because `read` returns a
lazy stream, so it makes sense to do the size check later on when the stream is about to be consumed.

Let's see an example where the `Read` operation is used with size check parameters and then
the output stream is consumed in a xref:4.2@mule-runtime::logger-component-reference.adoc[`logger` component].

[source,xml,linenums]
----
<file:read config-ref="File_Config" path=relateivePath"
    timeBetweenSizeCheck="15" 
    timeBetweenSizeCheckUnit="SECONDS">
<logger level="INFO" message="#[payload]"/>
----

Note that the 15 seconds check happens when the `logger` component executes, not at the Read operation.

//== STREAMING INCLUDE in File, FTP, and SFTP Connector docs
include::partial$common-streaming.adoc[]
