= List Files Using the File Connector
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../../assets/images/

The List operation returns an array of messages, where each message represents any file
or folder (and their attributes) found in the path pointed by the `directoryPath` parameter.
This parameter is required and represents the *relative path* of the directory you want to list.
This path is relative to the `working directory` defined in the configuration referenced by the
`config-ref` parameter. For an example of creating a configuration, see
xref:file/file-connector.adoc#connection_settings[File Connection Settings]. If no configuration is referenced,
the working directory defaults to the value of the `user.home` system property. If the system
property is not set, the connector fails to initialize.

A simple example of the `List` operation:

[source,xml]
----
<file:list config-ref="File_Config" directoryPath="relativePath" />
----

This  outputs an array of Mule messages, where the `payload` is the file's contents (or null if it is
a folder) and `attributes` corresponds to the file's (or folder's) attributes such as name, creation time,
size, xref:file/file-documentation.adoc#LocalFileAttributes[among others]. In Studio, DataSense displays 
the metadata for the operation's output:

image::file/list-output.png[]

[IMPORTANT]
========
The `List` operation lists both diretories and files, but for files it also returns a lazy stream of
the file's contents in the payload, which can then be directly consumed by other operations. This
means that you do not need to perform a
xref:file/file-read.adoc[`Read` operation] after a `List` to access the file's content. See
<<Read Files Returned by List>> for an example.
========

== Read Files Returned by List

This example lists all files and folders in the `directoryPath` and, in a
xref:4.2@mule-runtime::for-each-scope-concept.adoc[For Each loop], 
checks if each element is a file or a folder with a
xref:4.2@mule-runtime::choice-router-concept.adoc[choice component]. If it is a file,
then a xref:4.2@mule-runtime::logger-component-reference.adoc[logger] outputs its
path and contents. If it is a directory, send it to another flow for processing.

[source,xml,linenums]
----
<file:list config-ref="File_Config" directoryPath="relativePath" />

<foreach>
    <choice>
        <when expression="#[not attributes.directory]">
            <logger message="Found file #[attributes.path] whose content is: #[payload]" />
        </when>
        <otherwise>
            <flow-ref name="process-directory" />
        </otherwise>
    </choice>
</foreach>
----

Note that there is no xref:file/file-read.adoc[`Read` operation] inside the `For Each` loop because,
as mentioned before, the `List` operation already returns the file's content in the payload, but in
a lazy manner so you don't need to worry about performance or overheads when you don't end up
consuming the stream.

== Sub Folders

To list files or folders within any sub-folders of the `directoryPath`, such as a recursive list, you
can set the `recursive` parameter to true.

[source,xml]
----
<file:list config-ref="File_Config" directoryPath="relativePath" recursive="true" />
----

== Filter Files by Matching Criteria

You can use the `<file:matcher>` element to filter files based on the matching criteria you use for
accepting or rejecting a file. Here is an example of file matching rules you can use:

.Example: File Matcher
[source,xml,linenums]
----
<file:matcher
  filenamePattern="a?*.{htm,html,pdf}"
  path-pattern="a?*.{htm,html,pdf}"
  createdSince="2019-06-03T13:21:58+00:00"
  createdUntil="2019-07-03T13:21:58+00:00"
  updatedSince="2019-05-03T13:21:58+00:00"
  updatedUntil="2019-06-03T13:21:58+00:00"
  accessedSince="2019-06-03T13:21:58+00:00"
  accessedUntil="2019-06-03T13:21:58+00:00"
  directory="true|false"
  regularFile="true|false"
  symbolicLink="true|false"
  minSize="0"
  maxSize="1024" />
----

All of the attributes above are optional and are ignored if not provided. They all relate to each other under an `AND` operator.

As the next examples show, a file matcher can be a reusable element (a named top-level element), or it can be used as an inner element that is proprietary to a particular component.

=== Example: Top-level, Reusable Matcher

[source,xml,linenums]
----
<file:matcher name="smallFileMatcher" maxSize="100" />

<flow name="smallFiles">
  <file:list path="~/smallfiles" matcher="smallFileMatcher" />
  ...
</flow>
----

=== Example: Inner, Non-reusable Matcher

[source,xml,linenums]
----
<flow name="smallFiles">
	<file:list path="~/smallfiles">
        <file:matcher maxSize="100" />
	</file:list>
	...
</flow>
----

For more on the capabilities of the matcher, see the xref:file/file-documentation.adoc[File Connector Reference].

== Wait for a File

If you want to read a file's content returned by the `List` operation, but you are not sure if the file
is still being written or not, you can use the `TimeBetweenSizeChecks` parameter (which works
with the `TimeBetweenSizeCheckUnit` parameter). When enabled, Mule performs two size checks: one
when the flow reaches a *point where the stream is about to be consumed* (not in the `list` operation) and another
check after the wait time set by the aforementioned parameters. If the file's size is the same at both
checks, then the stream is consumed successfully. Otherwise, it means that the file is still being
written, so the stream is not consumed and the operation fails with an error. The time check is not done
in the `List` operation because `List` returns a lazy stream pointing to the file's content, so it makes
sense to do the size check only when the stream is about to be consumed.

For example, use the `Read` operation with size check parameters and then
consume the output stream in a xref:4.2@mule-runtime::logger-component-reference.adoc[`logger` component].

[source,xml,linenums]
----
<file:read config-ref="File_Config" 
	path="filePath" 
	timeBetweenSizeCheck="15" 
	timeBetweenSizeCheckUnit="SECONDS">
	<logger level="INFO" message="#[payload]"/>
----

Note that the 15 seconds check happens when the `logger` component executes, not at the Read operation.

//== STREAMING INCLUDE in File, FTP, and SFTP Connector docs
include::partial$common-streaming.adoc[]
