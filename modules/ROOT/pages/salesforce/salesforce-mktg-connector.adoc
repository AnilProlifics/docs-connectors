= Salesforce Marketing Cloud Connector - Mule 4
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

Support Category: https://www.mulesoft.com/legal/versioning-back-support-policy#anypoint-connectors[Select]

Salesforce Marketing Cloud Connector Version 3.0.0

Release Notes: xref:release-notes::connector/salesforce-mktg-connector-release-notes-mule-4.adoc[Salesforce Marketing Connector Release Notes]

Anypoint Connector for Salesforce Marketing Cloud (Salesforce Marketing Cloud Connector) lets you connect to the Marketing Cloud API, which is also called Salesforce Marketing Cloud. This connector exposes convenient operations for using the capabilities of Salesforce Marketing Cloud.

== Prerequisites

This document assumes that you are familiar with Salesforce Marketing Cloud, Mule, Anypoint Connectors, Anypoint Studio, Mule concepts, elements in a Mule flow, and global elements.

You need login credentials to test your connection to your target resource.

For hardware and software requirements and compatibility
information, see the connector Release Notes.

To use this connector with Maven, view the `pom.xml` dependency information in the Dependency Snippets section in Anypoint Exchange.

== What's New in this Connector

This connector version has the same operations as the 2.x versions, but groups some of them differently. Also, the connector no longer uses FuelSDK. Instead, the connector performs the SOAP requests itself.

The operations are now grouped as follows:

* The `Configure Create`, `Configure Update`, and `Configure Delete` operations are grouped into one operation called `Configure`. Use a parameter to specify the Create, Update, and Delete actions.

* The `Perform Start`, `Perform Stop`, and `Perform Get Max Count` operations are grouped into one operation called `Perform`. Use a parameter to specify the Start, Stop, Get, and Max Count actions.

The connector no longer supports the OAuth Username and Password connection provider because the Salesforce Marketing Cloud deprecated this authentication type. The connector now supports the OAuth Client Credentials authentication flow.

== To Use the Connector in Design Center

To use the connector in Design Center:

. In Design Center, click *Create*.
. Click *Create new application* to open Flow Designer.
. Specify a value for *Project name* and click *Create*.
. Click *Go straight to canvas* to exit from *Letâ€™s get started*.
. Click on the trigger card.
. Search for the connector.
. Select the connector name.
. Select the *On modified object* or *On new object* operation to use it as a source.
+
Alternatively, you can also use the HTTP Connector or Scheduler component as a source.
+
. Click *Click here to set it up*.
. To create a global element for the connector, enter values for these fields:
+
image::salesforce/salesforce-mktg-dc-choose-global-type.png[Design Center global element]
+
For information, see <<salesforce/salesforce-mktg-connector#required-parms-user-pwd,Required Parameters for Username Password>> and <<salesforce/salesforce-mktg-connector#required-oauth-parms,Required Parameters OAuth Username Password>>.
+
. Select the plus sign to add a component.
. Select the connector as a component.
. Configure these fields:
+
* Create operation:
** ObjectType - Type of API object to create
** Api Objects - Array of one or more API objects
+
image::salesforce/salesforce-mktg-3-dc-create.png[Create fields]
+
* Delete operation:
+
** ObjectType - Type of API object to delete
** Api Objects - An array of one or more API objects
+
image::salesforce/salesforce-mktg-3-dc-delete.png[Delete fields]
+
* Update operation:
+
** ObjectType - Type of API object to update
** Api Objects - Array of one or more API objects
+
image::salesforce/salesforce-mktg-3-dc-update.png[SMC-update]
+
* Upsert operation:
+
** ObjectType - Type of API object to upsert
** Api Objects - Array of one or more API objects
+
image::salesforce/salesforce-mktg-3-dc-upsert.png[SMC-upsert]
+
* Configure operation:
+
** Configurations - Array of one or more configurations to create
** Action - Create, Update, or Delete
** ObjectType - Type of configuration
+
image::salesforce/salesforce-mktg-3-dc-configure.png[DC-configure]
+
* Perform operation:
+
** Definitions - Array of one or more definitions for the Perform operation
** Action - Action to perform. Can have the value of Start, Stop or Get Max Count
** ObjectType - Type of object to do a perform on
+
image::salesforce/salesforce-mktg-3-dc-perform.png[DC-perform]
+
* Schedule Start operation:
+
** ObjectType - Type of object on which to have a schedule
** Interactions -Array of one or more interactions in the schedule operation
+
image::salesforce/salesforce-mktg-3-dc-schedule-start.png[DC-schedule-start]
+
* Retrieve operation:
+
** Query - Query describing the objects that to retrieve
+
image::salesforce/salesforce-mktg-3-dc-retrieve.png[DC-retrieve]

=== [[required-parms-user-pwd]] Required Parameters for Username Password

The Username Password authentication requires the following parameters:

* Username - Username used to initialize the session
* Password - Password used to authenticate the user
* Service Url - URL of the service on Salesforce Marketing Cloud that the connector will access
+
image::salesforce/salesforce-mktg-3-dc-user-pass-config.png[user-pass-config]

== Connect in Anypoint Studio 7

You can use this connector in Anypoint Studio by first downloading it from Exchange and configuring it as needed.

=== Install the Connector in Studio

. In Anypoint Studio, click the Exchange icon *(X)* in the Studio taskbar.
. In Anypoint Exchange, click *Login*.
. Search for this connector and click *Add to Project*.
. Follow the prompts to install this connector.

When Studio has an update, a message displays in the lower right corner,
which you can click to install the update.

=== Configure the Connector in Studio

. Drag the connector to the Studio Canvas.
. To create a global element for the connector, complete these fields:
* Username Password:
** *Username* - Username used to initialize the session
** *Password* - Password used to authenticate the
** *Service url* - The URL of the service on Salesforce Marketing Cloud to be accessed from the connector.
+
image::salesforce/salesforce-mktg-as-user-pass-config.png[user-pass-config]
+
* OAuth Client Credentials:
** *Client Id* - Client ID for the installed package
** *Client Secret(*) - Client secret for the installed package
** *Token url* - URL of the endpoint that provides the access tokens
** *Service url* - URL of the Salesforce Marketing Cloud service that the connector will access
+
image::salesforce/salesforce-mktg-3-oauth-client-credentials-config.png[user-pass-config]

=== Use Case - Creating an Object

. Create a new Mule project by clicking on File > New > Mule Project.
. Supply a name for your project and click Finish.
+
image::salesforce/salesforce-mktg-3-new-mule-project.png[New project dialog]
+
. Open `pom.xml` and under dependencies section add the following dependency for Mule Salesforce Marketing Connector, but first replace --VERSION-- with the latest version available:
+
[source,xml,linenums]
----
<dependency>
    <groupId>org.mule.connectors</groupId>
    <artifactId>mule-module-sfdc-marketing-cloud-connector</artifactId>
    <version>--VERSION--</version>
    <classifier>mule-plugin</classifier>
</dependency>
----
+
. Create the flow.

Navigate through the project's structure, double-click `src/main/app/smc-usecase-create-object.xml`, and follow the steps below:

. Search for the HTTP > Listener element in the palette.
. Drag the Listener element onto the canvas.
. Search for Transform Message and drag it after File.
. Search for Salesforce Marketing Cloud->Create entities and drag it after Transform Message.
. Add a Transform Message after Salesforce Marketing Cloud.
. Let's start configuring each element. Double-click on the Listener element.
+
image::salesforce/salesforce-mktg-3-http-listener-config.png[HTTP Listener component]
+
. Click the image:salesforce/salesforce-mktg-as-plus-button.png[plus Button] next to Connector configuration.
. Specify the Host as localhost and Port as 8081, then click OK.
. Specify the Path as /create.
. Double-click Create (Salesforce Marketing Cloud).
+
image::salesforce/salesforce-mktg-3-smc-create-config.png[SMC Create config]
+
. Click the image:salesforce/salesforce-mktg-as-plus-button.png[plus Button] next to Connector configuration.
+
image::salesforce/salesforce-mktg-3-user-pass-config.png[SMC user-pass config]
+
. Specify the required fields with the credentials for your organization, then click OK.
. From the Object type drop down choose List.
. Double-click Transform Message (the one before Create) and configure it as below:
+
image::salesforce/salesforce-mktg-3-transform-before-config.png[Transform message before]
+
. Double-click Transform Message (the one after Create) and configure it as below:
+
image::salesforce/salesforce-mktg-3-transform-after-config.png[Transform message after]
+
. Once you are done with the Mule app, you can deploy it.
. Once deployed, use a REST client to make a POST request to `+x-www-form-urlencoded to localhost:8081/create+` and the following parameter payload listName=testlist (such as `+curl -d listName=MyName-Test localhost:8081/create+`).
. You should get a successful result and once you get it, go to your instance and check that the list was created.

Note: For other entities you can use a similar flow but you have to change the Object Type in the Salesforce Marketing Cloud to the name of the object that you are going to create, and remap fields on the Transform Message component as needed. Upload and Delete could be configured in exactly the same way.

=== Use Case: XML

You can check your code against the complete application's XML representation:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:sfdc-marketing-cloud="http://www.mulesoft.org/schema/mule/sfdc-marketing-cloud"
xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
xmlns:http="http://www.mulesoft.org/schema/mule/http"
xmlns="http://www.mulesoft.org/schema/mule/core"
xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core
http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http
http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core
http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/sfdc-marketing-cloud
http://www.mulesoft.org/schema/mule/sfdc-marketing-cloud/current/mule-sfdc-marketing-cloud.xsd">
	<configuration-properties file="mule-app.properties" />
	<http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config">
		<http:listener-connection host="localhost" port="8081" />
	</http:listener-config>
	<sfdc-marketing-cloud:config name="Salesforce_Marketing_Cloud_Config" doc:name="Salesforce Marketing Cloud Config" doc:id="3e0ebd61-352b-4935-b18f-94ad8366233b" >
		<sfdc-marketing-cloud:basic-connection username="${config.username}" password="${config.password}" serviceUrl="${config.endpoint}" />
	</sfdc-marketing-cloud:config>
	<flow name="smc-usecase-create-objectFlow">
		<http:listener doc:name="Listener" config-ref="HTTP_Listener_config" path="/create"/>
		<ee:transform doc:name="Transform Message" doc:id="3609d200-e444-4370-88bb-efdf1e6acab4">
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
[{
	ListName: payload.listName
}]]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<sfdc-marketing-cloud:create doc:name="Create" config-ref="Salesforce_Marketing_Cloud_Config" objectType="List"/>
		<ee:transform doc:name="Transform Message">
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</flow>
</mule>
----

== Known Issues and Limitations

The Salesforce Marketing Cloud connector has some limitations when working with subclasses inside complex fields, trying to retrieve fields from a hierarchy, or attempting to return an Automation object.

=== Working with Subclasses inside Complex Fields

Some objects in Salesforce Marketing Cloud have complex fields, such as the Recurrence field, which belong to a base class. DataSense can only bring up fields specific to the base class.

To use additional fields that belong to a subclass of a base class, manually add the desired fields to the Transform Message component. For Salesforce Marketing Cloud to know that you want to work with a subclass and recognize the fields you added, you must also add a field called concreteClassType of type String whose value is the name of the subclass.

See <<salesforce/salesforce-mktg-connector#providing-subclass,Providing a Subclass as a Type to a Complex Field>> for an example detailing how to achieve this.

=== Retrieving Fields From a Hierarchy

The Retrieve operation allows you to retrieve records in a SQL query-like fashion. When you use the Retrieve operation, Salesforce Marketing Cloud prevents the retrieval of fields that are part of a hierarchy. For example, the Subscriber object has a complex structure:

image::salesforce/salesforce-mktg-as-subscriber-structure.png[subscriber structure]

The API only allows you to query fields on the first level, such as EmailAddress or SubscriberKey, but not fields like Attributes.Name.

=== Server Results Containing an Automation Object

Server results that contain an Automation object cause an exception to be thrown. When performing an operation, such as Create or Delete, on an Automation object, the returned result contains the structure of the Automation object you acted upon. The server also returns an additional field in the Automation object called isPlatformObject that is not recognized by the WSDL.

To bypass this issue, make all operations that directly use an Automation object asynchronous. If an operation is asynchronous, the immediate response of the operation is `Operation Queued`.

For more information, see the <<salesforce/salesforce-mktg-connector#asynchronous-operations,Asynchronous Operations>>.

== Common Use Cases

The following are the common use cases for the Salesforce Marketing Cloud connector operations:

* Configure action operation - Calls the Configure method with Create, Delete, or Update as the value of the Action parameter when connected to the Marketing Cloud API SOAP web service.
* Create entities operation - Creates new objects on the Marketing Cloud API web server.
* Delete objects operation - Deletes existing objects on the Marketing Cloud API web server.
* Perform operation - Calls the Perform method with the GetMaxCount, Start, or Stop as the value of the Action parameter when connected to the Marketing Cloud API SOAP web service.
* Retrieve entities operation - Retrieves objects from the Marketing Cloud API web server in a SQL query-like fashion.
* Schedule start operation - Calls the Schedule method with Start as the value of the Action parameter when connected to the Marketing Cloud API SOAP web service.
* Update entities operation - Updates existing objects on the Marketing Cloud API web server.
* Upsert entities operation - Creates objects on the Marketing Cloud API web server if the objects do not already exist, or deletes existing objects on the server.

=== Add a Proxy

To use a proxy server, set the following configuration properties on the advanced tab of your configuration:

image::salesforce/salesforce-mktg-3-proxy.png[Schedule Start Automation]


=== Providing a Subclass as a Type to a Complex Field

Suppose you want to schedule an existing Automation that send emails to a subscriber list once per minute. To do this, add a Schedule Reference to the connector through a flow variable:

image::salesforce/salesforce-mktg-as-schedule-start-automation.png[Schedule Start Automation]

Use the Recurrence field in ScheduleDefinition to provide information such as how much time should pass between emails sent. The Recurrence field is a complex field that has no structure.

To specify a MinutelyRecurrence instead of a Recurrence:

* Manually add the fields belonging to the MinutelyRecurrence class.

* Add an additional field called concreteClassType of type String whose value is the name of the subclass.

The mapping for the ScheduleDefinition looks like this in the example:

image::salesforce/salesforce-mktg-as-schedule-definition-transform-config.png[Schedule Definition]

This map has a field called `minuteInterval` that belongs to a subclass of Recurrence called `MinutelyRecurrence`.

For the connector to use the MinutelyRecurrence object, you must also add the concreteClassType field with `MinutelyRecurrence` as the value.

=== [[asynchronous-operations]]Asynchronous Operations

Most operations are synchronous by default, meaning that the connector waits for the result of the operation. For more details regarding the operations of the Marketing Cloud API, access the Salesforce Marketing Cloud Methods documentation.

To specify that you want an operation to behave asynchronously, use the Options parameter for the operation.

The following example creates a list of Automation objects to provide in the payload. Because the result of any operation that works directly with Automation objects throws an exception caused by the presence of an unknown field, the example uses the CreateOptions parameter to make the call asynchronous. In this example, the CreateOptions value is provided in a variable called `vars`.

image::salesforce/salesforce-mktg-as-create-automation-config.png[Create Automation]

This mapping for CreateOptions in vars looks like this:

* The requestType field determines the type of call (SYNCHRONOUS or ASYNCHRONOUS).

* The conversationID field assigns a unique identifier to the asynchronous call.

You can group asynchronous calls together using the conversationID, callsInConversation, and sequenceCode fields. For example, suppose you want to make five asynchronous calls to the server, execute the calls together, and specify their execution order. To do this:

* Assign the same conversationID to each call.

* Set the callsInConversation field to 5.

* Use the sequenceCode field to order the calls.

The following example has a single call, so it passes a value of 1 to callsInConversation and sequenceCode.

image::salesforce/salesforce-mktg-as-create-automation-options.png[CreateOptions]

The Options parameter has more functionality than shown in this example. For more information, see the Salesforce Marketing Cloud Objects documentation.

== See Also

* https://developer.salesforce.com/docs/atlas.en-us.mc-apis.meta/mc-apis/getting_started_developers_and_the_exacttarget_api.htm[Salesforce Get Started with the SOAP Web Services API]
* https://developer.salesforce.com/docs/atlas.en-us.mc-app-development.meta/mc-app-development/api-integration.htm[Salesforce API Integration].
