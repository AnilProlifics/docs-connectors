= Salesforce Composite Connector - Mule 4
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

Support Category: https://www.mulesoft.com/legal/versioning-back-support-policy#anypoint-connectors[Select]

Salesforce Composite Connector v2.3

Anypoint Connector for Salesforce Composite enables you to work with the Salesforce Batch and SObject Tree APIs. The connector exposes convenient methods for preparing subordinate requests, executing them in one batch, and parsing the results. Also it offers the posibility of creating SObject Trees through an operation separate from the batch ones, called createSobjectTree. This connector provides DataSense for preparing subordinate requests and parsing responses. DataSense is also provided for execution, and for creating SObject trees.

Release Notes: xref:release-notes::connector/salesforce-composite-connector-release-notes-mule-4.adoc[Salesforce Composite Connector Release Notes] +
Exchange: https://www.mulesoft.com/exchange/com.mulesoft.connectors/mule-salesforce-composite-connector/[Salesforce Composite Connector]

== Prerequisites

To use this information, you should be familiar with Salesforce Composite, Mule runtime engine (Mule), Anypoint Connectors, Anypoint Studio, Mule concepts, elements in a Mule flow, and Global Elements.

You need login credentials to test your connection to your target resource.

== POM File Information

[source,xml,linenums]
----
<dependency>
  <groupId>com.mulesoft.connectors</groupId>
  <artifactId>mule-salesforce-composite-connector</artifactId>
  <version>RELEASE</version>
  <classifier>mule-plugin</classifier>
</dependency>
----

Mule converts RELEASE to the latest version. To specify a version, view
https://www.mulesoft.com/exchange/com.mulesoft.connectors/mule-salesforce-composite-connector/[Salesforce Composite Connector]
in Anypoint Exchange and click *Dependency Snippets*.


== Connect in Design Center

. Click a trigger such as an HTTP Listener or Scheduler trigger.
. To create an optional global element for the connector, click Reusable Configurations. You can only use OAuth with username and password Authentication:
+
image::salesforce/salesforce-composite-choose-global-type.png[Choose OAuth with Username and Password Authentication]
+
. Select the plus sign to add a component.
. Select the connector as a component.
+
image::salesforce/salesforce-composite-create-sobject-tree-flow.png[Connector as a component]
+
. Configure these fields for the Create SObject Tree operation:
+
** SObject Root Type - The type of the root of the tree to be created.
** SObject Tree - The entire structure of the tree to be created.
+
image::salesforce/salesforce-composite-create-sobject-tree-operation.png[Create SObject Tree operation]

=== Required Parameters for the OAuth with Username and Password Configuration

* Consumer Key - The consumer key for the Salesforce connected app.
* Consumer Secret - The consumer secret for the connector to access Salesforce.
* Username - The Salesforce username.
* Password - The corresponding password.
* Security Token - The corresponding security token.
+
image::salesforce/salesforce-composite-dc-basic-auth.png[Design Center basic auth]

== Add the Connector to a Studio Project

Anypoint Studio provides two ways to add the connector to your Studio project: from the Exchange button in the Studio taskbar or from the Mule Palette view.

=== Add the Connector Using Exchange

. In Studio, create a Mule project.
. Click the Exchange icon *(X)* in the upper-left of the Studio task bar.
. In Exchange, click *Login* and supply your Anypoint Platform username and password.
. In Exchange, search for "composite".
. Select the connector and click *Add to project*.
. Follow the prompts to install the connector.

=== Add the Connector in Studio

. In Studio, create a Mule project.
. In the Mule Palette view, click *(X) Search in Exchange*.
. In *Add Modules to Project*, type "composite" in the search field.
. Click this connector's name in *Available modules*.
. Click *Add*.
. Click *Finish*.

When Studio has an update, a message displays in the lower right corner, which you can click to install the update.

=== Configure in Studio

. Drag the connector to the Studio Canvas.
. To create a global element for the connector, set these fields:
+
** OAuth with Username and Password Authentication:
+
*** Consumer Key - The consumer key for the Salesforce connected app.
*** Consumer Secret - The consumer secret for the connector to access Salesforce.
*** Username - The Salesforce username.
*** Password - The corresponding password.
*** Security Token - The corresponding security token.
+
image::salesforce/salesforce-composite-studio-basic-auth.png[Studio basic auth]

== Studio Example

* Listener(HTTP) - Accepts data from HTTP requests.
* Transform message - Transforms the HTTP input accordingly.
* Salesforce Composite Connector - Connects with Salesforce and executes the create SObject tree operation.
* Transform message - Outputs the results of the Create SObject tree operation in JSON format.
+
image::salesforce/salesforce-composite-studio-use-case.png[Studio use case]

=== XML for the Studio Example

Paste this XML code into Anypoint Studio to experiment with the flow described in the previous section.

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:salesforce-composite="http://www.mulesoft.org/schema/mule/salesforce-composite"
xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core"
   xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core
   http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http
http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core
http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/salesforce-composite
http://www.mulesoft.org/schema/mule/salesforce-composite/current/mule-salesforce-composite.xsd">
	<configuration-properties file="mule-app.properties"/>
	<http:listener-config name="HTTP_Listener_config"
   doc:name="HTTP Listener config">
		<http:listener-connection host="localhost" port="8081" />
	</http:listener-config>
	<salesforce-composite:composite-config name="Salesforce_Composite_Salesforce_Composite"
   doc:name="Salesforce Composite Salesforce Composite">
		<salesforce-composite:oauth-user-pass-connection
      consumerKey="${consumerKey}"
      consumerSecret="${consumerSecret}"
      username="${username}"
      password="${password}"
      securityToken="${securityToken}"
      tokenEndpoint="${tokenEndpoint}" />
	</salesforce-composite:composite-config>
	<flow name="salesforce-composite-create-sobject-trees">
		<http:listener doc:name="Listener"
      path="/createSObjectTree"
      config-ref="HTTP_Listener_config"/>
		<ee:transform doc:name="Transform HTTP input for Create SObject Tree">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/java
---
payload.records map ((record , indexOfRecord) -> {
	"attributes": {
		"type": record.attributes.objectType,
		"referenceId": record.attributes.referenceId
	},
	"Name": record.Name,
	"Phone": record.Phone,
	"Website": record.Website,
	"NumberOfEmployees": record.NumberOfEmployees as Number,
	("ChildAccounts": {
		"records": record.ChildAccounts.records map ((record01, indexOfRecord01) -> {
			"attributes": {
				"type": record01.attributes.objectType,
				"referenceId": record01.attributes.referenceId
			},
			"Name": record01.Name,
			"Phone": record01.Phone,
			"Website": record01.Website,
			"NumberOfEmployees": record01.NumberOfEmployees as Number
		})
	}),
	"Contacts": {
		"records": record.Contacts.records map ((record01, indexOfRecord01) -> {
			"attributes": {
				"type": record01.attributes.objectType,
				"referenceId": record01.attributes.referenceId
			},
			"LastName": record01.LastName,
			"Email": record01.Email,
			"Title": record01.Title
		})
	}
})
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<salesforce-composite:create-sobject-tree
      doc:name="Create SObject tree"
      config-ref="Salesforce_Composite_Salesforce_Composite"
      type="Account"/>
		<ee:transform doc:name="Transform Message">
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</flow>
</mule>
----

=== HTTP Input For the Studio Example

An example of HTTP input for the Studio example is:

[source,json,linenums]
----
{
   "records":[
      {
         "ChildAccounts":{
            "records":[
               {
                  "Phone":"4321098765",
                  "Website":"www.salesforce.com",
                  "attributes":{
                     "objectType":"Account",
                     "referenceId":"ref5"
                  },
                  "NumberOfEmployees":"10",
                  "Name":"ChildAccount1"
               }
            ]
         },
         "Contacts":{
            "records":[
               {
                  "Email":"sample@salesforce.com",
                  "Title":"President",
                  "attributes":{
                     "objectType":"Contact",
                     "referenceId":"ref6"
                  },
                  "LastName":"Jones"
               }
            ]
         },
         "Phone":"9876543210",
         "Website":"www.salesforce.com",
         "attributes":{
            "objectType":"Account",
            "referenceId":"ref4"
         },
         "NumberOfEmployees":"101",
         "Name":"CreateSobjectTreeAccount2"
      },
      {
         "Contacts":{
            "records":[
               {
                  "Email":"sample@salesforce.com",
                  "Title":"President",
                  "attributes":{
                     "objectType":"Contact",
                     "referenceId":"ref2"
                  },
                  "LastName":"Smith"
               },
               {
                  "Email":"sample@salesforce.com",
                  "Title":"Vice President",
                  "attributes":{
                     "objectType":"Contact",
                     "referenceId":"ref3"
                  },
                  "LastName":"Evans"
               }
            ]
         },
         "Phone":"1234567890",
         "Website":"www.salesforce.com",
         "attributes":{
            "objectType":"Account",
            "referenceId":"ref1"
         },
         "NumberOfEmployees":"100",
         "Name":"CreateSobjectTreeAccount1"
      }
   ]
}
----

== Pre-query Example

The following example provides metadata for an object to be queried, generates two sub-requests that contain this metadata, and then executes the sub-requests.  In this example:

* `HTTP Listener` initiates the flow when it detects an event in the `executeFlow` path.
* The first `Transform Message` component sets a value for the `Name` field and then passes this value to the `Pre create` operation.
* The `Pre create` operation provides metatdata for creating an object called `NewAcount`. It generates a sub-request for the `executeCompositeBatch` operation.
* The second `Transform Message` component sets values for the `ID` and `Type` fields, and then passes these values to the `Pre query` operation.
* The `Pre query` operation provides metadata for an object to be queried. It generates a sub-request for the `Execute composite batch` operation.
* The third `Transform Message` operation passes the output of the `Pre query` operation to the `Execute composite batch operation`.
* `The executeCompositeBatch` operation executes the sub-requests that the `Pre create` and `Pre query` operations created.
* The fourth `Transform Message` operation converts the output to JSON format.

=== Flow for the Pre-Query Example

The following screenshot shows the flow for the Pre-Query example:

image::salesforce/salesforce-composite-prequery-flow.png[Pre-Query Flow]

=== Create the Pre-Query Flow

Follow these steps to create the Pre-Query flow in Studio:

. In the Mule Palette view, search for *HTTP* and select the *Listener* operation.
. Drag the *Listener* operation onto the canvas.
. In the Listener properties window, set the *Path* field to `/executeFlow`.
. In the Mule Palette view, search for *Transform Message*.
. Drag the *Transform Message* component onto the canvas, to the right of *Listener*.
. Enter the name `MyNewAccount`:
+
[source,dataweave,linenums]
----
%dw 2.0
%output application/json
---
{
   Name: "MyNewAccount"
}
----
+
. In the Mule Palette view, search for *Salesforce* and select the *Salesforce Composite Pre create* operation.
. Drag the *Pre create* operation to the right of *Transform Message*.
. Click the green plus icon to the right of the *Connector configuration* field to access the Salesforce Composite global element configuration fields.
. Complete the fields using variables, as follows:
+
image::salesforce/salesforce-composite-global-config.png[Salesforce Composite global element configuration]
+
. In the Pre create properties window, enter `Account` in the *Type* field.
. In a YAML file src/main/resoures/properties/project_name_dev.yaml, declare and enter values for the variables from step 10.
. Load the YAML file as a global element.
. Drag a second *Transform Message* component to the right of *Pre create*.
. Enter the following name-value pairs:
+
[source,dataweave,linenums]
----
%dw 2.0
%output application/json
---
{
"Id": payload.Id,
"Fields" : ["Id", "Name"],
"Type": "Account"
}
----
+
. Drag a Salesforce Composite *Pre query* operation to the right of the second *Transform Message*.
. In the *Query* field, enter the following query:
+
`Select Name from Account WHERE Name LIKE '%:name %'`
+
. Drag a third *Transform Message* component to the right of *Pre query*.
. Set the output to `payload`:
+
[source,dataweave,linenums]
----
%dw 2.0
%output application/java
---
[
payload
]
----
. Drag a Salesforce Composite *Execute composite batch* operation to the right of the third *Transform Message*.
. Drag a fourth *Transform Message* component to the right of *Execute composite batch*.
. Set the output to `application/json`:
+
[source,dataweave,linenums]
----
%dw 2.0
%output application/json
---
payload
----

=== XML for the Pre-Query Example

----
<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:salesforce-composite="http://www.mulesoft.org/schema/mule/salesforce-composite" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
   xmlns:http="http://www.mulesoft.org/schema/mule/http"
   xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/salesforce-composite http://www.mulesoft.org/schema/mule/salesforce-composite/current/mule-salesforce-composite.xsd">
   <http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config" >
      <http:listener-connection host="0.0.0.0" port="8081" />
   </http:listener-config>
   <salesforce-composite:composite-config name="Salesforce_Composite_Config" doc:name="Salesforce Composite Config" >
      <salesforce-composite:oauth-user-pass-connection consumerKey="${consumerKey}" consumerSecret="${consumerSecret}" username="${username}" password="${password}" securityToken="${securityToken}" />
   </salesforce-composite:composite-config>
   <flow name="composite-prequery-exampleFlow" >
      <http:listener doc:name="Listener" config-ref="HTTP_Listener_config" path="/executeFlow"/>
      <ee:transform doc:name="Transform Message" >
         <ee:message >
            <ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
   Name: "MyNewAccount"
}]]></ee:set-payload>
         </ee:message>
      </ee:transform>
      <salesforce-composite:pre-create type="Account" doc:name="Pre create" config-ref="Salesforce_Composite_Config">
      </salesforce-composite:pre-create>
      <ee:transform doc:name="Transform Message" >
         <ee:message >
            <ee:set-payload ><![CDATA[output application/java
---
{
   "Id": payload.Id,
   "Fields" : ["Id", "Name"],
   "Type": "Account"
}]]></ee:set-payload>
         </ee:message>
      </ee:transform>
      <salesforce-composite:pre-query doc:name="Pre query" config-ref="Salesforce_Composite_Config">
         <salesforce-composite:query >Select Name from Account WHERE Name LIKE '%:name %'
                    </salesforce-composite:query>
         <salesforce-composite:parameters ><![CDATA[#[output applicaton/java
---
{
   "name" : "MyNewAccount"
}]]]></salesforce-composite:parameters>
      </salesforce-composite:pre-query>
      <ee:transform doc:name="Transform Message" >
         <ee:message >
            <ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
[
   payload
]]]></ee:set-payload>
         </ee:message>
      </ee:transform>
      <salesforce-composite:execute-composite-batch doc:name="Execute composite batch" config-ref="Salesforce_Composite_Config"/>
      <ee:transform doc:name="Transform Message" >
         <ee:message >
            <ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
         </ee:message>
      </ee:transform>
   </flow>
</mule>
----

== See Also

https://help.mulesoft.com[MuleSoft Help Center]
