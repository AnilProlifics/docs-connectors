= Socket Examples
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../../assets/images/

The Socket connector allows you to open and send or receive transport layer packages through both UDP and TCP sockets. In this section we will show you how to use the available operations considering the Transport Layer protocol you wish to implement in your application.

== Send a Message

Suppose that we have set up our Socket Listener and we want to build an application that upon receiving specific data from an external client, performs a database query and sends a message to a UDP Server Socket with the obtained results.

[source,xml,linenums]
----
	<sockets:listener-config name="Sockets_Listener_config" doc:name="Sockets Listener config">
		<sockets:tcp-listener-connection host="localhost" port="8082" >
			<sockets:protocol >
				<sockets:direct-protocol />
			</sockets:protocol>
		</sockets:tcp-listener-connection>
	</sockets:listener-config>

	<db:config name="Database_Config" doc:name="Database Config">
		<db:oracle-connection host="localhost" user="sys as sysdba" password="Oradoc_db1" serviceName="orclpdb1.localdomain" />
	</db:config>

	<sockets:request-config name="Sockets_Request_config" doc:name="Sockets Request config" >
		<sockets:udp-requester-connection host="localhost" port="8085" />
	</sockets:request-config>

	<flow name="socketSearchDatabaseAndReturnResult">
		<sockets:listener doc:name="Listener" config-ref="Sockets_Listener_config" outputMimeType="application/json"/>
		<db:select doc:name="Select" config-ref="Database_Config">
			<db:sql>#["SELECT first_name, last_name from SYSTEM.MUSICIANS where id = :id"]</db:sql>
			<db:input-parameters><![CDATA[#[{ 'id': payload.id }]]]></db:input-parameters>
		</db:select>
		<set-payload value="#[output application/json --- 'name': payload[0].FIRST_NAME as String ++ ' ' ++ payload[0].LAST_NAME as String]" doc:name="Set Payload" />
		<logger level="INFO" doc:name="Logger" message="#[payload]" />
		<sockets:send doc:name="Send" config-ref="Sockets_Request_config">
			<sockets:content ><![CDATA[#[output application/json --- payload]]]></sockets:content>
		</sockets:send>
	</flow>
----

To test this example, initialize an Oracle database using the following script.

[source,xml,linenums]
----
    CREATE TABLE SYSTEM.MUSICIANS(
        id INTEGER GENERATED BY DEFAULT AS IDENTITY,
        age INTEGER,
        first_name VARCHAR2(100),
        last_name VARCHAR2(100),
        PRIMARY KEY(id)
    );

    INSERT INTO SYSTEM.MUSICIANS(age, first_name, last_name) VALUES(37, 'Farrokh', 'Bulsara');
    INSERT INTO SYSTEM.MUSICIANS(age, first_name, last_name) VALUES(36, 'Brian Harold', 'May');
    INSERT INTO SYSTEM.MUSICIANS(age, first_name, last_name) VALUES(35, 'Roger', 'Meddows Taylor');
    INSERT INTO SYSTEM.MUSICIANS(age, first_name, last_name) VALUES(32, 'John', 'Deacon');
----

Next, start a UDP server, to which the results will be sent, at port 8085. You can do this using netcat command `nc -ul 8085`. Notice that, even though we chose UDP for this example, the Send operation can be used to send messages to both TCP and UDP sockets.

Lastly, run your mule application and start a TCP Client Socket to send the expected query parameter. You can accomplish this by using netcat command `nc localhost 8082` and sending the following data `{"id": 2}`.

== Send and Receive Messages

Because Sockets are full-duplex, they allow for bidirectional communication: you can send and receive messages simultaneously. This operation is slightly different from that, because it will first send a message and then expect a response.

This operation will:

    1) Send the data using the client associated to the RequesterConnection.
    2) Block until data is received or Timeout is met (in which case a null payload will be returned).

This operation can be used for both TCP and UDP sockets.

We will slightly modify with our previous example. Now we will add a new flow `socketSendQueryAndReceiveResult` that will connect to the Listener from the `socketSearchDatabaseAndReturnResult` flow, send the query string and wait for the response with the query result. Once the result has been received, it will be written to a file.

[source,xml,linenums]
----
	<sockets:listener-config name="Sockets_Listener_config" doc:name="Sockets Listener config" >
		<sockets:tcp-listener-connection host="localhost" port="8082" >
			<sockets:protocol >
				<sockets:direct-protocol />
			</sockets:protocol>
		</sockets:tcp-listener-connection>
	</sockets:listener-config>

	<sockets:listener-config name="Sockets_Listener_config1" doc:name="Sockets Listener config" >
		<sockets:tcp-listener-connection host="localhost" port="8085" >
			<sockets:protocol >
				<sockets:direct-protocol />
			</sockets:protocol>
		</sockets:tcp-listener-connection>
	</sockets:listener-config>

	<sockets:request-config name="Sockets_Request_config" doc:name="Sockets Request config" >
		<sockets:tcp-requester-connection host="localhost" port="8082" >
			<sockets:protocol >
				<sockets:direct-protocol />
			</sockets:protocol>
		</sockets:tcp-requester-connection>
	</sockets:request-config>

	<db:config name="Database_Config" doc:name="Database Config" >
		<db:oracle-connection host="localhost" user="sys as sysdba" password="Oradoc_db1" serviceName="orclpdb1.localdomain" />
	</db:config>

	<file:config name="File_Config" doc:name="File Config" >
		<file:connection />
	</file:config>
	<flow name="socket-testFlow">
		<sockets:listener doc:name="Listener"  config-ref="Sockets_Listener_config" outputMimeType="application/json" />
		<db:select doc:name="Select"  config-ref="Database_Config">
			<db:sql >#[&quot;SELECT first_name, last_name from SYSTEM.MUSICIANS where id = :id&quot;]</db:sql>
			<db:input-parameters><![CDATA[#[{ 'id': payload.id }]]]></db:input-parameters>
		</db:select>
		<set-payload value="#[output application/json --- 'name': payload[0].FIRST_NAME as String ++ ' ' ++ payload[0].LAST_NAME as String]" doc:name="Set Payload"  />
	</flow>

	<flow name="socketSendAndReceive">
		<sockets:listener doc:name="Listener" config-ref="Sockets_Listener_config1" outputMimeType="application/json"/>
		<sockets:send-and-receive doc:name="Send and receive"  config-ref="Sockets_Request_config" outputMimeType="application/json">
		</sockets:send-and-receive>
		<logger level="INFO" doc:name="Logger" message='#[payload]'/>
		<file:write path="musicians.txt" config-ref="File_Config" mode="CREATE_NEW">
		  <file:content><![CDATA[#[payload]
		  ]]></file:content>
		</file:write>
	</flow>
----

To test this example, use the same database setup from the previous example, run the mule application and hit the endpoint using the following netcat command: `nc localhost 8085` and send the following data `{"id":2}`.
