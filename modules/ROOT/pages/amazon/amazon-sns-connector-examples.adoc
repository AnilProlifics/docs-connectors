= Amazon SNS Examples - Mule 4
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../../assets/images/

Common use cases for the connector include the following:

* Sending SNS messages to Amazon SQS queues
* Sending Amazon SNS messages to HTTP/HTTPS endpoints

== Send SNS Messages to Amazon SQS Queues

Amazon SNS works closely with Amazon Simple Queue Service (Amazon SQS). By using Amazon SNS and Amazon SQS together, messages can be delivered to applications that:

* Require immediate notification of an event.
* Are persisted in an Amazon SQS queue for other applications to process at a later time.

When you subscribe an Amazon SQS queue to an Amazon SNS topic, you can publish a message to the topic. Amazon SNS then sends an Amazon SQS message to the subscribed queue.

Use the AWS Management Console to simplify the process of subscribing an Amazon SQS queue to an Amazon SNS topic.

== Send Amazon SNS messages to HTTP/HTTPS Endpoints

You can use Amazon SNS to send notification messages to one or more HTTP or HTTPS endpoints. When you subscribe an endpoint to am Amazon SNS topic, you can publish a notification to the topic. Amazon SNS then sends an HTTP POST request that delivers the contents of the notification to the subscribed endpoint.

== Example: Use the Connector to Send SNS Messages to Amazon SQS Queues

The following diagram shows the flows for this example:

image::amazon/amazon-sns-use-case-flow.png[Sending messages to SQS Queue]

To configure a Mule app that uses the connector to send Amazon SNS messages to Amazon SQS queues:

. Create a new Mule project in Anypoint Studio.
. Add the following properties to the `mule-artifact.properties` file. This file holds your Amazon SNS and SQS credentials and places them in the project's `src/main/app` directory.
+
[source,text,linenums]
----
sqs.accesskey=<Access Key>
sqs.secretkey=<Secret Key>
sns.topic.arn=<SNS Topic ARN>
sqs.queueName=<SQS Queue Name>
sqs.queueUrl=<SQS Queue URL>
----
+
. In the Mule Palette, search for *HTTP*, select the *Listener* operation, and drag it to the canvas.
. In the HTTP connector configuration *General* tab, set the *Display Name* field to `HTTP` and the *Path* field to`/''.
. Click *+* next to the *Connector Configuration* field, and then set the *Port* field to `8081`.
+
. In the Mule Palette, search for *SNS*, select the *Publish* operation, and drag it next to the *HTTP Listener* component.
. Click + next to the *Connector configuration* field to add a global element.
. Configure the global element as follows:
+
[%header%autowidth.spread]
|===
|Parameter |Description|Value
|*Name* |Name used to reference the configuration. |<Configuration_Name>
|*Access Key* |Alphanumeric text string that uniquely identifies the user who owns the account. |`${config.accesskey}`
|*Secret Key* |Key that plays the role of a password. |`${config.secretkey}`
|*Region Endpoint* |Queue reqion | Select the queue region.
|*Globally Defined Default Topic ARN* |Topic ARN to test the connectivity. |`${sns.topic.arn}`
|===
+
Your configuration should look like this:
+
image::amazon/amazon-sns-use-case-config.png[sns use case config]
+
Select the *Configuration XML* tab to view the corresponding XML, which should look like this:
+
[source,xml]
----
<sns:config name="HTTP" doc:name="Amazon SNS configuration"
  doc:id="e175499e-80b9-45a3-8fd0-dcaabba23f37"
  defaultTopicArn="${sns.topic.arn}" >
<sns:basic-connection accessKey="${config.accesskey}"
  secretKey="${config.secretkey}" />
</sns:config>
----
+
. Select the *Global Elements* tab.
. Select the *Amazon SNS configuration (Configuration)* and click *Edit*.
. Click *Test Connection* to confirm that Mule can connect with the SNS instance.
** If the connection is successful, click *OK* to save the configurations.
** Otherwise, review or correct any incorrect parameters, and test again.
. Go back to the flow, select *Publish*, and configure the remaining parameters:
+
[%header%autowidth.spread]
|===
|Parameter |Value
2+|*Basic Settings*
|*Display Name* |`Publish` or any other name you prefer.
|*Connector Configuration*|`Amazon_SNS_Configuration` (the reference name to the global element you created).
2+|*General*
|*Topic arn* |`${sns.topic.arn}` or any other topic arn.
|*Message* |`Hello World!``
|*Subject* |`Testing publish to queue`
|*Message structure* |`JSON`
|===
+
image::amazon/amazon-sns-publish-message-to-flow.png[publish message connector props]
+
. Check that the XML looks like this:
+
[source,xml]
----
<sns:config name="Amazon_SNS_configuration"
  doc:name="Amazon SNS configuration"
  doc:id="8867751d-d56e-4717-94e7-5affaca35bc8"
  defaultTopicArn="${sns.topic.arn}" >
<sns:basic-connection accessKey="${config.accesskey}"
  secretKey="${config.secretkey}" />
</sns:config>
----

=== Print the Data Processed by the Publish Operation

In the same same example, add a *Logger* component to print to the Mule console the data processed by the *Publish* operation.

. In the Mule Palette, search for *Logger*, and drag next to the *Amazon SNS* connector.
. Configure the *Logger* component as follows:
+
[%header%autowidth.spread]
|===
|Parameter |Value
|*Display Name* |`Logger` (or any other name you prefer)
|*Message* |`#[payload]`
|*Level* |`INFO`
|===
+
image::amazon/amazon-sns-logger.png[sns logger]

=== Add a Flow to Receive SNS Messages

In the same example, add a second flow that enables Amazon SQS to receive messages published by Amazon SNS:

. In the Mule Palette, search for *Flow* and drag the *Flow* component to the canvas.
. In the Mule Palette, search for *SQS*, select the *Receivemessages* operation, and drag it to the left of the *Flow* component.
. Select the new component.
. Click *+* next to the *Connector configuration* field to add a new Amazon SQS connector global element.
. Configure the global element as follows:
+
[%header%autowidth.spread]
|===
|Parameter |Description|Value
|Name |Enter a name for the configuration to reference it. |<Configuration_Name>
|Access Key |Alphanumeric text string that uniquely identifies the user who owns the account. |`${sqs.accesskey}`
|Secret Key |Key that plays the role of a password. |`${sqs.secretkey}`
|Default Global Queue URL |Set the queue URL |`${sqs.queueUrl}`.
|Region Endpoint |Queue region
|===
+
Your configuration should look like this:
+
image::amazon/amazon-sns-sqs-config.png[sns-sqs-config]
+
The corresponding XML configuration should be as follows:
+
[source,xml]
----
<sqs:config name="Amazon_SQS_Configuration"
  doc:name="Amazon SQS Configuration"
  doc:id="cc8793e7-97fa-4d25-8618-13bd94166a25"
  defaultQueueUrl="${sqs.queueUrl}" >
<sqs:basic-connection accessKey="${sqs.accesskey}"
  secretKey="${sqs.secretkey}"
  region="us-east-1" />
</sqs:config>
----
+
Make sure the SQS queue in the configuration is subscribed to the SNS topic.
+
. Click *Test Connection* to confirm that Mule can connect with the SQS instance:
** If the connection is successful, click *OK* to save it.
** If the connection is not successful, review or correct any incorrect parameters, and then test again.
. In the properties editor of the Amazon SQS connector, configure the remaining parameters:
+
[%header%autowidth.spread]
|===
|Parameter |Value
2+|Basic Settings
|Display Name |`Amazon SQS (Streaming)`, or any other name you prefer.
|Connector configuration*|`Amazon_SQS_Configuration` (the reference name to the global element you have created).
|Other fields in the *General* group | Default values
|===
+
. Check that your XML looks like this:
+
[source,xml]
----
<sqs:receivemessages
  doc:name="Amazon SQS (Streaming)"
  doc:id="e5fb3873-ed78-4661-8664-7f74e69492d5"
  config-ref="Amazon_SQS_Configuration"/>
----
+
. Add a *Logger* scope after the Amazon SQS connector to print the data passed by the *Receive* operation in the Mule Console. Configure the *Logger* as follows:
+
[%header%autowidth.spread]
|===
|Parameter |Value
|Display Name |`Display Message`, or any other name you prefer
|Message |'Received Message: #[payload]`
|Level |`INFO`
|===
+
. Save the project.

To run the project as a Mule app:

. Right-click the project in Package Explorer, and select *Run As > Mule Application*.
. Open a web browser and check the response after entering the URL `+http://localhost:8081/`0.
+
The logger displays the published message ID on the browser and the received message on the Mule console.

[[example-code]]
=== Demo Mule Application XML Code

Paste this code into your XML Editor to quickly load the flow for this example use case into your Mule application.

[source,xml,linenums]
----
?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns:sqs="http://www.mulesoft.org/schema/mule/sqs" xmlns:json="http://www.mulesoft.org/schema/mule/json" xmlns:sns="http://www.mulesoft.org/schema/mule/sns" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:spring="http://www.springframework.org/schema/beans"  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/json http://www.mulesoft.org/schema/mule/json/current/mule-json.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/sqs http://www.mulesoft.org/schema/mule/sqs/current/mule-sqs.xsd
http://www.mulesoft.org/schema/mule/sns http://www.mulesoft.org/schema/mule/sns/current/mule-sns.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd">
    <http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config" doc:id="2f2020bd-1c87-4671-a78e-3ae32c66bf12" >
    <http:listener-connection host="0.0.0.0" port="8081" />
    </http:listener-config>
    <sqs:config name="Amazon_SQS_Configuration" doc:name="Amazon SQS Configuration" doc:id="2451f982-6863-4b66-9d52-e7cf3ec91e9f" >
            <sqs:basic-connection accessKey="${sqs.accessKey}" secretKey="${sqs.secretKey}" defaultQueueName="${sqs.queueName}"/>
    </sqs:config>
    	<sns:config name="Amazon_SNS_configuration" doc:name="Amazon SNS configuration" doc:id="ID_VALUE >
    		<sns:basic-connection accessKey="${sns.accesskey}" secretKey="${sns.secretkey}" />
    	</sns:config>
   <sqs:config name="Amazon_SQS_Configuration" doc:name="Amazon SQS Configuration" doc:id="9465aae5-eafb-4df9-89ae-2f19eed3fcaf" defaultQueueUrl="${sqs.queueUrl}" >
		<sqs:basic-connection accessKey="${sqs.accesskey}" secretKey="${sqs.secretkey}" region="us-east-1" />
	</sqs:config>
	<flow name="xmltestFlow" doc:id="e3d4a83b-a72f-45ec-bcd4-1e5faca36386" >
		<sqs:receivemessages doc:name="Receivemessages" doc:id="a0d24628-2b42-4947-9ce5-ae849156912f" config-ref="Amazon_SQS_Configuration"/>
	</flow>
	<flow name="publish_message_to_topic" >
        <http:listener config-ref="HTTP_Listener_Configuration" path="/" doc:name="HTTP"/>
        <sns:publish config-ref="Amazon_SNS_Configuration" doc:name="Publish message to topic">
          <sns:publish topicArn="${sns.topic.arn}"  message="Hello world!" subject="Testing publish to queue"/>
          </sns:publish>
          <logger message="#[payload]" level="INFO" doc:name="Logger" />
   </flow>
   <flow name="receive_message_from_queue">
        <sqs:receivemessages config-ref="Amazon_SQS_Configuration" doc:name="Receivemessages" doc:id="89a27fe8-8253-4b9b-8123-7dda6a82ca0a" />
   		<logger level="INFO" doc:name="Logger" doc:id="87ddd552-28da-4b59-966e-9fbc9ec8a184" message="#[payload]"/>
   </flow>
</mule>
----

== See Also
* https://forums.mulesoft.com[MuleSoft Forum]
* https://support.mulesoft.com/s/knowledge[Knowledge Base Articles]
