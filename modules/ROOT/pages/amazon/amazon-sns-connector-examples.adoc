= Amazon SNS Examples - Mule 4
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../../assets/images/

Amazon SNS works closely with Amazon Simple Queue Service (Amazon SQS). By using Amazon SNS and Amazon SQS together, messages can be:

* Delivered to apps that require immediate notification of an event.
* Persisted in an Amazon SQS queue for other applications to process at a later time.

When you subscribe an Amazon SQS queue to an Amazon SNS topic, you can publish a message to the topic. When you do this, Amazon SNS sends an Amazon SQS message to the subscribed queue.

You can subscribe an Amazon SQS queue to an Amazon SNS topic using the AWS Management Console for Amazon SQS, which simplifies the process.

You can also use Amazon SNS to send notification messages to one or more HTTP or HTTPS endpoints. When you subscribe an endpoint to a topic, you can publish a notification to the topic and Amazon SNS sends an HTTP POST request delivering the contents of the notification to the subscribed endpoint.

The following example shows how to:

* <<send_to_queues>>

[[send_to_queues]]
== Send Amazon SNS messages to Amazon SQS queues

image::amazon/amazon-sns-use-case-flow.png[Sending messages to SQS Queue]

. Create a new Mule Project in Anypoint Studio.
. Add the following properties to the `mule-artifact.properties` file. This file holds your Amazon SNS and SQS credentials and places them in the project's `src/main/app` directory.
+
[source,text,linenums]
----
sqs.accesskey=<Access Key>
sqs.secretkey=<Secret Key>
sns.topic.arn=<SNS Topic ARN>
user can select specific region by using the dropdown.
by default the region will be taken as US_EAST1

sqs.queueName=<SQS Queue Name>
user can select specific region by using the dropdown.
sqs.queueUrl=<SQS Queue URL>
----
+
. Click on a Mule *HTTP Connector*, select the *Listener* operation, and drag it to the beginning of the flow.
. Configure the following parameters:
+
image::amazon/amazon-sns-http-props.png[sns http config props]
+
[%header%autowidth.spread]
|===
|*Parameter* |Value
|*Display Name* |HTTP
|*Extension Configuration* | If no HTTP element has been created yet, click the plus sign to add a new HTTP Listener Configuration and click OK (Fill 0.0.0.0 for Host and 8081 for port).
|*Path* |`/`
|===
+
. Click on the Amazon SNS Connector, select the *Publish* operation, and it to the HTTP endpoint component.
. Click the plus sign next to the *Connector Configuration* field to add a Global Element. Configure the Global Element as follows:
+
[%header%autowidth.spread]
|===
|Parameter |Description|Value
|*Name* |Enter a name for the configuration to reference it. |<Configuration_Name>
|*Access Key* |Alphanumeric text string that uniquely identifies the user who owns the account. |`${config.accesskey}`
|*Secret Key* |Key that plays the role of a password. |`${config.secretkey}`
|*Region Endpoint* |Set the queue reqion | User can select the Region by using dropdown.
|*Topic Arn* |Topic ARN to test the connectivity. |`${sns.topic.arn}`
|===
+
Your configuration should look like this:
+
image::amazon/amazon-sns-use-case-config.png[sns use case config]
+
The corresponding XML configuration is:
+
[source,xml]
----
<sns:config name="Amazon_SNS_configuration" doc:name="Amazon SNS configuration"
doc:id="f85b91a1-661e-4bf4-80c7-997107acda08">
<sns:basic-connection
  accessKey="${config.accessKey}"
  secretKey="${config.secretKey}"
  testTopicArn="${sns.topic.arn}" />
</sns:config>
----
+
. Click *Test Connection* to confirm that Mule can connect with the SNS instance.
** If the connection is successful, click *OK* to save the configurations.
** Otherwise, review or correct any incorrect parameters, and test again.
. In the properties editor of the Amazon SNS connector, configure the remaining parameters:
+
[%header%autowidth.spread]
|===
|Parameter |Value
2+|*Basic Settings*
|*Display Name* |`Publish` or any other name you prefer
|*Connector Configuration*|`Amazon_SNS_Configuration` (the reference name to the global element you have created).
|*Operation* | `publish`
2+|*General*
|*Define attributes* |Select to define the Publish attributes
|*Topic Arn* |`${sns.topic.arn}` (or any other topic arn).
|*Message* |Hello World!
|*Subject* |Testing publish to queue.
|===
+
image::amazon/amazon-sns-publish-message-to-flow.png[publish message connector props]
+
. Check that the XML looks like this:
+
[source,xml]
----
<sns:publish config-ref="Amazon_SNS_configuration" doc:name="Publish" doc:id="b0c5158d-6f3f-44be-9153-3c6d9dd870f2" >
    <sns:publish-details message="Hello World!" subject="Testing publish to queue" topicArn="${sns.topic.arn}"/>
</sns:publish>
----

==== Print the Data Processed by the Publish Operation

In the same same example, add a *Logger scope* to print the data processed by the Publish operation in the Mule Console.

. Drag a Logger scope after the Amazon SNS connector in the palette.
. Configure the Logger as follows:
+
[%header%autowidth.spread]
|===
|Parameter |Value
|*Display Name* |`Logger` (or any other name you prefer)
|*Message* |Message ID: `#[payload]`
|*Level* |`INFO`
|===
+
image::amazon/amazon-sns-logger.png[sns logger]

=== Add a Flow to Receive SNS Messages

In the same example, add a second flow to receive messages published by SNS:

. Drag a Flow scope onto the palette.
. Drag the Amazon SQS Connector > ReceiveMessages in the left side of the new flow
. Click the plus sign next to the Connector Configuration field to add a new Amazon SQS Global Element.
.Configure the global element as follows:
+
[%header%autowidth.spread]
|===
|Parameter |Description|Value
|Name |Enter a name for the configuration to reference it. |<Configuration_Name>
|Access Key |Alphanumeric text string that uniquely identifies the user who owns the account. |`${sqs.accesskey}`
|Secret Key |Key that plays the role of a password. |`${sqs.secretkey}`
|Queue Name |Set the name of the queue. |`${sqs.queueName}`
|Queue URL |Set the queue URL |`${sqs.queueUrl}`
|Region Endpoint |Set the queue reqion| user can select the Region by using dropdown.
|===
+
** Your configuration should look like this (Queue URL can be skipped if Queue Name is specified):
+
image::amazon/amazon-sns-sqs-config.png[sns-sqs-config]
+
** The corresponding XML configuration should be as follows:
+
[source,xml]
----
<sqs:config name="Amazon_SQS_Configuration"
  accessKey="${sqs.accesskey}"
  secretKey="${sqs.secretkey}"
  doc:name="Amazon SQS: Configuration"
  defaultQueueName="${sqs.queueName}"
  url="${sqs.queueUrl}"/>
----
+
Make sure SQS-Queue that you mentioned in configuration should be subscribed to SNS-Topic.
+
. Click Test Connection to confirm that Mule can connect with the SQS instance. If the connection is successful, click OK to save the configurations. Otherwise, review or correct any incorrect parameters, then test again.
. Back in the properties editor of the Amazon SQS connector, configure the remaining parameters:
+
[%header%autowidth.spread]
|===
|Parameter |Value
2+|Basic Settings
|Display Name |Amazon SQS (Streaming) (or any other name you prefer).
|Connector Configuration|Amazon_SQS_Configuration (the reference name to the global element you have created).
|Other fields in the group General | Default values
|===
+
. Check that your XML looks like:
+
[source,xml]
----
<sqs:receivemessages config-ref="Amazon_SQS_Configuration" doc:name="Receivemessages" doc:id="ID_VALUE" />
----
+
. Add a Logger scope after the Amazon SQS connector to print the data that is being passed by the Receive operation in the Mule Console. Configure the Logger according to the table below.
+
[%header%autowidth.spread]
|===
|Parameter |Value
|Display Name |Display Message (or any other name you prefer)
|Message |Received Message : `#[payload]`
|Level |INFO
|===
+
. Save and run the project as a Mule Application. Right-click the project in Package Explorer. Run As > Mule Application.
. Open a web browser and check the response after entering the URL `+http://localhost:8081/+`. The logger  displays the published message ID on the browser and the received message on the mule console.

[[example-code]]
=== Demo Mule Application XML Code

Paste this code into your XML Editor to quickly load the flow for this example use case into your Mule application.

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns:sqs="http://www.mulesoft.org/schema/mule/sqs" xmlns:json="http://www.mulesoft.org/schema/mule/json" xmlns:sns="http://www.mulesoft.org/schema/mule/sns" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:spring="http://www.springframework.org/schema/beans"  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/json http://www.mulesoft.org/schema/mule/json/current/mule-json.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/sqs http://www.mulesoft.org/schema/mule/sqs/current/mule-sqs.xsd
http://www.mulesoft.org/schema/mule/sns http://www.mulesoft.org/schema/mule/sns/current/mule-sns.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd">
    <http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config" doc:id="ID_VALUE" >
    <http:listener-connection host="0.0.0.0" port="8081" />
    </http:listener-config>
    <sqs:config name="Amazon_SQS_Configuration" doc:name="Amazon SQS Configuration" doc:id="ID_VALUE" >
            <sqs:basic-connection accessKey="${sqs.accessKey}" secretKey="${sqs.secretKey}" defaultQueueName="${sqs.queueName}"/>
    </sqs:config>
    	<sns:config name="Amazon_SNS_configuration" doc:name="Amazon SNS configuration" doc:id="ID_VALUE >
    		<sns:basic-connection accessKey="${sns.accesskey}" secretKey="${sns.secretkey}" />
    	</sns:config>
   <flow name="publish_message_to_topic" >
        <http:listener config-ref="HTTP_Listener_Configuration" path="/" doc:name="HTTP"/>
        <sns:publish config-ref="Amazon_SNS_Configuration" doc:name="Publish message to topic">
          <sns:publish topicArn="${sns.topic.arn}"  message="Hello world!" subject="Testing publish to queue"/>
          </sns:publish>
          <logger message="#[payload]" level="INFO" doc:name="Logger" />
   </flow>
   <flow name="receive_message_from_queue">
        <sqs:receivemessages config-ref="Amazon_SQS_Configuration" doc:name="Receivemessages" doc:id="ID_VALUE" />
   		<logger level="INFO" doc:name="Logger" doc:id="ID_VALUE" message="#[payload]"/>
   </flow>
</mule>
----

== See Also
* https://forums.mulesoft.com[MuleSoft Forum]
* https://support.mulesoft.com/s/knowledge[Knowledge Base Articles]
