= Amazon DynamoDB Examples - Mule 4
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../../assets/images/

The following are common use cases for the Amazon DynamoDB connector:

* Create a DynamoDB table
* Perform a DynamoDB scan operation

[[create-table]]
== Create a DynamoDB Table

This example shows how to use Amazon DynamoDB connector to create an Amazon DynamoDB table.

=== Flow for Creating a DynamoDB Table

The following screenshot shows the Anypoint Studio flow for creating an amazon DynamoDB table:

image::amazon/amazon-dynamodb-create-table-flow.png[Creating a table in Amazon DynamoDB]

=== Steps for Creating an Amazon DynamoDB Table

To create an Amazon DynamoDB table:

. Create a new Mule project in Studio.
. Add the following properties to the `mule-artifact.properties` file to hold your Amazon DynamoDB credentials:
+
[source,text,linenums]
----
config.accesskey=<Access Key>
config.secretkey=<Secret Key>
----
+
. Place the `mule-artifact.properties` file in the project's `src/main/resources` directory.

=== Configure HTTP Listener

Configure `HTTP Listener` to listen for HTTP requests on the `/createtable` path:

. In the *Mule Palette* view, search for *HTTP* and select the *Listener* operation.
. Drag the *Listener* operation onto the canvas.
. In the Listener properties window, click the green plus sign next to the Connector configuration field to create a global element for `HTTP Listener`.
. In the *Host* field, enter `localhost` and click *OK*.
. Set the *Path* field to `/createtable`:
+
image::amazon/amazon-dynamodb-http-props.png[DynamoDB HTTP configuration properties]

=== Configure the Create Table Operation

Configure the `Create Table` operation to create a table named xxx

. In the *Mule Palette* view, search for *Amazon DynamoDB* and select the *Create Table* operation.
. Drag the *Create Table* operation to the right of *Listener* on the Studio canvas.
. Click the green plus sign to the right of the *Connector configuration* field to create a global element for Amazon DynamoDB Connector.
. Complete the following fields:
+
[%header,cols="30s,40a,30a"]
|===
|Parameter |Description |Value
|Name |Configuration name |`<Configuration_Name>`
|Access Key |Alphanumeric text string that uniquely identifies the user who owns the account |`${config.accesskey}`
|Secret Key |Key that acts as a password |`${config.secretkey}`
|Region Endpoint |Region for the Amazon DynamoDB client |By default, `USEAST1`
|===
+
The corresponding XML configuration should be as follows:
+
[source,xml,linenums]
----
<dynamodb:config name="Amazon_DynamoDB_Configuration1" doc:name="Amazon DynamoDB Configuration" >
  <dynamodb:basic-connection
  	accessKey="${config.accesskey}"
	  secretKey="${config.secretkey}"
  />
</dynamodb:config>
----
+
. Click *Test Connection* to confirm that Mule can connect with the DynamoDB instance:
* If the connection is successful, click *OK* to save the configurations.
* If the connection is unsuccessful, review or correct any incorrect parameters, and then test again.
. Click *OK*.
. In the properties editor configure the following fields:
+
[%header,cols="30s,70a"]
|===
|Field |Description
|Table name | The name of the table
|Attribute definitions | An array of attributes that describe the key schema for the table and its indexes
|Key schemas | The attributes that make up the primary key for the table or one of its indexes
|Read capacity units |5 - The maximum number of strongly consistent reads per second
|Write Capacity Units |5 - The maximum number of writes consumed per second
|Global Secondary Indexes |This specifies a completely different key structure for a table.
|Local Secondary Indexes |This can be only add on tables with composite primary keys.
|Stream View Type |Determines what information is written to the stream for this table when an item in the table is modified
|Stream Enabled |Indicates whether DynamoDB Streams is enabled on the table
|===
+
For example:
+
image::amazon/amazon-dynamodb-create-table-info.png[Create table info properties]
+
. To add *Global Secondary Indexes*, add a variable before the *Create Table* operation in the following format:
+
[source,xml,linenums]
----
<set-variable value='#[[
            {
                "IndexName": "CreateDateIndex",
                "Projection": {
                    "ProjectionType": "ALL"
                },
                "ProvisionedThroughput": {
                    "WriteCapacityUnits": 5,
                    "ReadCapacityUnits": 5
                },
                "KeySchema": [
                    {
                        "KeyType": "HASH",
                        "AttributeName": "CreateDate"
                    },
                    {
                    	"KeyType": "RANGE",
                    	"AttributeName": "IssueId"
                    }
                ]
            } as Object {
            	class: "org.mule.extension.dynamodb.api.model.GlobalSecondaryIndex"
            },
            {
                "IndexName": "TitleIndex",
                "Projection": {
                    "ProjectionType": "ALL"
                },
                "ProvisionedThroughput": {
                    "WriteCapacityUnits": 5,
                    "ReadCapacityUnits": 5
                },
                "KeySchema": [
                    {
                        "KeyType": "HASH",
                        "AttributeName": "Title"
                    },
                    {
                    	"KeyType": "RANGE",
                    	"AttributeName": "IssueId"
                    }
                ]
            } as Object {
            	class: "org.mule.extension.dynamodb.api.model.GlobalSecondaryIndex"
            },
            {
                "IndexName": "DueDateIndex",
                "Projection": {
                    "ProjectionType": "ALL"
                },
                "ProvisionedThroughput": {
                    "WriteCapacityUnits": 5,
                    "ReadCapacityUnits": 5
                },
                "KeySchema": [
                    {
                        "KeyType": "HASH",
                        "AttributeName": "DueDate"
                    }
                ]
            } as Object {
            	class: "org.mule.extension.dynamodb.api.model.GlobalSecondaryIndex"
            }
        ]]' doc:name="Secondary" doc:id="cfcce18a-85c2-40ee-89fd-f8d5b5e64198" variableName="secondary"/>
----

=== Configure a Logger

Configure a `Logger` component to print in the Mule console the response generated by the `Create Table` operation.

. Drag a *Logger* component to the right of *Create Table* on the Studio canvas.
. Configure the *Logger* as follows :
+
[%header,cols="30s,70a"]
|===
|Parameter |Value
|Display Name |Display name for the Logger.
|Message |`#[payload]`
|Level |INFO
|===
+
image::amazon/amazon-dynamodb-create-table-logger-props.png[dynamodb create table logger]

=== Run the Project

Save and run the project as a Mule app:

. In Package Explorer, right-click the project and click *Run As* > *Mule Application*.
. Open a browser and check the response after you enter the `+http://localhost:8081/createtable+` URL.
+
You should see the generated response from the *Create Table* operation in the Mule console.

=== XML for the Create Table Example

The XML for the Create Table example should look like this:

[source,xml,linenums]
----
<flow name="create-table-flow" doc:id="476809d5-a493-4938-8237-c1d98a5615fa" >
	<http:listener doc:name="Listener" doc:id="55e7d489-6cc7-4035-bae0-61015810d0a3" config-ref="HTTP_Listener_config" path="/createtable"/>
		<set-variable value='#[[
            {
                "IndexName": "CreateDateIndex",
                "Projection": {
                    "ProjectionType": "ALL"
                },
                "ProvisionedThroughput": {
                    "WriteCapacityUnits": 5,
                    "ReadCapacityUnits": 5
                },
                "KeySchema": [
                    {
                        "KeyType": "HASH",
                        "AttributeName": "CreateDate"
                    },
                    {
                    	"KeyType": "RANGE",
                    	"AttributeName": "IssueId"
                    }
                ]
            } as Object {
            	class: "org.mule.extension.dynamodb.api.model.GlobalSecondaryIndex"
            },
            {
                "IndexName": "TitleIndex",
                "Projection": {
                    "ProjectionType": "ALL"
                },
                "ProvisionedThroughput": {
                    "WriteCapacityUnits": 5,
                    "ReadCapacityUnits": 5
                },
                "KeySchema": [
                    {
                        "KeyType": "HASH",
                        "AttributeName": "Title"
                    },
                    {
                    	"KeyType": "RANGE",
                    	"AttributeName": "IssueId"
                    }
                ]
            } as Object {
            	class: "org.mule.extension.dynamodb.api.model.GlobalSecondaryIndex"
            },
            {
                "IndexName": "DueDateIndex",
                "Projection": {
                    "ProjectionType": "ALL"
                },
                "ProvisionedThroughput": {
                    "WriteCapacityUnits": 5,
                    "ReadCapacityUnits": 5
                },
                "KeySchema": [
                    {
                        "KeyType": "HASH",
                        "AttributeName": "DueDate"
                    }
                ]
            } as Object {
            	class: "org.mule.extension.dynamodb.api.model.GlobalSecondaryIndex"
            }
        ]]' doc:name="Global Secondary Indexes" doc:id="cfcce18a-85c2-40ee-89fd-f8d5b5e64198" variableName="secondary"/>
		<dynamodb:create-table doc:name="Create table" doc:id="25acd10b-8aa9-49d6-bec4-caefc95e6488" config-ref="Amazon_DynamoDB_Configuration" tableName="Issues" readCapacityUnits="5" writeCapacityUnits="5" globalSecondaryIndexes="#[vars.secondary]"
		>
		<dynamodb:attribute-definitions >
			<dynamodb:attribute-definition attributeName="IssueId" attributeType="STRING" />
			<dynamodb:attribute-definition attributeName="Title" attributeType="STRING" />
			<dynamodb:attribute-definition attributeName="CreateDate" attributeType="STRING" />
			<dynamodb:attribute-definition attributeName="DueDate" attributeType="STRING" />
		</dynamodb:attribute-definitions>
		<dynamodb:key-schemas >
			<dynamodb:key-schema-element attributeName="IssueId" keyType="HASH" />
			<dynamodb:key-schema-element attributeName="Title" keyType="RANGE" />
		</dynamodb:key-schemas>
	</dynamodb:create-table>
	<logger level="INFO" doc:name="Logger" doc:id="31c595ac-01e3-4da2-b6f3-e44aa7bb0c7f" message="#[payload]"/>
</flow>
----

=== XML Flow

The XML flow for the Create Table example looks like this:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http"
xmlns:dynamodb="http://www.mulesoft.org/schema/mule/dynamodb"
xmlns="http://www.mulesoft.org/schema/mule/core"
xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core
http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/dynamodb
http://www.mulesoft.org/schema/mule/dynamodb/current/mule-dynamodb.xsd
http://www.mulesoft.org/schema/mule/http
http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">
    <configuration-properties file="mule-artifact.properties" />
	<dynamodb:config
		name="Amazon_DynamoDB_Configuration"
		doc:name="Amazon DynamoDB Configuration">
		<dynamodb:basic-connection
			accessKey="${config.accesskey}"
			secretKey="${config.secretkey}" />
	</dynamodb:config>
	<http:listener-config
		name="HTTP_Listener_config"
		doc:name="HTTP Listener config">
		<http:listener-connection host="localhost"
		port="8081" />
	</http:listener-config>
	<flow name="create-table-flow">
		<http:listener
			doc:name="Listener"
			config-ref="HTTP_Listener_config"
			path="/createtable"/>
		<dynamodb:create-table doc:name="Create table"
		config-ref="Amazon_DynamoDB_Configuration"
		tableName="StudentData"
		readCapacityUnits="5" writeCapacityUnits="5">
			<dynamodb:attribute-definitions >
				<dynamodb:attribute-definition
					attributeName="studentId"
					attributeType="N" />
			</dynamodb:attribute-definitions>
			<dynamodb:key-schemas >
				<dynamodb:key-schema-element
					attributeName="studentId"
					keyType="HASH" />
			</dynamodb:key-schemas>
		</dynamodb:create-table>
		<logger level="INFO" doc:name="Logger" message="#[payload]"/>
	</flow>
	<flow name="delete-table-flow">
		<http:listener
			doc:name="Listener"
			config-ref="HTTP_Listener_config"
			path="/delete"/>
		<dynamodb:delete-table doc:name="Delete table"
		config-ref="Amazon_DynamoDB_Configuration" tableName="StudentData"/>
		<logger level="INFO" doc:name="Logger" message="#[payload]"/>
	</flow>
</mule>
----

[[scan-operation]]
== Perform a Scan

This example shows how to use Amazon DynamoDB connector to perform an Amazon DynamoDB scan.

=== Flow for Performing a Scan

The following screenshot shows the Studio flow for creating performing an Amazon DynamoDB scan:

image::amazon/amazon-dynamodb-scan-operation.png[Creating a table in Amazon DynamoDB]

=== Steps for Performing a Scan

. Drag the Amazon DynamoDB Connector *Scan* operation next to the HTTP Listener component.
. Only required field in *Scan* operation is *table name*
. Add Transform Message after *Scan* operation in order to transform response to json
+
image::amazon/amazon-dynamodb-to-json.png[Tranform response to json format]
+
. Add a Logger component after the Amazon DynamoDB *Transform Message* operation to print the response that is generated by the *Scan* operation in the Mule Console.
. The response should look like this (other items are removed for brevity)

[source,xml,linenums]
----
{
  "scannedCount": 2,
  "lastEvaluatedKey": null,
  "count": 2,
  "consumedCapacity": null,
  "items": [
    {
      "studentID": {
        "ss": null,
        "nullvalue": null,
        "b": null,
        "bool": null,
        "ns": null,
        "l": null,
        "m": null,
        "n": null,
        "bs": null,
        "s": "102"
      },
      ...
  ]
}

----

=== Important Notes for the Scan Operation

The DynamoDB AWS SDK paginates results by dividing them into specific pages. The 1MB limit applies to returned results. When this limit is exceeded, you must perform another scan to gather the rest of the data.

To do perform a subsequent scans, apply the value of the *LastEvaluatedKey* field to the *ExclusiveStartkey* field. The *LastEvaluatedKey* value becomes null, the operation has completed all pages of data.

== Migration information

Changes from version *1.3.0* to *1.4.0* include the following:

- Added TLS configuration into the connector.
- Upgraded `aws-java-sdk` from 1.11.604 to 1.11.649
- Upgraded `aws-connector-commons` from 2.0.2 to 2.2.0



== See Also

* https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/Welcome.html[Amazon API documentation]
* xref:introduction/introduction-to-anypoint-connectors.adoc[Introduction to Anypoint Connectors]
* https://help.mulesoft.com[MuleSoft Help Center]
