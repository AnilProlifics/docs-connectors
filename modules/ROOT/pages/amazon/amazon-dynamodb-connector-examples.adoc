= Amazon DynamoDB Examples - Mule 4
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../../assets/images/

The following are common use cases for the Amazon DynamoDB connector:

* Create Table
* Using Scan operation returns one or more items

[[create-table]]
== Use Case: Create table in Amazon DynamoDB

image::amazon/amazon-dynamodb-create-table-flow.png[Creating a table in Amazon DynamoDB]

. Create a new Mule project in Anypoint Studio.
. Add the following properties to the `mule-artifact.properties` file to hold your Amazon DynamoDB credentials and place it in the project's `src/main/resources` directory.
+
[source,text,linenums]
----
config.accesskey=<Access Key>
config.secretkey=<Secret Key>
----
+
. Drag an HTTP Listener component onto the canvas and configure the following parameters:
+
image::amazon/amazon-dynamodb-http-props.png[DynamoDB HTTP configuration properties]
+
[%header,cols="30s,70a"]
|===
|Parameter |Value
|Display Name |Listener
|Extension Configuration a| If an HTTP Listener configuration has not been created: 

. Click the plus sign to add a new HTTP Listener Configuration. 
. For *Host*, use `localhost`, and for *Port*, use `8081`.
. Click *OK*.
|Path |`/createtable`
|===
+
. Drag the Amazon DynamoDB Connector *Create Table* operation next to the HTTP Listener component.
. Add a new Amazon DynamoDB Global Element to configure the Amazon DynamoDB connector: +
Click the plus sign *+* next to the Connector Configuration field.
. Configure the global element as follows:
+
[%header,cols="30s,40a,30a"]
|===
|Parameter |Description |Value
|Name |Enter a name for the configuration for the connector to reference. |`<Configuration_Name>`
|Access Key |Enter the alphanumeric text string that uniquely identifies the user who owns the account. |`${config.accesskey}`
|Secret Key |Enter the key that serves the role of a password. |`${config.secretkey}`
|Region Endpoint |Region to be select from drop down for the Amazon DynamoDB Client. |By default USEAST1
|===
+
Your configuration should look like this:
+
image::amazon/amazon-dynamodb-conf-global.png[DynamoDB use case configuration]
+
The corresponding XML configuration should be as follows:
+
[source,xml,linenums]
----
<dynamodb:config name="Amazon_DynamoDB_Configuration1" doc:name="Amazon DynamoDB Configuration" >
  <dynamodb:basic-connection 
  	accessKey="${config.accesskey}" 
	secretKey="${config.secretkey}" />
</dynamodb:config>
----
+
+
. Click *Test Connection* to confirm that Mule can connect with the DynamoDB instance. If the connection is successful, click *OK* to save the configurations. Otherwise, review or correct any incorrect parameters, then test again.
. In the properties editor of the Amazon DynamoDB *Create Table* operation, configure the remaining parameters:
+
[%header,cols="30s,70a"]
|===
|Parameter |Value
|Display Name |Enter the display name to use for the Create Table operation.  
2+|Basic Settings
|Extension Configuration |Enter the configuration name you used in the global element for the connector to reference. 
2+|General
|TableName | The name for the table. 
|AttributeDefinitions | This value is an array of attributes that describe the key schema for the table and indexes.
|KeySchema | This value specifies the attributes that make up the primary key for a table or an index.
|ReadCapacityUnits |5 - The maximum number of strongly consistent reads per second.
|Write Capacity Units |5 - The maximum number of writes consumed per second.
|Global Secondary Indexes |This specifies a completely different key structure for a table.
|Local Secondary Indexes |This can be only add on tables with composite primary keys.
|Stream View Type |When an item in the table is modified, Stream View Type determines what information is written to the stream for this table.
|Stream Enabled |Indicates whether DynamoDB Streams is enabled (true) or disabled (false) on the table.
|===
+
image::amazon/amazon-dynamodb-create-table-info.png[Create table info properties]
+
. In order to add *Global Secondary Indexes* you can add *variable* before *Create Table* operation in the form
+
[source,xml,linenums]
----
<set-variable value='#[[
            {
                "IndexName": "CreateDateIndex",
                "Projection": {
                    "ProjectionType": "ALL"
                },
                "ProvisionedThroughput": {
                    "WriteCapacityUnits": 5,
                    "ReadCapacityUnits": 5
                },
                "KeySchema": [
                    {
                        "KeyType": "HASH",
                        "AttributeName": "CreateDate"
                    },
                    {
                    	"KeyType": "RANGE",
                    	"AttributeName": "IssueId"
                    }
                ]
            } as Object {
            	class: "org.mule.extension.dynamodb.api.model.GlobalSecondaryIndex"
            },
            {
                "IndexName": "TitleIndex",
                "Projection": {
                    "ProjectionType": "ALL"
                },
                "ProvisionedThroughput": {
                    "WriteCapacityUnits": 5,
                    "ReadCapacityUnits": 5
                },
                "KeySchema": [
                    {
                        "KeyType": "HASH",
                        "AttributeName": "Title"
                    },
                    {
                    	"KeyType": "RANGE",
                    	"AttributeName": "IssueId"
                    }
                ]
            } as Object {
            	class: "org.mule.extension.dynamodb.api.model.GlobalSecondaryIndex"
            },
            {
                "IndexName": "DueDateIndex",
                "Projection": {
                    "ProjectionType": "ALL"
                },
                "ProvisionedThroughput": {
                    "WriteCapacityUnits": 5,
                    "ReadCapacityUnits": 5
                },
                "KeySchema": [
                    {
                        "KeyType": "HASH",
                        "AttributeName": "DueDate"
                    }
                ]
            } as Object {
            	class: "org.mule.extension.dynamodb.api.model.GlobalSecondaryIndex"
            }
        ]]' doc:name="Secondary" doc:id="cfcce18a-85c2-40ee-89fd-f8d5b5e64198" variableName="secondary"/>
----
. Verify that your XML looks like this:
+
[source,xml,linenums]
----
<flow name="create-table-flow" doc:id="476809d5-a493-4938-8237-c1d98a5615fa" >
	<http:listener doc:name="Listener" doc:id="55e7d489-6cc7-4035-bae0-61015810d0a3" config-ref="HTTP_Listener_config" path="/createtable"/>
		<set-variable value='#[[
            {
                "IndexName": "CreateDateIndex",
                "Projection": {
                    "ProjectionType": "ALL"
                },
                "ProvisionedThroughput": {
                    "WriteCapacityUnits": 5,
                    "ReadCapacityUnits": 5
                },
                "KeySchema": [
                    {
                        "KeyType": "HASH",
                        "AttributeName": "CreateDate"
                    },
                    {
                    	"KeyType": "RANGE",
                    	"AttributeName": "IssueId"
                    }
                ]
            } as Object {
            	class: "org.mule.extension.dynamodb.api.model.GlobalSecondaryIndex"
            },
            {
                "IndexName": "TitleIndex",
                "Projection": {
                    "ProjectionType": "ALL"
                },
                "ProvisionedThroughput": {
                    "WriteCapacityUnits": 5,
                    "ReadCapacityUnits": 5
                },
                "KeySchema": [
                    {
                        "KeyType": "HASH",
                        "AttributeName": "Title"
                    },
                    {
                    	"KeyType": "RANGE",
                    	"AttributeName": "IssueId"
                    }
                ]
            } as Object {
            	class: "org.mule.extension.dynamodb.api.model.GlobalSecondaryIndex"
            },
            {
                "IndexName": "DueDateIndex",
                "Projection": {
                    "ProjectionType": "ALL"
                },
                "ProvisionedThroughput": {
                    "WriteCapacityUnits": 5,
                    "ReadCapacityUnits": 5
                },
                "KeySchema": [
                    {
                        "KeyType": "HASH",
                        "AttributeName": "DueDate"
                    }
                ]
            } as Object {
            	class: "org.mule.extension.dynamodb.api.model.GlobalSecondaryIndex"
            }
        ]]' doc:name="Global Secondary Indexes" doc:id="cfcce18a-85c2-40ee-89fd-f8d5b5e64198" variableName="secondary"/>
		<dynamodb:create-table doc:name="Create table" doc:id="25acd10b-8aa9-49d6-bec4-caefc95e6488" config-ref="Amazon_DynamoDB_Configuration" tableName="Issues" readCapacityUnits="5" writeCapacityUnits="5" globalSecondaryIndexes="#[vars.secondary]"
		>
		<dynamodb:attribute-definitions >
			<dynamodb:attribute-definition attributeName="IssueId" attributeType="STRING" />
			<dynamodb:attribute-definition attributeName="Title" attributeType="STRING" />
			<dynamodb:attribute-definition attributeName="CreateDate" attributeType="STRING" />
			<dynamodb:attribute-definition attributeName="DueDate" attributeType="STRING" />
		</dynamodb:attribute-definitions>
		<dynamodb:key-schemas >
			<dynamodb:key-schema-element attributeName="IssueId" keyType="HASH" />
			<dynamodb:key-schema-element attributeName="Title" keyType="RANGE" />
		</dynamodb:key-schemas>
	</dynamodb:create-table>
	<logger level="INFO" doc:name="Logger" doc:id="31c595ac-01e3-4da2-b6f3-e44aa7bb0c7f" message="#[payload]"/>
</flow>
----
+
. Add a *Logger* component after the Amazon DynamoDB Create Table operation to print the response that is generated by the Create Table operation in the Mule Console. Configure the Logger as follows:
+
[%header,cols="30s,70a"]
|===
|Parameter |Value
|Display Name |Enter the display name for the Logger.
|Message |`#[payload]`
|Level |INFO
|===
+
image::amazon/amazon-dynamodb-create-table-logger-props.png[dynamodb create table logger]
+
. Save and run the project as a Mule application: +
In Package Explorer, right-click the project and click *Run As* > *Mule Application*.
. Open a browser and check the response after you enter the `+http://localhost:8081/createtable+` URL. You should see the generated response from the Create Table operation in the Mule console.

=== XML Flow

XML flow for the DynamoDB create and delete table in Anypoint Studio:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http"
xmlns:dynamodb="http://www.mulesoft.org/schema/mule/dynamodb"
xmlns="http://www.mulesoft.org/schema/mule/core"
xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core
http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/dynamodb
http://www.mulesoft.org/schema/mule/dynamodb/current/mule-dynamodb.xsd
http://www.mulesoft.org/schema/mule/http
http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">
    <configuration-properties file="mule-artifact.properties" />
	<dynamodb:config 
		name="Amazon_DynamoDB_Configuration" 
		doc:name="Amazon DynamoDB Configuration">
		<dynamodb:basic-connection 
			accessKey="${config.accesskey}" 
			secretKey="${config.secretkey}" />
	</dynamodb:config>
	<http:listener-config 
		name="HTTP_Listener_config" 
		doc:name="HTTP Listener config">
		<http:listener-connection host="localhost" 
		port="8081" />
	</http:listener-config>
	<flow name="create-table-flow">
		<http:listener 
			doc:name="Listener" 
			config-ref="HTTP_Listener_config" 
			path="/createtable"/>
		<dynamodb:create-table doc:name="Create table"
		config-ref="Amazon_DynamoDB_Configuration"
		tableName="StudentData"
		readCapacityUnits="5" writeCapacityUnits="5">
			<dynamodb:attribute-definitions >
				<dynamodb:attribute-definition 
					attributeName="studentId" 
					attributeType="N" />
			</dynamodb:attribute-definitions>
			<dynamodb:key-schemas >
				<dynamodb:key-schema-element 
					attributeName="studentId" 
					keyType="HASH" />
			</dynamodb:key-schemas>
		</dynamodb:create-table>
		<logger level="INFO" doc:name="Logger" message="#[payload]"/>
	</flow>
	<flow name="delete-table-flow">
		<http:listener 
			doc:name="Listener" 
			config-ref="HTTP_Listener_config" 
			path="/delete"/>
		<dynamodb:delete-table doc:name="Delete table"
		config-ref="Amazon_DynamoDB_Configuration" tableName="StudentData"/>
		<logger level="INFO" doc:name="Logger" message="#[payload]"/>
	</flow>
</mule>
----

== Migration information

Changes from version *1.3.0* to *1.4.0* include the following:

- Added TLS configuration into the connector.
- Upgraded `aws-java-sdk` from 1.11.604 to 1.11.649
- Upgraded `aws-connector-commons` from 2.0.2 to 2.2.0



== See Also

* https://help.mulesoft.com[MuleSoft Help Center]
* https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/Welcome.html[Amazon API documentation]
