= Amazon SQS Examples - Mule 4
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../../assets/images/

== Example

This example sends a message with metadata to an Amazon SQS queue and then receives it from the queue. This example is split into the two flows:

. The first flow sends a message with metadata. Then it gets the count of the messages in the queue to validate that the message was sent.
. The second flow receives the message and logs the message body.

image::amazon/amazon-sqs-send-message-flow.png[Send Message Operation Flow]

image::amazon/amazon-sqs-receive-message-flow.png[Receive and Delete Message Operation Flow]

Before you try the example, access Studio, and check to see if the Mule Palette displays entries for Amazon SNS and Amazon SQS. If not, follow the instructions in install the Connector in Studio Using Exchange to install both connectors.

== Create a Flow to Send a Message

Start the flow by sending a message to the queue:

. Create a new Mule project in Anypoint Studio.
. In the Mule Palette, search for *HTTP*, and select the *Listener* operation:
+
image:amazon/amazon-sqs-select-listener.png[select-listener]
+
. Drag the *Listener* operation onto the canvas.
. In the *Listener* configuration, click *+* next to the *Connector configuration* field to add a global element.
. Accept the defaults.
. Set the *Path* field to `/`.
+
image::amazon/amazon-sqs-http-props.png[http-properties]

=== Add a Transform Message Component to Attach the Metadata

. In the Mule Palette, search for *Transform Message*.
+
image::amazon/amazon-sqs-select-transform.png[select-transform]
+
. Drag the *Transform Message* component onto the canvas, to the right of the *Listener*.
. In the *Transform Message* configuration, overlay the brackets in the *Output* section with this XML:
+
[source,dataweave,linenums]
----
{
	delaySeconds: 0,
	body: "Hello World",
	messageAttributes: {
		"AccountId": {
			"stringValue" : "000123456",
			"dataType" : "String.AccountId"
		} as Object {
			class: "org.mule.extension.sqs.api.model.MessageAttributeValue"
		},
		"NumberId": {
			"stringValue" : "230.000000000000000001",
			"dataType" : "Number"
		} as Object {
			class : "org.mule.extension.sqs.api.model.MessageAttributeValue"
		}
	} as Object {
		class: "java.util.HashMap"
	}
} as Object {
	class: "org.mule.extension.sqs.api.model.Message"
}
----
+
image::amazon/amazon-sqs-transform-message.png[transform-message]

=== Add and Configure the SQS Send Message Operation

. In the Mule Palette, search for *SQS* and select the *Send message* operation.
+
image::amazon/amazon-sqs-select-send.png[select-send-message]
+
. Drag the *Send message* operation onto the canvas, to the right of the *Transform Message* component.
. In the *Send message* configuration, click *+* next to the *Connector configuration* field to add a global element.
. Configure the global element as follows:
+
[%header%autowidth.spread]
|===
|Field |Value
|Name |Name used to reference the configuration.
|Access Key|Alphanumeric text string that uniquely identifies the user who owns the account.
|Secret Key |Key that plays the role of a password.
|Region endpoint | Queue region
|===
+
For example:
+
image::amazon/amazon-sqs-send-global-config.png[send-global-config]
+
. Select the *Configuration XML* tab to view the corresponding XML:
+
[source,dataweave,linenums]
----
<sqs:config name="Amazon_SQS_Configuration"
  doc:name="Amazon SQS Configuration"
	defaultQueueUrl="${sqs.queueUrl}">
	<sqs:basic-connection accessKey="${sqs.accessKey}"
	secretKey="${sqs.secretKey}"
	region="us-east-1"/>
</sqs:config>
----
+
. Configure the Following fields on the properties window:
+
[%header%autowidth.spread]
|===
|Field |Value
|Display Name |Enter a name for the connector operation.
|Connector Configuration |Select the global configuration you just created.
|Message |`#[payload]`
|Queue url |Enter the queue URL, if you did not enter a default queue URL in the global element.
|===
+
For example:
+
image::amazon/amazon-sqs-send-message.png[send-message]

=== Add a Logger Component to Display the Response in the Mule Console

. In the Mule Palette, search for *Logger*.
. Drag the component onto the canvas, next to the *Send Message* component.
. Configure the following fields:
+
[%header%autowidth.spread]
|===
|Field |Value
|Display Name |Enter a name for the logger, such as `Log Response`.
|Message |Sent Message: `#[payload]`
|Level |INFO (Default)
|===
+
For example:
+
image::amazon/amazon-sqs-logger.png[logger]

=== Obtain the Number of Messages in the Queue

. In the Mule Palette, search for *Amazon SQS*.
. Select the *Get approximate number of messages* operation and drag it onto the canvas, next to the *Logger* component.
+
. Configure the following fields on the properties window:
+
[%header%autowidth.spread]
|===
|Field |Value
|Display Name |Enter a name for the connector operation.
|Connector Configuration |Select the global configuration you created previously for the Amazon SQS connector.
|Message |`#[payload]`
|Queue url |Enter the queue URL.
|===
+
For example:
+
image::amazon/amazon-sqs-get-message-count.png[get-message-count]

=== Add a Logger to Display the Number in the Mule Console

. In the Mule Palette, search for *Logger*.
. Drag the component onto the canvas, next to the *Get Count of Messages in queue* component.
. Configure the following fields:
+
[%header%autowidth.spread]
|===
|Field |Value
|Display Name |Enter a name for the logger, such as `Log Count`.
|Message |Approx. messages in queue: `#[payload]`
|Level |INFO (Default)
|===
+
For example:
+
image::amazon/amazon-sqs-logger2.png[log-message-count]

== Create a Flow to Receive Messages

Now create another flow to receive messages and log them before deleting them from the queue.

. In the Mule Palette, search for *SQS* and select the *Receivemessages* operation.
+
image::amazon/amazon-sqs-select-receive.png[select-send-message]
+
. Drag the *Receivemessages* operation onto the canvas.
. Configure the following fields in the properties window:
+
[%header%autowidth.spread]
|===
|Field |Value
|Display Name |Enter a name for the connector operation.
|Connector Configuration |Select the global configuration you created previously for the Amazon SQS connector.
|Number of Messages |10
|Queue url |
|===
+
NOTE: If provided, the value of the *Queue URL* field takes precedence over the *Global Element Properties Queue URL* field value.
+
For example:
+
image::amazon/amazon-sqs-receive-message-config.png[select-send-message]
+
. Add a *Logger* to display the message in the Mule Console:
+
[%header%autowidth.spread]
|===
|Field |Value
|Display Name |Enter a name of your choice.
|Message |#[payload]
|Level |INFO (Default)
|===


=== Studio XML Editor

For this code to work in Anypoint Studio, you must provide Amazon Web Services credentials.  You can either replace the variables with their values in the code, or you can provide the values for each variable in the `src/main/resources/mule-artifact.properties file`.


[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:sqs="http://www.mulesoft.org/schema/mule/sqs"
  xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
  http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
  http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
  http://www.mulesoft.org/schema/mule/sqs http://www.mulesoft.org/schema/mule/sqs/current/mule-sqs.xsd">
	<http:listener-config name="HTTP_Listener_config"
	doc:name="HTTP Listener config"  >
	<http:listener-connection host="0.0.0.0" port="8081" />
	</http:listener-config>
	<sqs:config name="Amazon_SQS_Configuration"
	doc:name="Amazon SQS Configuration" defaultQueueUrl="${sqs.queueURL}">
	<sqs:basic-connection accessKey="${sqs.accessKey}"
	secretKey="${sqs.secretKey}" region="us-east-1"/>
	</sqs:config>
	<flow name="sqs-send-message-flow"  >
	<http:listener doc:name="Listener"
	config-ref="HTTP_Listener_config" path="/"/>
	<ee:transform doc:name="Transform Message"  ">
	<ee:message >
	<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
	delaySeconds: 0,
	body: "Hello World",
	messageAttributes: {
		"AccountId": {
			"stringValue" : "000123456",
			"dataType" : "String.AccountId"
		} as Object {
			class: "org.mule.extension.sqs.api.model.MessageAttributeValue"
		},
		"NumberId": {
			"stringValue" : "230.000000000000000001",
			"dataType" : "Number"
		} as Object {
			class : "org.mule.extension.sqs.api.model.MessageAttributeValue"
		}
	} as Object {
		class: "java.util.HashMap"
	}
} as Object {
	class: "org.mule.extension.sqs.api.model.Message"
}

]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<sqs:send-message doc:name="Send message" config-ref="Amazon_SQS_Configuration">
			<sqs:message ><![CDATA[#[#[payload]]]]></sqs:message>
		</sqs:send-message>
		<logger level="INFO" doc:name="Log Response" message="Sent Message: `#[payload]`"/>
		<sqs:get-approximate-number-of-messages doc:name="Get approximate number of messages"
		queueUrl="http://queue-url.com" config-ref="Amazon_SQS_Configuration"/>
		<logger level="INFO" doc:name="Log Count"  message="Approx. messages in queue: `#[payload]`"/>
	</flow>
	<flow name="sqs-receive-message-flow" >
		<sqs:receivemessages doc:name="Receivemessages" numberOfMessages="10" queueUrl="${sqs.queueName}"
		config-ref="Amazon_SQS_Configuration"/>
	</flow>
</mule>

----


== See Also
* https://forums.mulesoft.com[MuleSoft Forum]
