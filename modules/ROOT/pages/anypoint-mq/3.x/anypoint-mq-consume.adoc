= Anypoint MQ Consume Operation - Mule 4
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

The `consume` operation in the Anypoint MQ connector provides the ability to consume a single message at any time of the flow, from any destination, using the acknowledgment strategy that supports your use case.

== Incoming Message Structure

Every consumed message consists of two parts:

* `payload` - Represents the value of the received message body
* `attributes` - Contains metadata regarding the received message, such as the message properties, or its ID.

image::anypoint-mq/3.x/amq-3x-consume-attributes.png[Anypoint MQ Message Attributes]


== Consume a Message

The simplest declaration to consume a message from a queue is to drag the *Consume* operation from the Mule palette to the canvas and configure the `Queue` parameter with the name of the queue from which to retrieve the message:

image::anypoint-mq/3.x/amq-3x-consume-operation.png[Anypoint MQ Consume Operation]

For example:

[source,xml,linenums]
----
<anypoint-mq:consume config-ref="Anypoint_MQ_config" destination="myQueue"/>
----

The Consume operation in this example consumes the first available message in `myQueue` and converts it to a `MuleMessage` with this structure:

* The message's body as payload.
* The message's metadata in the message attributes. Attributes might include the `messageId` or the `redeliveryCount`.

TIP: Use a DataWeave expression in the `Queue` parameter to dynamically change the target queue from which to consume the message.


== Consumed Message Acknowledgment

* *Automatic*
+
By default, the `acknowledgementMode` used is `IMMEDIATE`, meaning that the message is acknowledged as soon as it is consumed from the queue and before it's delivered to the Mule flow. If the message acknowledgment fails, the `Consume` operation terminates with an `ANYPOINT-MQ:ACKING` error.
+
For more information, see xref:anypoint-mq/3.x/anypoint-mq-ack.adoc#immediate-acknowledgment[Immediate Acknowledgment].

* *Manual*
+
To manually control the acknowledgment of the message, change the `acknowledgementMode` to `MANUAL`. When using the `MANUAL` acknowledgment mode, the app logic decides when to perform the acknowledgment of the message, using the xref:anypoint-mq/3.x/anypoint-mq-ack.adoc[ACK] or xref:anypoint-mq/3.x/anypoint-mq-ack.adoc[NACK] operations.
+
To perform the manual acknowledgment, save the value of the `ackToken` provided as part of the resulting message attributes.
+
For more information, see xref:anypoint-mq/3.x/anypoint-mq-ack.adoc#manual-acknowledgment[Manual Acknowledgment].

For information on acknowledgment timeouts, see xref:anypoint-mq/3.x/anypoint-mq-ack.adoc#acknowledgment-timeout[Acknowledgment Timeout].

== Manage Empty Queues

When consuming a message from a queue, either the queue has messages, or it is empty.

The first scenario is the most common: a queue has messages waiting to be consumed. When the `Consume` operation executes, it returns immediately with one of the messages.

If a queue is empty, you can decide how the operation behaves:

* Immediate Response on Empty Queue
+
Set the `pollingTime` parameter to `0`, the `Consume` operation returns immediately without any error and produces a `null` message as the result when the queue is empty.

* Wait for New Messages
+
Set the `pollingTime` parameter to a value ranging from 1 to 20 seconds to cause the `Consume` operation to wait for a message to arrive. In this case, `Consume` waits for a new message to arrive for the time specified by `pollingTime`. If no message is received within the given time window, this operation fails with an `ANYPOINT-MQ:TIMEOUT` error.

By default, the `Consume` operation waits for 10 seconds for a new message to arrive when consuming from an empty queue. Consume fails if no message arrives in that timeframe.


== Output Message Metadata

Each message received consists of two parts: `Payload` and `Attributes`. `Attributes` contains the metadata for the message.

This metadata maps all the information available in an Anypoint MQ message, including:

* Message ID
* Headers Map
* Properties Map

image::anypoint-mq/3.x/amq-3x-consume-attributes.png[Anypoint MQ Message Attributes]

For information about the `attributes` structure, see the Consume operation in the xref:anypoint-mq/3.x/anypoint-mq-connector-reference.adoc#consume[Anypoint MQ Connector Reference - 3.x].

== See Also

* xref:anypoint-mq/3.x/anypoint-mq-ack.adoc[Anypoint MQ ACK and NACK Operations]
