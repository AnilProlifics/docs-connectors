= Anypoint MQ ACK and NACK Operations
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]


== Acknowledgment Configurations

The Anypoint MQ connector provides three acknowledgment configurations: Immediate, Automatic, and Manual.

=== Immediate Acknowledgment

To acknowledge messages as your app consumes them, before processing them, set the `acknowledgementMode` to `IMMEDIATE` either in the Subscriber or Consume operations.

Acknowledging the message automatically when it's received means that the message isn't redelivered if an error occurs during message processing. To handle errors without losing messages, use a dead letter queue.

If an error occurs while trying to acknowledge the message using `IMMEDIATE` mode, an `ANYPOINT-MQ:ACKING` error is thrown.

=== Automatic Acknowledgment

To acknowledge a received message automatically only if the flow execution completes successfully, set the `acknowledgementMode` to `AUTO` in the Subscriber operation.

If an error occurs during the flow execution, causing its execution to terminate prematurely, the message is NACKed and returns to the queue for redelivery.

=== Manual Acknowledgment

The `MANUAL` acknowledgment mode delegates all responsibility to the app logic to decide when to acknowledge the message, using the ACK or NACK operations.

With this configuration, every message received by either the Subscriber or Consume operations has an `ackToken` value available in the message attributes that identifies this message uniquely for a given connection.

Save this `ackToken` to use later as input to the ACK or NACK operations.

=== Acknowledgment Timeout

When using either `AUTO` or `MANUAL` acknowledgment modes, you can use the `acknowledgementTimeout` parameter to control how long the message remains in-flight waiting to be acknowledged, before automatically returning to the queue.

By default, the connector honors the time defined at the queue level (*Message Lock Default TTL* value) in the Anypoint Platform MQ console.

When using an `acknowledgementTimeout`, consider expected app-time processing, including time for unexpected delays, such as external systems delay and app back-pressure due to high load. For example, if you expect the consumed message to be processed in 10 seconds, set the `acknowledgementTimeout` to a minimum of 15 seconds.

==== Acknowledgment Timeout with AUTO Acknowledge

After a subscriber consumes a message, a timer starts, indicating how long the message has been in-flight for the broker waiting for acknowledgment. If the flow processing does not end with a success or failure before the `acknowledgementTimeout` limit is reached, the message automatically returns to the queue for redelivery.

==== Acknowledgment Timeout with MANUAL Acknowledge

When consuming a message using `MANUAL` acknowledgment mode in the Subscriber or Consume operations, the app must execute either an ACK or NACK operation using the message `ackToken` before the `acknowledgementTimeout` limit is reached. If neither operation executes with the given token before the timeout, the message automatically returns to the queue for redelivery. Any attempt to acknowledge the message after the timeout limit fails due to an expired token.

== Manual Acknowledgment Using the ACK Operation

Acknowledging a message informs the broker that the message has been processed and must be removed from the queue to prevent redelivery.

The acknowledgment token is a unique identifier for the message that you must use when performing the ACK operation. It is available in the `ackToken` field of the message attributes. For example:

[source,xml,linenums]
----
<flow name="consumerWithManualAck">
    <scheduler>
        <scheduling-strategy >
          <fixed-frequency />
        </scheduling-strategy>
    </scheduler>

    <!-- Consume a message -->
    <anypoint-mq:consume destination="${destination}"
         acknowledgementMode="MANUAL"
            config-ref="Anypoint_MQ_Config"/>

    <!-- Save the ackToken for future acknowledgment -->
    <set-variable variableName="currentAckToken"
       value="#[attributes.ackToken]"/>

    <!-- Do the required processing of the message -->
    <flow-ref name="process-message"/>

    <!-- Use the ackToken to acknowledge the message -->
    <anypoint-mq:ack ackToken="#[vars.currentAckToken]"
         config-ref="Anypoint_MQ_Config" />
</flow>
----

If a non-void operation is invoked during message processing, the payload and attributes of the Mule message are modified. To perform an ACK operation after processing, you must save the `ackToken` in a variable.

To save attributes to use later, use the `target` and `targetValue` parameters to store the whole message in a variable:

[source,xml,linenums]
----
<flow name="consumerWithManualAck">
      <scheduler>
        <scheduling-strategy >
          <fixed-frequency />
        </scheduling-strategy>
      </scheduler>

    <!-- Consume a message -->
    <anypoint-mq:consume destination="${destination}"
        acknowledgementMode="MANUAL"
        config-ref="Anypoint_MQ_Config"
        target="mqMessage"
        targetValue="#[message]"/>


    <!--Do any message processing-->
    <jms:publish-consume destination="#[vars.mqMessage.attributes.targetDestination]"
        config-ref="JMS_Config">
        <jms:message>
            <jms:body>#[vars.mqMessage.payload]</jms:body>
        </jms:message>
    </jms:publish-consume>

    <!-- Use the ackToken to ACK the message -->
    <anypoint-mq:ack ackToken="#[vars.mqMessage.attributes.ackToken]"
        config-ref="Anypoint_MQ_Config" />
</flow>
----

=== Execute a NACK

Not-Acknowledging a message informs the broker that the message was not processed successfully and must return to the queue for redelivery to any available consumer.

The acknowledgment token is a unique identifier for the message that you must use when performing the NACK operation. It is available in the `ackToken` field of the message attributes. For example:


[source,xml,linenums]
----
<flow name="consumerWithManualAck">
    <scheduler>
      <scheduling-strategy >
        <fixed-frequency />
      </scheduling-strategy>
    </scheduler>

    <!-- Consume a message -->
    <anypoint-mq:consume destination="${destination}"
           acknowledgementMode="MANUAL"
           config-ref="Anypoint_MQ_Config"
           target="mqMessage"
          targetValue="#[message]"/>

    <!--Do message processing -->
    <logger message="#[payload]"/>

    <!-- Use the ackToken to NACK the message -->
    <anypoint-mq:nack ackToken="#[vars.mqMessage.attributes.ackToken]"
    config-ref="Anypoint_MQ_Config" />
</flow>
----


== See Also

* xref:anypoint-mq/3.x/anypoint-mq-consume.adoc[Anypoint MQ Consume Operation]
* xref:anypoint-mq/3.x/anypoint-mq-listener.adoc[Anypoint MQ Subscriber Operation]
