= Publish Messages
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

The Publish operation in the Anypoint MQ connector lets you create a new Anypoint MQ message and send it to the specified destination, be it a queue, FIFO queue, or a message exchange. With it, you can configure not only the content of the message, but also all the headers and properties you need.

=== Outgoing Message Structure

To publish a message, we first need to understand its parts. With the Anypoint MQ Connector we can publish a message containing: 

* A `body` parameter, whose value becomes the body of the published Anypoint MQ Message.
* The `properties` parameter, which represents a simple key/value map of Strings that become the message properties of the Anypoint MQ Message. 

== Send a Message

When used in its default form, the connector publishes the content found in the incoming message `payload` as the `body` of the Anypoint MQ message, serialized as a String, to the declared `destination`:

image::amq-3x-publish-operation.png[Anypoint MQ Publish Operation]

[source,xml]
----
<anypoint-mq:publish destination="invoiceQueue" config-ref="Anypoint_MQ_config"/>
----

As output, this operation will produce:

* A copy of the body sent as payload, so for example if you are sending a "Hello world" message, the resulting payload will be the "Hello world" String.
* The message's `messageId` in the message attributes. 

image::amq-3x-publish-attributes.png[Anypoint MQ Publish Operation Output Attributes]


== Configure User Properties

Every Anypoint MQ message can have a set of properties, which can be used in many different ways, such as to provide compatibility with other messaging systems or to communicate the content-type of a message.
The `publish` operation allows you to configure these properties directly in the message.

You can configure this properties of the outgoing message with the `properties` parameter of the `publish` operation, defined as a key/value map of Strings using Dataweave:
 
image::amq-3x-publish-properties.png[Anypoint MQ Publish With Properties]

[source,console,linenums]
----
<anypoint-mq:publish config-ref="Anypoint_MQ_Config" destination="invoiceQueue">
			<anypoint-mq:properties><![CDATA[#[output application/java ---
        {
          AUTH_TYPE: 'jwt', 
          AUTH_TOKEN: attributes.queryParams.token
        }]]]>
      </anypoint-mq:properties>
</anypoint-mq:publish>
----


=== Transforming The Message Body

What happens if the payload is not in the correct format, and you actually need to make a transformation? All you need to do is to declare an inline Dataweave transformation in the `body` parameter of the `publish` operation:

image::amq-3x-publish-transformed.png[Anypoint MQ Publish With Transformation]

[source,console,linenums]
----
<anypoint-mq:publish config-ref="Anypoint_MQ_Config" destination="invoiceQueue">
			<anypoint-mq:body ><![CDATA[#[output application/json --- 
      {
        customer: payload.id, 
        items: payload.invoice.items
      }]]]>
      </anypoint-mq:body>
</anypoint-mq:publish>
----

In this case, the result of the operation will be the _transformed_ value as JSON.

== Advanced Configurations

image::amq-3x-publish-advanced.png[Anypoint MQ Publish Advanced Tab]

=== Custom Message Id

Instead of letting the Anypoint MQ service generate a unique `messageId` for the new published mesasge, you can set a custom `messageId` for your outgoing message using the `messageId` parameter in the advanced tab:

WARNING: The ID of an Anypoint MQ message is meant to be unique, be careful to choose a custom ID that serves this purpose correctly to avoid unwanted side effects of duplicated IDs.
In FIFO queues messages with duplicate IDs will be overwritten.

=== Propagate Content Type

Using the `sendContentType` parameter flag you can decide whether the Content-Type of the message body should be propagated as a *property* of the Anypoint MQ message or not. 
Setting this flag to `true` will automatically add a `contentType` property to the outgoing message. For example, this can be useful to declare if a body is in `application/json` or `application/xml` format.

== See Also

xref:anypoint-mq/anypoint-mq-listener.adoc[Listen For New Messages]
