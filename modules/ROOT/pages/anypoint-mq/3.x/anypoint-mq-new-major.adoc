= Anypoint M Q Connector - 3.x Migration Guide
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

The Anypoint MQ Connector is now presenting its latest 3.0 version, bringing a simplified configuration, standarized endpoints and non-blocking functionality, amongs other improvements.


=== Global Config

In the *old* 2.x version of the MQ Connector, the configuration element contained a lot of different parts, which can be categorized in:

[source,console,linenums]
----
<anypoint-mq:default-subscriber-config name="Anypoint_MQ_Default_subscriber"
									acknowledgementMode="IMMEDIATE" acknowledgementTimeout="10000" <1>
									maxRedelivery="2" <2>
									pollingTime="2000" fetchSize="5" fetchTimeout="5000" frequency="2000"> <3>
		<anypoint-mq:connection clientId="${client.id}" clientSecret="${client.secret}"/> <4>
		<anypoint-mq:circuit-breaker circuitName="InvoiceSettings" <5>
									 onErrorTypes="JMS:TIMEOUT"
									 errorsThreshold="10" tripTimeout="1"
									 tripTimeoutUnit="MINUTES" />
</anypoint-mq:default-subscriber-config>
----


.Configuration Parameters Migration
|===
|Element | 2.x Version Behavior | 3.x Version Equivalent
|1 - Acknowledgement
|Global acknowledgement settings for the MQ Subscribers
|This will now be configured on each Subscriber instance

|2 - Max Redelivery
|Redelivery filter for MQ messages based in `redeliveryCount` header
|Deprecated, this will no longer be available as standalone filter and should be replaced by `"DLQ + Idempotent Filter"` pattern

|3 - Message Fetch
|All parameters related to how messages are retrieved from the MQ service, including `prefeth` configuration
|Removed from the global config, all the parameters affecting the fetching strategy are now part of each Subscriber under the `Subscriber Type` parameter

|4 - Connection
|Connection parameters
|Idem configuration for all the connection settings

|5 - Circuit Breaker
|Circuit Breaker configuration for the MQ Subscriber
|Removed from the global config, the Circuit Breaker instances will either be handled as a standalone element, referenced by each MQ Subscriber, or as a private Circuit Breaker for the Subscriber who declares it
|===


As a result, the new Config element for the MQ Connector is a stripped down version containing only the connection settings:

[source,console,linenums]
----
<anypoint-mq:config name="Anypoint_MQ_Config">
	<anypoint-mq:connection clientId="${client.id}" clientSecret="${client.secret}" />
</anypoint-mq:config>
----

=== Subscriber Listener

The Subscriber message source received a big revamp on how the message listening is configured. Let's see how each parameter has been affected.

For an in-deepth view of the new subscriber, refer to: xref:anypoint-mq/3.x/anypoint-mq-listener.adoc[Listening for Messages]

==== Message Acknowledgement

In the *old* version of the connector, the `acknowledgement` mode of the subscriber was defined at config level:

[source,console,linenums]
----
<anypoint-mq:default-subscriber-config name="Anypoint_MQ_Default_subscriber"
									acknowledgementMode="MANUAL" acknowledgementTimeout="120000">
		<anypoint-mq:connection clientId="${client.id}" clientSecret="${client.secret}"/>
</anypoint-mq:default-subscriber-config>
----

Now, this parameters are moved to the subscriber element itself, affecting only that single subscriber instance. The semantics of each acknowledgement parameter have not suffered any modification, so this would be an equivalent configuration of the subscriber:

[source,console,linenums]
----
<anypoint-mq:subscriber config-ref="Anypoint_MQ_Config" destination="queue"
						acknowledgementMode="MANUAL"
						acknowledgementTimeout="2"
						acknowledgementTimeoutUnit="MINUTES"/>
----

==== Prefetch Mode


The *old* MQ Connector version shipped with the `prefetch` mode enabled by default, and all the parameters related to it needed to be set at configuration level:

[source,console,linenums]
----
<anypoint-mq:default-subscriber-config name="Anypoint_MQ_Default_subscriber"
									pollingTime="2000" fetchSize="5" fetchTimeout="5000" frequency="2000">
		<anypoint-mq:connection clientId="${client.id}" clientSecret="${client.secret}"/>
</anypoint-mq:default-subscriber-config>
----

In the *new* major version, a new concept called `Subscriber Type`, from where you will be able to control the `prefetch` configuration.

[source,console,linenums]
----
<anypoint-mq:subscriber config-ref="Anypoint_MQ_Config" destination="queue">
	<anypoint-mq:subscriber-type>
		<anypoint-mq:prefetch maxBufferSize="20"/>
	</anypoint-mq:subscriber-type>
</anypoint-mq:subscriber>
----


.Prefetch Parameters Migration
|===
| 2.x Version Parameter | 3.x Version Equivalent
|`fetchSize`: Declared at Config level, controls the size of the local message buffer, which is calculated as three times the `fetchSize`
|`maxBufferSize`: Declared at Subscriber level, explicitly controls the maximum size that the local message buffer can have. This will serve as target number, attemping to fetch as many messages as needed to fill it completely.

|`fetchTimeout`: Controlled the time waiting for a response from the service
|Deprecated, this will no longer be available. Connector will always use the maximum long-polling value

|`frequency`: Controlled when to re-check for messages after the queue got empty
|Deprecated, this will no longer be available. This would be handled internally by the connector, fixed at 1 second

|`pollingTime`: Used only when `fetchSize` was `0`, effectively disabling the `prefetch` mode and moving to a `polling` mode
|Deprecated, this has been replaced by the more powerful `polling` Subscriber Type
|===


==== Polling Mode

Previous versions of the MQ Connector allowed to disable the `prefetch` mode by setting the `fetchSize` parameter to `0`, and then using the `pollingTime` as a fixed-frequency polling scheduler.

In this new major version, the polling-mode of the subscriber has been simplified and normalized to what a polling-source should allow as configuration. This means that now, you'll be able to use the schedulers provided by Mule Runtime out of the box, either as `fixed-frequency` or `cron`:

[source,console,linenums]
----
<anypoint-mq:subscriber config-ref="Anypoint_MQ_Config" destination="queue">
	<anypoint-mq:subscriber-type >
		<anypoint-mq:polling >
			<scheduling-strategy >
				<fixed-frequency frequency="1" timeUnit="SECONDS" />
			</scheduling-strategy>
		</anypoint-mq:polling>
	</anypoint-mq:subscriber-type>
</anypoint-mq:subscriber>
----

[source,console,linenums]
----
<anypoint-mq:subscriber destination="queue" config-ref="Anypoint_MQ_Config">
    <anypoint-mq:subscriber-type>
        <anypoint-mq:polling>
            <scheduling-strategy>
                <cron expression="0 * 14 * * ?" timeZone="America/Los_Angeles"/>
            </scheduling-strategy>
        </anypoint-mq:polling>
    </anypoint-mq:subscriber-type>
</anypoint-mq:subscriber>
----


==== Circuit Breaker

Anothcer change took place in the declaration of the circuit breaker, now removed from the config and replaced by either a global element, or an inline declaration:


In the *old* version, we would declare it as part of the config, and then reference the config across multiple subscribers:

[source,console,linenums]
----
<anypoint-mq:default-subscriber-config name="ConfigWithCircuit" >
   	<anypoint-mq:connection url="${providerUrl}" clientId="${clientId}" clientSecret="${clientSecret}"/>
	<anypoint-mq:circuit-breaker
	           circuitName="InvoiceProcess"
	           onErrorTypes="FTP:RETRY_EXHAUSTED, HTTP:SERVICE_UNAVAILABLE"
	           errorsThreshold="10"
	           tripTimeout="5"
	           tripTimeoutUnit="MINUTES"/>
</anypoint-mq:default-subscriber-config>

<flow name="subscribe">
    <anypoint-mq:subscriber  config-ref="ConfigWithCircuit" destination="${reservationsQueue}"/>
    <flow-ref name="invoiceProcess">
</flow>

<flow name="otherSubscribe">
    <anypoint-mq:subscriber  config-ref="ConfigWithCircuit" destination="${paymentsQueue}"/>
    <flow-ref name="invoiceProcess">
</flow>

<sub-flow name="invoiceProcess">
  <ftp:write path="${auditFolder}" config-ref="ftp-config"/>
  <http:request config-ref="requestConfig" path="/external"/>
</sub-flow>
----

Now, we'll declare one standalone global element instead, and reference that global element from each subscriber, which frees us from binding a connection to the application logic circuit:

[source,console,linenums]
----

<anypoint-mq:config name="Anypoint_MQ_Config">
    <anypoint-mq:connection url="${providerUrl}" clientId="${clientId}" clientSecret="${clientSecret}"/>
</anypoint-mq:config>

<anypoint-mq:circuit-breaker
           name="InvoiceProcess"
           onErrorTypes="FTP:RETRY_EXHAUSTED, HTTP:SERVICE_UNAVAILABLE"
           errorsThreshold="10"
           tripTimeout="5"
           tripTimeoutUnit="MINUTES"/>

<flow name="subscribe">
    <anypoint-mq:subscriber destination="${reservationsQueue}" config-ref="Anypoint_MQ_Config"
                            circuitBreaker="GlobalCircuit"/>
    <flow-ref name="invoiceProcess">
</flow>

<flow name="otherSubscribe">
    <anypoint-mq:subscriber destination="${paymentsQueue}" config-ref="Anypoint_MQ_Config"
                            circuitBreaker="GlobalCircuit"/>
    <flow-ref name="invoiceProcess">
</flow>

<sub-flow name="invoiceProcess">
  <ftp:write path="${auditFolder}" config-ref="ftp-config"/>
  <http:request config-ref="requestConfig" path="/external"/>
</sub-flow>

----

=== Publish Operation

.Publish Operation Changes
|===
| Changes | 2.x Version | 3.x Version
| Execution Type
| Blocking
| Non-Blocking

| Properties Parameter
| Fixed key/value map
| Dynamic "content" parameter map
|===


Regarding the properties change, what in the *old 2.x version* of the connector was declared as:

[source,console,linenums]
----
<anypoint-mq:publish config-ref="Anypoint_MQ_Default_subscriber" destination="queue"
					 messageId="#[vars.messageId]" sendContentType="false">
	<anypoint-mq:body >#[vars.messageBody]</anypoint-mq:body>
	<anypoint-mq:properties >
		<anypoint-mq:property key="MSG_TYPE" value="My Value"/>
	</anypoint-mq:properties>
</anypoint-mq:publish>
----

In the *new 3.x version*, the same properties can be declared now as a dynamic map, subject to transformations a a dynamic number of keys, instead of having fixed keys for each message:

[source,console,linenums]
----
<anypoint-mq:publish config-ref="Anypoint_MQ_Config" destination="queue"
					messageId="#[vars.currentId]" sendContentType="false">
	<anypoint-mq:body >#[vars.messageBody]</anypoint-mq:body>
	<anypoint-mq:properties ><![CDATA[#[output application/java -----
{
	"MSG_TYPE" : vars.msgType
}]]]></anypoint-mq:properties>
</anypoint-mq:publish>
----

For more information look into: xref:anypoint-mq/3.x/anypoint-mq-publish.adoc[Publishing a Message]

=== Consume Operation

.Consume Operation Changes
|===
| Changes | 2.x Version | 3.x Version
| Execution Type
| Blocking
| Non-Blocking

| Default Ackowledgement Mode
| MANUAL
| IMMEDIATE
|===

For more information look into: xref:anypoint-mq/3.x/anypoint-mq-consume.adoc[Consuming a Message]

=== ACK and NACK Operations

The ACK and NACK operations present a major change on how the `ackToken`

.ACK and NACK Operation Changes
|===
| 2.x Version | 3.x Version
| Operations received a `messageContext` parameter, whose value had to be the `attributes` element from a given message
| Using the `ackToken` String of the message is enough to perform the ACK or NACK of a message
|===

This new `ackToken` value can be obtained from the attributes object. The `ackToken` will be available only for messages that have a `MANUAL` acknowledgement mode.

For more information look into: xref:anypoint-mq/3.x/anypoint-mq-ack.adoc[Acknowledgment]

=== Platform Compatibility

[%header%autowidth.spread]
|===
|Software |Version
|Mule Runtime |4.1.1 and later
|Anypoint Studio |v7 and later
|===
