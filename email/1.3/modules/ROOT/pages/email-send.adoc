= Send Emails with the Email Connector Example - Mule 4
:keywords: email, connector, configuration, smtp, send, smtps
:page-aliases: connectors::email/email-send.adoc

Anypoint Connector for Email (Email Connector) can send messages over SMTP and SMTPS server using the *Send* operation. The following examples show how to configure Email Connector to send emails and attachments, both in Anypoint Studio and the XML editor:

* <<send-email,Send Emails>> +
Configure the Email Connector *Send* operation to send emails over a SMTPS server.

* <<send-attachments,Send Attachments>> +
Configure the File Connector *Read* operation to read a JSON file, and the Email Connector *Send* operation to send the file as an attachment over a SMTP server.

[[send-emails]]
== Send Emails

The following example illustrates how to send emails over the SMTPS server. The flow initiates by a *Scheduler* component, and then the *Send* operation sends the email.
The SMTPS connection type enables SSL/TLS encryption and sends encrypted messages over the secured version of the SMTP server.

The following screenshot shows the Anypoint Studio app flow for this example:

.Email Connector Send messages over SMTPS
image::email-send-flow.png[Email Connector Send messages over SMTPS flow]

To create the flow: +

. Create a new Mule project in Studio.
. In the *Mule Palette* view, select the *Scheduler* component and drag it on to the canvas. +
The source initiates a flow when a time-based condition is met.
. Drag the Email *Send* operation to the right of the *Scheduler* source. +
. On the *Send* configuration screen, click the plus sign (*+*) next to the *Connector configuration* field to configure a global element for the operation.
. For *Connection*, select *SMTPS Connection*.
. In the *General* tab, enter the following values:
+
* *Host* +
`pop.gmail.com`
* *Port* +
`995`
* *User* +
`user3@domain.com`
* *Password* +
`passwordconnection`
+
. For *TLS Configuration* select *Edit inline*.
. In the *Trust Store Configuration* section, enter the following values:
+
* *Path* +
`aTruststore.jks`
* *Password* +
`passwordtrust`
+
. In the *Key Store Configuration* section, enter the following values:
+
* *Path* +
`aKeystore`
* *Password*
`passwordkey`
+
. In the *Advanced* section, set *Enabled Protocols* to `TLSv1.2,SSLv3`.
. Click *OK* to close the configuration.

The following screenshot shows the *Email SMTPS* configuration:

.Email SMTPS configuration
image::email-smtps-configuration.png[Email SMTPS configuration]

[start=12]
. In the *Send* operation configuration screen, set the following values:
+
* *From address* +
`user1@domain.com`
* *To addresses* +
`Edit inline`
+
. Click the (*+*) plus sign to add `user2@domain.com` and `user3@domain.com` as addresses.
. Set *Subject* to `IMPORTANT!`.
. Set *Content* to `"<h1>Hello this is an important message</h1>"` and *ContentType* to `text/html`. +
If no *Body* content is specified, the content of the message payload is used by default. If that payload is not `text`, the operation fails with an `EMAIL:SEND` error.
. Save the app.

The following screenshot shows the *Send* operation configuration:

.Email Send operation configuration
image::email-send-configuration.png[Email Send operation configuration]

=== XML for Send Emails

Paste this code into the Studio XML editor to quickly load the flow for this example into your Mule app:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:tls="http://www.mulesoft.org/schema/mule/tls" xmlns:email="http://www.mulesoft.org/schema/mule/email"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/email http://www.mulesoft.org/schema/mule/email/current/mule-email.xsd
http://www.mulesoft.org/schema/mule/tls http://www.mulesoft.org/schema/mule/tls/current/mule-tls.xsd">
	<email:smtp-config name="Email_SMTP" >
		<email:smtps-connection host="pop.gmail.com" port="995" user="user1@domain.com" password="passwordvalue" >
			<tls:context enabledProtocols="TLSv1.2,SSLv3" >
				<tls:trust-store path="aTruststore.jks" password="changeit" />
				<tls:key-store path="aKeystore" password="password" />
			</tls:context>
		</email:smtps-connection>
	</email:smtp-config>
	<flow name="emailconnectorFlow">
		<scheduler>
			<scheduling-strategy >
				<fixed-frequency />
			</scheduling-strategy>
		</scheduler>
		<email:send config-ref="Email_SMTP" fromAddress="user1@domain.com" subject="IMPORTANT!">
			<email:to-addresses >
				<email:to-address value="user3@domain.com" />
        <email:to-address value="user2@domain.com" />
			</email:to-addresses>
			<email:body contentType="text/html" >
				<email:content ><![CDATA["<h1>Hello this is an important message</h1>"]]></email:content>
			</email:body>
		</email:send>
	</flow>
</mule>
----


=== SMTP Configuration Type

Here is an example of an SMTP configuration:

.SMTP Configuration
[source,xml,linenums]
----
<email:smtp-config name="smtp">
    <email:stmp-connection host="smtp.gmail.com" port="995" user="user1@domain.com" password="#passwordvalue!"/>
</email:smtp-config>
----


[[send-attachments]]
== Send Attachments

The following example illustrates how to send emails and attachments over the SMTP server. Use DataWeave to handle the attachments. The flow reads a JSON file using the File Connector *Read* operation, then uses the Email Connector *Send* operation to send the contents of the file as an attachment:

The following screenshot shows the Anypoint Studio app flow for this example:

.Email Connector Send attachments over SMTP
image::email-attachment-flow.png[Email Connector Send attachments over SMTP]

To create the flow: +

. Create a new Mule project in Studio.
. In the *Mule Palette* view, select the *Scheduler* component and drag it on to the canvas. +
The source initiates a flow when a time-based condition is met.
. Drag the Email *Send* operation to the right of the *Scheduler* source. +
. On the *Send* configuration screen, click the plus sign (*+*) next to the *Connector configuration* field to configure a global element for the operation.
. For *Connection*, select *SMTPS Connection*.
. In the *General* tab, enter the following values:


[source,xml,linenums]
----
<flow name="attachment">
  <file:read path="/file.json"/>
  <email:send config-ref="config">
      <email:to-addresses>
          <email:to-address value="example@domain.com"/>
      </email:to-addresses>
      <email:body>
          <email:content><![CDATA["<h1>Hello this is an important message</h1>"]]></email:content>
      </email:body>
      <email:attachments>
        #[{
          'json-attachment' : payload
        }]
      </email:attachments>
  </email:send>
</flow>
----

As you can see, `email:attachments` expects a DataWeave expression in which
each element is an attachment. For instance, the example above adds a new attachment
named `json-attachment`. Notice that `payload` is the content of the JSON file that was read by the File connector.

You can send multiple attachments of different media types, for example, you might want to send a JSON element, then a text element, and also a file. To do this, add them to your attachments element like this:

[source,xml,linenums]
----
</flow>
    <set-variable variableName="json" value="#[output application/json --- {address: '221B Baker Street'}]" mimeType="application/json"/>
    <set-variable variableName="textPlain" value="This is the email text attachment for John Watson" mimeType="text/plain"/>
    <set-variable variableName="octetStream" value="#[vars.textPlain]" mimeType="application/octet-stream"/>

    <email:send config-ref="config">
        <email:to-addresses>
            <email:to-address value="user4@domain.com"/>
        </email:to-addresses>
        <email:body contentType="text/plain">
            <email:content>Email Content</email:content>
        </email:body>
        <email:attachments>#[
            {
                'text-attachment' : vars.textPlain,
                'json-attachment' : vars.json,
                'stream-attachment' : vars.octetStream
            }]
        </email:attachments>
    </email:send>

    <logger level="INFO" doc:name="Logger" message="#['Message Id ' ++ correlationId as String]" />
</flow>
----

Notice that each attachment had its own media type previously set.

The Send operation will return a message containing an `HttpRequestAttributes` object in the Message attributes section containing all the information used to send the email to the SMTP server (Request Path, Headers, and so on). The payload that was set
immediately before the Send operation was performed will be the output payload of the operation as well.

== See Also

* xref:connectors::introduction/introduction-to-anypoint-connectors.adoc[Introduction to Anypoint Connectors]
* https://help.mulesoft.com[MuleSoft Help Center]
