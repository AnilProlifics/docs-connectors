= OAuth2 Configuration

=== OAuth 2.0 Connection Type

When configuring an OAuth 2.0 connection, you can specify an object store that stores each resource owner's ID data. If you don't specify an object store, Mule automatically provisions the default object store.

The app interacts with the object store automatically when a new resource owner is authenticated, the access token is refreshed, or the access token is invalidated.

== Create a Consumer Key

A consumer key is required when setting up OAuth 2.0 configurations for Salesforce Connector. It is used by the OAuth, JWT, and SAML bearer configurations, and by the OAuth Username and Password configuration.

This procedure provides guidance for using Salesforce to create a consumer key and explains how to create a connected app in Salesforce. However, the steps might differ in your Salesforce instance.

This procedure assumes that you already have a certification file (such as `salesforce-cert.crt`). If not, you can produce one by generating a Java keystore and public key.

[[create-consumer-key]]
. Log in to Salesforce.
. From Setup, enter `Apps` in the *Quick Find* box.
. Click *App Manager*.
. Click *New Connected App*.
. To create a new connected app, enter:
+
* A name for the connected app
* The API name
* The contact email
+
. In the *API (Enable OAuth Settings)* section, select the *Enable OAuth Settings* checkbox:
+
* Enter the *Callback URL*.
* Select the *Use Digital Signatures* checkbox.
* Click *Choose File* and load your Salesforce certificate (for example, `salesforce-cert.crt`), which contains your public key.
+
In Studio, you typically store the certificate in the workspace that contains your Mule app.
+
. Add and save these OAuth scopes to *Selected OAuth Scopes*:
+
** *Full Access* (`full`)
** *Perform Requests On Your Behalf At Any Time* (`refresh_token`, `offline_access`)
+
. Configure the authorization settings for the app.
. Click *Manage*.
. In the OAuth Policies section, expand the *Permitted Users* list and select *Admin Approved Users are Pre-Authorized*.
+
. Click *Save*.
. In the Profiles section, click *Manage Profiles*.
. Select your user profile and click *Save*.
. Select *Build* > *Create* > *Apps* to return to the list of connected apps.
. In the Connected Apps section, select the connected app you created.

You can now see the consumer key that you need to provide in your connector's configuration.

== Generate a Keystore File

This example demonstrates how to create a JKS keystore (PKCS12 format is also supported).

The Key Store field is the path to the keystore used to sign data during authentication.

[NOTE]
Salesforce Connector is using the Bouncy Castle cryptographic library to load the certificate from the keystore and sign the payload for the authentication requests.
The Bouncy Castle library has a https://nvd.nist.gov/vuln/detail/CVE-2018-5382[vulnerability (CVE-2018-5382)] that is related to the BKS-V1 keystore file type.
By default, Salesforce Connector is using JKS or PKCS12 keystores. It is best not to use BKS-V1 keystore files, as documented in the https://www.kb.cert.org/vuls/id/306792[Bouncy Castle proposed solution].

To generate a keystore file:

. Go to your Mule workspace and open the command prompt (for Windows) or Terminal (for Mac).
. Type this command and press enter:
+
[source]
----
keytool -genkeypair -alias salesforce-cert -keyalg RSA -keystore salesforce-cert.jks
----
+
. Enter the following information:
+
** Password for the keystore
** Your first name and last name
** Your organization unit
** Name of your city, state, and the two-letter code for your country
+
The system generates a Java keystore file (JKS format) that contains a private or public key pair in your workspace.
+
. Provide the file path for the keystore in your connector configuration.
+
Type this command and press enter:
+
[source]
----
keytool -exportcert -alias salesforce-cert -file salesforce-cert.crt -keystore salesforce-cert.jks
----
+
The system exports the public key from the keystore into the workspace. This is the public key that you need to enter in your Salesforce instance.
+
. Verify that you have both the keystore (`salesforce-cert.jks`) and the public key (`salesforce-cert.crt`) files in your workspace.

=== Mutual TLS

In v9.7.0 and later, all authentication types support mutual TLS. To use mutual TLS, you need a keystore file and a password for the file. See <<Generate a Keystore File>> for more information.

Specify the path to the keystore file and the password in the configuration window:

image::salesforce-100-mutual-tls.png[Mutual TLS]

Any user requiring mutual TLS authentication can log in using the connector.

To set up a mutual TLS certificate in your Salesforce environment, see https://help.salesforce.com/articleView?id=security_keys_uploading_mutual_auth_cert.htm&type=5[Set Up a Mutual Authentication Certificate].
