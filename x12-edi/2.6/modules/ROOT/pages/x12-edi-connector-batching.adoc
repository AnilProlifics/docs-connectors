= X12 EDI Connector 2.3 - Batch Outbound X12 Messages - Mule 4

For B2B and EDI messages that are not time-sensitive, such as invoices and payment remittances, batch messages instead of transmitting transactions to your trading partners individually.

== Batching Stages

Use the Anypoint X12 EDI Connector Batch Write operation to merge individual X12 messages into a single transmission to send to your trading partners.

Implementing a batch involves two stages:

. Accumulate the transactions.
. Release the batch.

=== Accumulate the Transactions

To accumulate transactions for a batch:

. Transform the payloads into X12 messages using DataWeave and X12 as you receive application messages (such as a JSON invoice) from the backend systems.
. Create X12 payloads using temporary control number keys in the X12 Write operation. +
This enables sending the accumulated X12 as a batch later. The batch is created using control numbers that are not used in the final batch sent to the trading partner, for example, `<X12:write doc:name="Write individual D97A ORDERS" doc:id="3d51215a-125d-461b-9791-0a939e5ebc45" config-ref="X12_Write_ORDERS" interchangeControlNumberKey="NTO-MYTHICAL-UNB-TMP"/>`.
. Store the intermediate X12 message payloads in your choice of storage, such as a database table:

image::X12-edi-connector-batch-flow-1.jpg[Accumulate the transactions]

For example, this implementation of a Mule flow:

* Receives JSON payloads from the backend systems.
* Transforms to an `X12 D97A ORDERS` message.
* Generates the intermediate X12 message payload using the X12 Write operation.
* Stores the X12 payload in a database table.

=== Release the Batch

Trading partners have varying criteria for how they want transactions batched:

* Release the batch at a specific time interval or a specific time of the day.
* Release the batch when a specific number of transactions is accumulated.
* Release the batch when the total size of the accumulated transactions is near a threshold.

To release the batch:

. Implement the logic or module to monitor the transactions accumulated in the temporary storage and determine when a particular batch is released.

. Retrieve the accumulated intermediate X12 messages from the temporary storage based on the batch criteria, group the transactions together, and then send the appended payload to the X12 Batch Write operation. +
You can either use the control number key on the Batch Write operation or leave the control number key fields empty at the time of Batch Write operation execution, allowing the X12 EDI Connector to generate the control number sequence automatically based on the sender and receiver identifier combination:
`<X12:batch doc:name="Batch" doc:id="3ce80437-63e2-404c-b875-531708b7bfdb" config-ref="X12_Batch" interchangeControlNumberKey="NTO-MYTHICAL-UNB-TMP"> <X12:batch-content ><![CDATA[#[vars.mergedInput]]]></X12:batch-content> </X12:batch>`.
. Ensure that the input payload sent to the Batch Write operation contains EDI transactions with data elements in the UNB envelope segments, such as `Sender ID`, `Receiver ID`, and `Version number`. +

image::X12-edi-connector-batch-flow-2.jpg[Release the batch]

For example, this implementation of a Mule flow:

* Receives an HTTP request to release accumulated X12 messages transactions for a specific partner. The request is triggered after the batch release criteria are met.
* Retrieves the intermediate X12 messages from the database table.
* Applies a transformation to group the individual X12 messages together.
* Sends the appended payload through the X12 Batch Write operation to merge the messages into a single transaction.
* Prints the generated control numbers, which reconcile the inbound functional acknowledgments received from the partners.
* Delivers the batched X12 transaction to the trading partnerâ€™s SFTP site.

If the input payload contains EDI transactions with non-matching data elements in the envelope segments, the Batch operation throws an exception.
