= Configure OAuth2 on CloudHub

When deploying your OAuth2 enabled connectors to a cloud service, there are some things you have to keep in mind. In this introduction we will cover the basic of how to get your connector on cloudhub and the configuration required to make it work with OAuth2 setups.

== Cloudhub Setup

The flow is exactly the same as with configuring a local OAuth2 setup, but you need to keep in mind that with CloudHub you're behind an extra server. There are a couple things you need to keep in mind when using OAuth2 with CH setup.

=== Connector Listener
First, the are some special https://docs.mulesoft.com/runtime-manager/cloudhub-manage-props#cloudhub-reserved-properties[properties that CloudHub manages] for you automatically. Namely `${http.port}`, `${https.port}`. Make sure you are using these properties when configuring your HTTP listener.

image::intro-config-oauth2-cloduhub-img1.png[Http Listener CloudHub Example]

Second, when deployed on the cloud, the hosts "localhost", "0.0.0.0" and "127.0.0.1" can no longer be assumed to be publicly reachable. This means that when configuring your OAuth2 Identity Provider you will need to replace all links containing these hosts with the actual CloudHub provided public address. For cloudhub, this address will be in the format "{ch-app-name}.{region}.cloudhub.io". For example an HTTP application named "ch-example-app" deployed in the Europe(London) https://docs.mulesoft.com/runtime-manager/cloudhub-networking-guide#regional-services[region] would have the public address of "http://ch-example-app.uk-e1.cloudhub.io".

=== Identity Provider setup
If you configured your OAuth callback as "/callback" then your public callback URL would be "{ch-app-name}.{region}.cloudhub.io/callback". That's the callback URL you want to register with your Identity Provider as your redirect URI.

image::intro-config-oauth2-cloudhub-idp-example.png[OKTA Example]

This also needs to be configured in your connector as the "External Callback url". You can use another handy property, `${fullDomain}`,  that CloudHub configures for you to automatically obtain the proper host name.

image::intro-config-oauth2-cloudhub-callback-config.png[]

NOTE: If you're deploying to multiple regions or have some other gateway configured, you will have to use the hostname of the load balancer or gateway in your Identity Provider callback url and also inside your "external callback url".

One important caveat of OAuth2 configuration is that it is not the Identity Provider that needs to reach the callback endpoint, but the user(client) from their browser. This means that you need to pay extra attention to the region configuration. If you create your CloudHub app in the US region, but your clients try to connect to it from Europe, the request will be blocked by the gateway.

=== Perform OAuth Dance

Once everything is configured you can deploy your application to CloudHub like you would normally and initialize the OAuth dance by navigating to your public hostname on your authorization endpoint. For example, with the above configuration, we'd navigate to "{ch-app-name}.{region}.cloudhub.io/authorize". This will start the OAuth dance and you will be prompted to log-in with your identity provider.

== See Also
* xref:connectors-home::intro-config-oauth2.adoc[Configuring OAuth].
* https://docs.mulesoft.com/runtime-manager/deploying-to-cloudhub[Deploying to CloudHub]
* https://help.mulesoft.com[MuleSoft Help Center]
