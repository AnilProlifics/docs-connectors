= MQTT3 Connector 1.0 - Mule 4


Support Category: https://www.mulesoft.com/legal/versioning-back-support-policy#anypoint-connectors[Select]

Anypoint Connector for MQTT3 (MQTT3 Connector) is an MQTT v3.x compliant MuleSoft extension. The connector consumes and produces MQTT (Message Queuing Telemetry Transport) messages. MQTT3 Connector supports all MQTT v3.x functionalities including message retention, last will and testament messages, and persistent sessions.

For compatibility information and fixed issues, see the MQTT3 Connector Release Notes.

== Prerequisites

To use this connector, you must be familiar with:

* MQTT v3.x protocol
* Anypoint Connectors
* Mule runtime engine (Mule)
* Elements and global elements in a Mule flow
* Creating a Mule app using Anypoint Studio (Studio)

Before creating an app, you must have Anypoint Platform and Anypoint Studio.

== Common Use Cases for the Connector

These are some common use cases for MQTT3 Connector:

* Connect to MQTT brokers in hunt mode setup and publish messages.
* Connect to MQTT brokers in reliable messaging schema and publish messages.
* Connect to an MQTT broker and set a last will and testament (LWT) message.
* Connect to an MQTT broker with TLS and listen for messages.
* Listen for messages on a unique or multiple topics.
* Listen for messages on multiple topics using single-level or multi-level wildcards.
* Publish messages to a topic.
* Publish messages with retention.
* Publish messages to an MQTT topic and set different Quality of Service (QoS) levels.

[[configuration_settings]]
== Configure the Connector

MQTT3 Connector comes out of the box with a set of default values for both publishing and consuming messages.
The only requirement is that you must configure which connection to use and that you specify a value for the client ID,
which will uniquely identify that connection.

This example sets a minimal connection to a broker in `localhost`:

[source,example,linenums]
----
<mqtt3:config name="MQTT_Config">
    <mqtt3:connection clientId="smart-bentley-123">
        <mqtt3:connection-settings>
            <mqtt3:connection-string-mqtt3-authenticator url="tcp://127.0.0.1:1883" />
        </mqtt3:connection-settings>
    </mqtt3:connection>
</mqtt3:config>
----

An equivalent option is to use the form authenticator if you want to specify each URL field separately:

[source,example,linenums]
----
<mqtt3:config name="MQTT3_Config">
	<mqtt3:connection clientId="smart-bentley-123" >
		<mqtt3:connection-settings >
			<mqtt3:form-mqtt3-authenticator host="0.0.0.0" protocol="TCP" port="1883"/>
		</mqtt3:connection-settings>
	</mqtt3:connection>
</mqtt3:config>
----

=== Define Global Defaults

MQTT3 Connector enables you to define multiple default parameters while consuming or publishing messages. This way, you can define a global default behavior for all the operations associated with the configurations.

For example, you can specify the keep alive interval and time units to set the maximum period of time that the
connection will be kept alive without any messages being exchanged between the client and broker. Or you can set the maximum
number of in-flight messages allowed.

[source,example,linenums]
----
<mqtt3:config name="MQTT_Config">
    <mqtt3:connection clientId="smart-bentley-123" maxInFlight="60" keepAliveInterval="60" keepAliveIntervalUnit="SECONDS">
        <mqtt3:connection-settings >
            <mqtt3:connection-string-mqtt3-authenticator url="tcp://127.0.0.1:1883" />
        </mqtt3:connection-settings>
    </mqtt3:connection>
</mqtt3:config>
----


== Set a Client ID

A client ID is mandatory and is used to identify an MQTT connection to a broker. It is best to define a meaningful name that uniquely identifies a client or device that connects to an MQTT broker and not a random string. The client ID can be set in the connection element of the configuration.

== Specify a Connection Protocol

MQTT supports the following protocols, which can be used to connect to and exchange MQTT messages with the broker:

* TCP
* SSL/TLS
* WS
* WSS
* LOCAL

The protocol should be set in the connection string in the connector's configuration and will default to TCP if none is specified.

== Provide Credentials For Authentication

Authentication credentials are optional, but you can provide a username and a password if it is required.

For example, to provide a basic username and password:

[source,example,linenums]
----
<mqtt3:config name="MQTT_Config">
    <mqtt3:connection clientId="smart-bentley-123" username="crowley" password="theDemon666">
        <mqtt3:connection-settings >
            <mqtt3:connection-string-mqtt3-authenticator url="tcp://127.0.0.1:1883" />
        </mqtt3:connection-settings>
    </mqtt3:connection>
</mqtt3:config>
----

Or you can also provide a client certificate to authenticate the connection by setting a TLS context.

== Provide a Fail Over Server List

There are certain deployment schemas that consist of multiple brokers working together in order to
provide clients with several connection endpoints. When there is more than one available server that the client can
connect to, there are two possible scenarios: Either each MQTT server is operating separately or they might be working
together and sharing a state (cluster mode), in which case, you might want to specify how the MQTT client will
behave in the event of a reconnection.

When you provide a fail over server list, the connector can iterate over it until it successfully establishes a
connection with one of the provided endpoints.

[source,example,linenums]
----
<mqtt3:config name="MQTT_FailOver_Config">
    <mqtt3:resilient-connection clientId="smart-bentley-123" >
        <mqtt3:fail-over-servers >
            <mqtt3:fail-over-url protocol="TCP" host="127.9.0.2" port="1883"/>
            <mqtt3:fail-over-url protocol="TCP" host="127.0.0.3" port="1884"/>
            <mqtt3:fail-over-url protocol="TCP" host="127.0.0.1" port="1885"/>
        </mqtt3:fail-over-servers>
    </mqtt3:resilient-connection>
</mqtt3:config>
----

== Specify Clean Session

Set the clean session flag to `false` to indicate that the broker should remember the client the next time it connects.
While the client is offline, all its subscriptions are saved, and QoS 1 and 2 messages that the client would want
to receive will be saved too, until it reconnects.

Some brokers support the clustering of MQTT brokers in which the nodes share a state. In this case, setting the clean session flag to `false` can be useful if the node the connector is talking to happens to go offline. This enables the client to reconnect to a different node that is aware of the client's subscriptions so that any messages the connector might have missed while offline are delivered.

If clean session is set to `true` (default), then when the connector disconnects, for whatever reason, all its subscriptions
will be dropped and it will have to resubscribe upon reconnection, and all messages sent for it while offline
will be lost.

[source,example,linenums]
----
<mqtt3:config name="MQTT_Config">
    <mqtt3:connection clientId="smart-bentley-123" cleanSession="false">
        <mqtt3:connection-settings >
            <mqtt3:connection-string-mqtt3-authenticator url="tcp://127.0.0.1:1883" />
        </mqtt3:connection-settings>
    </mqtt3:connection>
</mqtt3:config>
----

== Enable File Persistence

Enabling file persistence, by setting the `enableFilePersistence` flag to `true`, allows the MQTT client to persist its state
to a file that is used to store any outbound or inbound in-flight messages the client might have with QoS â‰¥ 1. In contrast,
if `enableFilePersistence` flag is set to `false`, the client state will only be saved in memory and in the event of a crash
the client will not be able to recover its state.

[source,example,linenums]
----
<mqtt3:config name="MQTT_Config">
    <mqtt3:connection clientId="smart-bentley-123" cleanSession="false" enableFilePersistence="true">
        <mqtt3:connection-settings >
            <mqtt3:connection-string-mqtt3-authenticator url="tcp://127.0.0.1:1883" />
        </mqtt3:connection-settings>
    </mqtt3:connection>
</mqtt3:config>
----
