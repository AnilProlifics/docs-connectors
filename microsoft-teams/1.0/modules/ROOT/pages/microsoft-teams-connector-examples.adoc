= Microsoft Teams Connector 1.0 Examples

The following examples shows you how to use Microsoft Teams Connector to perform these actions:

* <<create-new-team,Create a new team>>
* <<retrieve-team,Retrieve the team>>
* <<retrieve-membershipId,Retrieve a list of members>> that belong to the team
* <<retrieve-channel-list,Retrieve a list of channels for the team>> from the team
* <<onboard-new-hire,Onboard a new hire>> to the team
* <<delete-channel,Delete a team channel>>
* <<remove-team-member,Remove a team member>> from the team

== Prerequisites

To run these examples, you must have:

* A working instance of Microsoft Teams
* Credentials to access the Microsoft Teams instance
* Microsoft Teams Connector 1.0 or later
* Two users in the Microsoft Teams instance: one team owner and one users
+
Save the user IDs to use in the examples.
+
* Anypoint Studio 7.x

These examples uses variables for some field values. You can either:

* Replace the variables with their values in the code.
* Provide the values for each variable in the `/src/main/resources/mule-app.properties` file and then refer to that file from the connector configuration, for example:

----
config.oauth.client.credentials.clientId=${config.oauth.client.credentials.clientId}
config.oauth.client.credentials.clientSecret=${config.oauth.client.credentials.clientSecret}
config.oauth.client.credentials.tokenUrl=${config.oauth.client.credentials.tokenUrl}
----

If you don't know how to use a properties file, see xref:mule-runtime::mule-app-properties-to-configure.adoc[Configuring Property Placeholders].

[[create-new-team]]
== Create a New Team

The following screenshot shows the Anypoint Studio app flow for creating a new team:

image::ms-teams-create-new-team.png[Flow for creating a new team]

Creating this flow involves creating a new Mule project and configuring a *Listener* component, *Transform Message* component, *Create Team* operation, and second *Transform Message* component.

To create the flow:

. Create a new Mule project in Studio.
. In the Mule Palette view, search for *HTTP* and select the *Listener* operation:
. Drag the *Listener* operation onto the canvas.
. In the *Listener* configuration, click *+* next to the *Connector configuration* field to add a global element.
. Accept the defaults.
. Set the *Path* field to `/createTeam`.

When you deploy this flow, the HTTP endpoint listens to the following URL:

`+http://localhost:8081/createTeam?displayName={teamDisplayName}&description={teamDescription}&user={teamOwnerUser}+`

Provide the required `displayName`, `description`, and `user` input parameters as HTTP query parameters to initiate this flow.

=== Add a Transform Message Component to ..

This Transform Message component creates the structure of the Team object and xx

. In the Mule Palette view, search for *Transform Message*:
. Drag the *Transform Message* component onto the canvas, to the right of the *Listener* component.
. In the *Transform Message* configuration, overlay the brackets in the *Output* section with this XML:
+
[source,dataweave,linenums]
----
{
	"template@odata.bind": "https://graph.microsoft.com/v1.0/teamsTemplates('standard')",
	description: message.attributes.queryParams.description,
	displayName: message.attributes.queryParams.displayName,
	"members":[
      {
        "@odata.type":"#microsoft.graph.aadUserConversationMember",
        "user@odata.bind":"https://graph.microsoft.com/v1.0/users('" ++ message.attributes.queryParams.user as String ++ "')",
         "roles":[
            "owner"
         ]
      }
}
----
+
The following screenshot shows the XML as it appears in the *Output* section of Studio:
//+
//image::amazon-sqs-transform-message.png[transform-message]

=== Add the Create Team Operation

. In the *Mule Palette* view, search for *teams* and select the Microsoft Teams *create team* operation:
. Drag the *Create team* operation onto the canvas, to the right of the *Transform Message* component.
. In the *Create team* configuration, click *+* next to the *Connector configuration* field to add a global element.
. Configure the global element as follows:
+
[%header%autowidth.spread]
|===
|Field |Value
|Name | `OAuth_Client_Credentials_Config`
|Client id | `${config.oauth.client.credentials.clientId}`
|Client secret | `${config.oauth.client.credentials.clientSecret}`
|Token url | `${config.oauth.client.credentials.tokenUrl}`
|Scopes | `${config.oauth.client.credentials.tokenUrl}`
|Listener config | `auth`
|Callback path | `/callback`
| Authorize Path | `/authorize`
| External callback url: `http://localhosdt:8083:callback`

|===
//
//For example:
//+
// image::amazon-sqs-studio-global-config-new.png[send-global-config]
+
. Select the *Configuration XML* tab to view the corresponding XML:
+
[source,xml,linenums]
----


----
. Configure the following fields in the properties window:
+
[%header%autowidth.spread]
|===
|Field |Value
|Display Name |`Create team`
|Connector Configuration |Global configuration you just created
|Message |`payload`
|===
+
//For example:
//+
//image::amazon-sqs-send-message.png[send-message]

=== Add the Second Transform Message Component

The second *Transform Message* component

=== Add the Logger

[retrieve-team]
== Retrieve the Team Properties and Relationships

Create a second flow to retrieve the properties and relationships for the new team. Use the *Get Team* operation in this flow:

image::ms-teams-get-new-team.png[Retrieve the team Flow]

When you deploy this flow, the HTTP endpoint listens to the following URL:

`+http://localhost:8081/getTeam?team={createdTeamId}+`

Provide the `createdTeamId` as an HTTP query parameter to initiate this flow.

[retrieve-members]
== Retrieve the Team Members

Create a third flow to retrieve the members of the new team. Use the *List team members* operation in this flow:

image::ms-teams-get-new-team.png[Retrieve the Team Members Flow]

When you deploy this flow, the HTTP endpoint listens to the following URL:

`+http://localhost:8081/listTeamMembers?team={createdTeamId}+`

Provide the `createdTeamId` as an HTTP query parameter to initiate this flow.

[retrieve-channel-list]
== Retrieve a List of Team Channels

// Does this retrieve all channels from all teams?

Create a fourth flow to retrieve a list the channels associated with the team. Use the *List channels* operation in this flow:

image::ms-teams-list-team-channels.png[List channels flow]

When you deploy this flow, the HTTP endpoint listens to the following URL:

`+http://localhost:8081/listChannels+`

Because you haven't created any channels yet, this flow returns only the default channel.

[[onboard-new-hire]]
== Onboard a New Hire

Create a fifth flow to onboard a new hire to the team. This flow uses the following operations:

* *Add team member* to add a new member to the team
* *Create channel* to create a new channel
* *Add channel member* to add the new member to the newly-created channel
* *Create message* to create the welcome message

image::ms-teams-new-hire-onboarding.png[Onboarding a New Hire]

The HTTP endpoint listens to the following URL:

`+http://localhost:8081/newHireFlow?channelName={channelName}&team={createdTeamId}&userToOnboard={userToBeOnboarded}&channelOwner={channelOwner}+`

The JSON response contains the following welcome message:

`"content": "Welcome to the team {channelName}"`

The channel owner should be a different user than the `userToOnboard` user.

[[delete-channel]]
== Delete a Team Channel

Create a sixth flow to delete a channel. Use the *Delete channel* operation in this flow.

The HTTP endpoint listens to the following URL:

`+http://localhost:8081/deleteChannel?team={teamId}&channel={channelId}+`

Provide the `teamId` and `channelId` as HTTP query parameters to initiate this flow. The flow has no return type.

[[remove-team-member]]
== Remove a Member

Create a seventh flow to remove a member from a team. Use the *Remove team member* operation in this flow.

The HTTP endpoint listens to the following URL:

`+http://localhost:8081/removeTeamMembers?team={teamId}&member={membershipId}+`

Provide the `TeamId` and `membershipId` as HTTP query parameters to initiate this flow.

== Run the App

To run the app:

. Specify your OAuth2 credentials for 'OAuth_Client_Credentials_Config' and 'OAuth_Authorization_Code_Config' Config in the `/src/main/resources/mule-app.properties` file.
. for the 'OAuth_Client_Credentials_Config' use the 'Test connection' option to validate the credentials are ok.
. Right-click the project in Package Explorer and select *Run As > Mule Application*.
. Perform the 'OAuth Dance' for the 'OAuth_Authorization_Code_Config'; when prompted for permissions, allow them.
. After the app deploys, open a web browser and initiate a flow by entering the associated URL. If the URL has query parameters, make sure you include them.
+
[%header%autowidth.spread]
|===
| Flow | URL
| Create a new team| `+http://localhost:8081/createTeam?displayName={teamDisplayName}&description={teamDescription}&user={teamOwnerUser}+`
| Retrieve the new team | `+http://localhost:8081/getTeam?team={createdTeamId}+`
| Retrieve the members of the new team | `+http://localhost:8081/listTeamMembers?team={createdTeamId}+`
| Retrieve a list of channels | `+http://localhost:8081/listChannels+`
| Retrieve channels from the new team | `+http://localhost:8081/listChannels?team={createdTeamId}+`
| Onboard a new hire to the team | `+http://localhost:8081/newHireFlow?channelName={channelName}&team={createdTeamId}&userToOnboard={userToBeOnboarded}&channelOwner={channelOwner}+`
| Delete a channel | `+http://localhost:8081/deleteChannel?team={teamId}&channel={channelId}+`
| Remove a team member | `+http://localhost:8081/removeTeamMembers?team={teamId}&member={membershipId}+`
|===

== XML for the Examples

Paste this XML code into the *Configuration XML* tab in your project to experiment with the flows described in the previous sections.

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:microsoftTeams="http://www.mulesoft.org/schema/mule/microsoftTeams"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/microsoftTeams http://www.mulesoft.org/schema/mule/microsoftTeams/current/mule-microsoftTeams.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<configuration-properties file="mule-app.properties"/>
	<microsoftTeams:client-credentials-config name="OAuth_Client_Credentials_Config" doc:name="Microsoft Teams Client Credentials Config">
		<microsoftTeams:oauth-client-credentials-connection >
			<microsoftTeams:oauth-client-credentials clientId="${config.oauth.client.credentials.clientId}" clientSecret="${config.oauth.client.credentials.clientSecret}" tokenUrl="${config.oauth.client.credentials.tokenUrl}" scopes="https://graph.microsoft.com/.default" />
		</microsoftTeams:oauth-client-credentials-connection>
	</microsoftTeams:client-credentials-config>
	<http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config">
		<http:listener-connection host="0.0.0.0" port="8081" />
	</http:listener-config>
	<http:listener-config name="auth" doc:name="HTTP Listener config" >
		<http:listener-connection host="0.0.0.0" port="8083" />
	</http:listener-config>
	<microsoftTeams:authorization-code-config name="OAuth_Authorization_Code_Config" doc:name="Microsoft Teams Authorization Code Config" >
		<microsoftTeams:oauth-authorization-code-connection >
			<microsoftTeams:oauth-authorization-code consumerKey="${config.oauth.authorization.code.consumerKey}" consumerSecret="${config.oauth.authorization.code.consumerSecret}" authorizationUrl="${config.oauth.authorization.code.authorizationUrl}" accessTokenUrl="${config.oauth.authorization.code.accessTokenUrl}" scopes="https://graph.microsoft.com/.default" />
			<microsoftTeams:oauth-callback-config listenerConfig="auth" callbackPath="/callback" authorizePath="/authorize" externalCallbackUrl="http://localhost:8083/callback" />
		</microsoftTeams:oauth-authorization-code-connection>
	</microsoftTeams:authorization-code-config>
	<flow name="1.CREATE-TEAM" >
		<http:listener doc:name="Listener" config-ref="HTTP_Listener_config" path="/createTeam"/>
		<ee:transform doc:name="Transform Message">
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	"template@odata.bind": "https://graph.microsoft.com/v1.0/teamsTemplates('standard')",
	description: message.attributes.queryParams.description,
	displayName: message.attributes.queryParams.displayName,
	"members":[
      {
        "@odata.type":"#microsoft.graph.aadUserConversationMember",
        "user@odata.bind":"https://graph.microsoft.com/v1.0/users('" ++ message.attributes.queryParams.user as String ++ "')",
         "roles":[
            "owner"
         ]
      }
   ]
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<microsoftTeams:create-team doc:name="Create team" config-ref="OAuth_Client_Credentials_Config"/>
		<ee:transform doc:name="Transform Message">
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</flow>
	<flow name="2.GET-CREATED-TEAM">
		<http:listener doc:name="Listener" config-ref="HTTP_Listener_config" path="/getTeam" />
		<microsoftTeams:get-team doc:name="Get team" teamId="#[message.attributes.queryParams.team]" select="#[message.attributes.queryParams.select]" config-ref="OAuth_Client_Credentials_Config">
			<microsoftTeams:advanced-query-params >
			</microsoftTeams:advanced-query-params>
		</microsoftTeams:get-team>
		<ee:transform doc:name="Transform Message">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</flow>
	<flow name="3.LIST-TEAM-MEMBERS-FROM-THE-NEW-TEAM">
		<http:listener doc:name="Listener" path="/listTeamMembers" config-ref="HTTP_Listener_config"/>
		<microsoftTeams:list-team-members doc:name="List team members" teamId="#[message.attributes.queryParams.team]" config-ref="OAuth_Client_Credentials_Config"/>
		<ee:transform doc:name="Transform Message">
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</flow>
	<flow name="4.LIST-EXISTING-CHANNELS-FROM-THE-NEW-TEAM">
		<http:listener doc:name="Listener" config-ref="HTTP_Listener_config" path="/listChannels"/>
		<microsoftTeams:list-channels doc:name="List channels" doc:id="26db13de-57a8-42d2-ba41-a2f49d756cc4" teamId="#[message.attributes.queryParams.team]" config-ref="OAuth_Client_Credentials_Config">
			<microsoftTeams:advanced-query-params >
			</microsoftTeams:advanced-query-params>
		</microsoftTeams:list-channels>
		<ee:transform doc:name="Transform Message">
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
message]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</flow>
	<flow name="5.NEW-HIRE-TEAM-ONBOARDING">
		<http:listener doc:name="Listener" config-ref="HTTP_Listener_config" path="/newHireFlow"/>
		<set-variable value="#[message.attributes.queryParams.channelOwner]" doc:name="Set Variable" variableName="channelOwner"/>
		<set-variable value="#[message.attributes.queryParams.channelName]" doc:name="Set Variable" variableName="name"/>
		<set-variable value="#[message.attributes.queryParams.userToOnboard]" doc:name="Set Variable" variableName="userToOnboard"/>
		<set-variable value="#[message.attributes.queryParams.team]" doc:name="Set Variable" variableName="team"/>
		<microsoftTeams:add-team-member doc:name="Add team member" teamId="#[vars.team]" userId="#[vars.userToOnboard]" config-ref="OAuth_Client_Credentials_Config"/>
		<ee:transform doc:name="Transform Message" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
	description: "This channel will be used to onboard new hire " ++ vars.name as String,
	displayName: "Welcome " ++ vars.name as String ++ uuid()[0 to 5],
	membershipType: "private",
	"members":
     [
        {
           "@odata.type":"#microsoft.graph.aadUserConversationMember",
           "user@odata.bind":"https://graph.microsoft.com/v1.0/users('" ++ vars.channelOwner as String ++ "')",
           "roles":["owner"]
        }
     ]
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<microsoftTeams:create-channel doc:name="Create channel" teamId="#[vars.team]" config-ref="OAuth_Client_Credentials_Config"/>
		<set-variable value="#[payload.id]" doc:name="Set Variable" variableName="channel"/>
		<microsoftTeams:add-channel-member doc:name="Add channel member" channelId="#[vars.channel]" teamId="#[vars.team]" userId="#[vars.userToOnboard]" owner="true" config-ref="OAuth_Client_Credentials_Config"/>
		<ee:transform doc:name="Transform Message" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	body: {
		content: "Welcome to the team " ++ vars.name as String
	}
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<microsoftTeams:create-message doc:name="Create message" config-ref="OAuth_Authorization_Code_Config" teamId="#[vars.team]" channelId="#[vars.channel]"/>
		<ee:transform doc:name="Transform Message" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</flow>
	<flow name="6.DELETE-CHANNEL-FROM-TEAM">
		<http:listener doc:name="Listener" config-ref="HTTP_Listener_config" path="/deleteChannel" />
		<microsoftTeams:delete-channel doc:name="Delete channel" teamId="#[message.attributes.queryParams.team]" channelId="#[message.attributes.queryParams.channel]" config-ref="OAuth_Client_Credentials_Config"/>
	</flow>
	<flow name="7.REMOVE-TEAM-MEMBER">
		<http:listener doc:name="Listener" config-ref="HTTP_Listener_config" path="/removeTeamMember" />
		<microsoftTeams:remove-team-member doc:name="Remove team member" teamId="#[message.attributes.queryParams.team]" membershipId="#[message.attributes.queryParams.member]" config-ref="OAuth_Client_Credentials_Config"/>
	</flow>
</mule>
----
